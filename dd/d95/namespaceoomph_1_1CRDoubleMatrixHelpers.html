<!-- HTML header for doxygen 1.8.18-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MercuryDPM: oomph::CRDoubleMatrixHelpers Namespace Reference</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../MDPM.css" rel="stylesheet" type="text/css"/>
<link href="../../codeLabels.css" rel="stylesheet" type="text/css"/>
<link href="../../MDPM-fork-corner.css" rel="stylesheet" type="text/css"/>
<link href="../../MDPM-dropdown-version.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../MDPM-fragment-copy-button.js"></script>
<script type="text/javascript">
DoxygenAwesomeFragmentCopyButton.init()
</script>
<script type="text/javascript" src="../../MDPM-paragraph-link.js"></script>
<script type="text/javascript">
DoxygenAwesomeParagraphLink.init()
</script>
<script type="text/javascript" src="../../MDPM-interactive-toc.js"></script>
<script type="text/javascript">
DoxygenAwesomeInteractiveToc.init()
</script>
<script type="text/javascript" src="../../MDPM-darkmode-toggle.js"></script>
<script type="text/javascript">
DoxygenAwesomeDarkModeToggle.init()
</script>
</head>
<body>
  <div id="bitbucket-corner">
   <a href="https://bitbucket.org/mercurydpm/mercurydpm/src/master/" target="_blank" id="fork-corner" class="fork-corner fc-pos-tr fc-animate fc-theme-bitbucket"></a>
  </div>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../mercury-logo-chosen-light-slogan.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname"> <!--MercuryDPM--!>
   <!-- BEGIN version select -->
   <div class="dropdown" id="projectnumber">
    <button class="dropbtn">v1.0</button>
    <div class="dropdown-content">
    </div>
   </div>
   <script type="text/javascript" src="../../MDPM-dropdown-version.js"></script>
<!-- END version select -->
   <!--&#160;<span id="projectnumber">revision: v1.0</span>-->
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<script type="text/javascript" src="../../MDPM-fork-corner.js"></script>
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('dd/d95/namespaceoomph_1_1CRDoubleMatrixHelpers.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle">
<div class="title">oomph::CRDoubleMatrixHelpers Namespace Reference</div>  </div>
</div><!--header-->
<div class="contents">

<p>Namespace for helper functions for CRDoubleMatrices.  
<a href="../../dd/d95/namespaceoomph_1_1CRDoubleMatrixHelpers.html#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:ae3c10e59d5857457c7e34be8e9262035"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dd/d95/namespaceoomph_1_1CRDoubleMatrixHelpers.html#ae3c10e59d5857457c7e34be8e9262035">create_uniformly_distributed_matrix</a> (const <a class="el" href="../../d0/d1d/classunsigned.html">unsigned</a> &amp;nrow, const <a class="el" href="../../d0/d1d/classunsigned.html">unsigned</a> &amp;ncol, const <a class="el" href="../../de/d83/classoomph_1_1OomphCommunicator.html">OomphCommunicator</a> *const comm_pt, const <a class="el" href="../../d4/df6/classoomph_1_1Vector.html">Vector</a>&lt; <a class="el" href="../../df/de6/classdouble.html">double</a> &gt; &amp;values, const <a class="el" href="../../d4/df6/classoomph_1_1Vector.html">Vector</a>&lt; <a class="el" href="../../d9/d2a/level1__real__impl_8h.html#a4e8e1c1bb9d4e05fc671fc133ec9dc9b">int</a> &gt; &amp;column_indices, const <a class="el" href="../../d4/df6/classoomph_1_1Vector.html">Vector</a>&lt; <a class="el" href="../../d9/d2a/level1__real__impl_8h.html#a4e8e1c1bb9d4e05fc671fc133ec9dc9b">int</a> &gt; &amp;row_start, <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html">CRDoubleMatrix</a> &amp;matrix_out)</td></tr>
<tr class="separator:ae3c10e59d5857457c7e34be8e9262035"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab17222c9461096e3d5b8cf6250524644"><td class="memItemLeft" align="right" valign="top"><a class="el" href="../../df/de6/classdouble.html">double</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dd/d95/namespaceoomph_1_1CRDoubleMatrixHelpers.html#ab17222c9461096e3d5b8cf6250524644">inf_norm</a> (const <a class="el" href="../../d6/d13/classoomph_1_1DenseMatrix.html">DenseMatrix</a>&lt; <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html">CRDoubleMatrix</a> * &gt; &amp;matrix_pt)</td></tr>
<tr class="memdesc:ab17222c9461096e3d5b8cf6250524644"><td class="mdescLeft">&#160;</td><td class="mdescRight">Compute infinity (maximum) norm of sub blocks as if it was one matrix.  <a href="../../dd/d95/namespaceoomph_1_1CRDoubleMatrixHelpers.html#ab17222c9461096e3d5b8cf6250524644">More...</a><br /></td></tr>
<tr class="separator:ab17222c9461096e3d5b8cf6250524644"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a02b5962dbe2bbfb93f54b668100afffc"><td class="memItemLeft" align="right" valign="top"><a class="el" href="../../df/de6/classdouble.html">double</a>&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dd/d95/namespaceoomph_1_1CRDoubleMatrixHelpers.html#a02b5962dbe2bbfb93f54b668100afffc">gershgorin_eigenvalue_estimate</a> (const <a class="el" href="../../d6/d13/classoomph_1_1DenseMatrix.html">DenseMatrix</a>&lt; <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html">CRDoubleMatrix</a> * &gt; &amp;matrix_pt)</td></tr>
<tr class="separator:a02b5962dbe2bbfb93f54b668100afffc"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ab7e3ac344aa644292a143a3917a03e65"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dd/d95/namespaceoomph_1_1CRDoubleMatrixHelpers.html#ab7e3ac344aa644292a143a3917a03e65">concatenate</a> (const <a class="el" href="../../d6/d13/classoomph_1_1DenseMatrix.html">DenseMatrix</a>&lt; <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html">CRDoubleMatrix</a> * &gt; &amp;matrix_pt, <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html">CRDoubleMatrix</a> &amp;result_matrix)</td></tr>
<tr class="separator:ab7e3ac344aa644292a143a3917a03e65"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a996568831ca0db90f080560dd400b3d6"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dd/d95/namespaceoomph_1_1CRDoubleMatrixHelpers.html#a996568831ca0db90f080560dd400b3d6">concatenate_without_communication</a> (const <a class="el" href="../../d4/df6/classoomph_1_1Vector.html">Vector</a>&lt; <a class="el" href="../../de/dcb/classoomph_1_1LinearAlgebraDistribution.html">LinearAlgebraDistribution</a> * &gt; &amp;row_distribution_pt, const <a class="el" href="../../d4/df6/classoomph_1_1Vector.html">Vector</a>&lt; <a class="el" href="../../de/dcb/classoomph_1_1LinearAlgebraDistribution.html">LinearAlgebraDistribution</a> * &gt; &amp;col_distribution_pt, const <a class="el" href="../../d6/d13/classoomph_1_1DenseMatrix.html">DenseMatrix</a>&lt; <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html">CRDoubleMatrix</a> * &gt; &amp;matrix_pt, <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html">CRDoubleMatrix</a> &amp;result_matrix)</td></tr>
<tr class="separator:a996568831ca0db90f080560dd400b3d6"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ac04e094c973da752da4b76071ad09f44"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dd/d95/namespaceoomph_1_1CRDoubleMatrixHelpers.html#ac04e094c973da752da4b76071ad09f44">concatenate_without_communication</a> (const <a class="el" href="../../d4/df6/classoomph_1_1Vector.html">Vector</a>&lt; <a class="el" href="../../de/dcb/classoomph_1_1LinearAlgebraDistribution.html">LinearAlgebraDistribution</a> * &gt; &amp;block_distribution_pt, const <a class="el" href="../../d6/d13/classoomph_1_1DenseMatrix.html">DenseMatrix</a>&lt; <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html">CRDoubleMatrix</a> * &gt; &amp;matrix_pt, <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html">CRDoubleMatrix</a> &amp;result_matrix)</td></tr>
<tr class="separator:ac04e094c973da752da4b76071ad09f44"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:a157511f700993ab8bc014f9d0d44f4c7"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="../../dd/d95/namespaceoomph_1_1CRDoubleMatrixHelpers.html#a157511f700993ab8bc014f9d0d44f4c7">deep_copy</a> (const <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html">CRDoubleMatrix</a> *const in_matrix_pt, <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html">CRDoubleMatrix</a> &amp;out_matrix)</td></tr>
<tr class="memdesc:a157511f700993ab8bc014f9d0d44f4c7"><td class="mdescLeft">&#160;</td><td class="mdescRight">Create a deep copy of the matrix pointed to by in_matrix_pt.  <a href="../../dd/d95/namespaceoomph_1_1CRDoubleMatrixHelpers.html#a157511f700993ab8bc014f9d0d44f4c7">More...</a><br /></td></tr>
<tr class="separator:a157511f700993ab8bc014f9d0d44f4c7"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<div class="textblock"><p>Namespace for helper functions for CRDoubleMatrices. </p>
</div><h2 class="groupheader">Function Documentation</h2>
<a id="ab7e3ac344aa644292a143a3917a03e65"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab7e3ac344aa644292a143a3917a03e65">&#9670;&nbsp;</a></span>concatenate()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void oomph::CRDoubleMatrixHelpers::concatenate </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="../../d6/d13/classoomph_1_1DenseMatrix.html">DenseMatrix</a>&lt; <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html">CRDoubleMatrix</a> * &gt; &amp;&#160;</td>
          <td class="paramname"><em>matrix_pt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html">CRDoubleMatrix</a> &amp;&#160;</td>
          <td class="paramname"><em>result_matrix</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Concatenate CRDoubleMatrix matrices. The in matrices are concatenated such that the block structure of the in matrices are preserved in the result matrix. Communication between processors is required. If the block structure of the sub matrices does not need to be preserved, consider using CRDoubleMatrixHelpers::concatenate_without_communication(...).</p>
<p>The matrix manipulation functions CRDoubleMatrixHelpers::concatenate(...) and CRDoubleMatrixHelpers::concatenate_without_communication(...) are analogous to the Vector manipulation functions DoubleVectorHelpers::concatenate(...) and DoubleVectorHelpers::concatenate_without_communication(...). Please look at the DoubleVector functions for an illustration of the differences between concatenate(...) and concatenate_without_communication(...).</p>
<p>Distribution of the result matrix: If the result matrix does not have a distribution built, then it will be given a uniform row distribution. Otherwise we use the existing distribution. This gives the user the ability to define their own distribution, or save computing power if a distribution has been pre-built.</p>
<p>NOTE: ALL the matrices pointed to by matrix_pt has to be built. This is not the case with concatenate_without_communication(...) </p>
<div class="fragment"><div class="line"><a name="l04351"></a><span class="lineno"> 4351</span>&#160;    {</div>
<div class="line"><a name="l04352"></a><span class="lineno"> 4352</span>&#160;      <span class="comment">// The number of block rows and block columns.</span></div>
<div class="line"><a name="l04353"></a><span class="lineno"> 4353</span>&#160;      <span class="keywordtype">unsigned</span> matrix_nrow = matrix_pt.nrow();</div>
<div class="line"><a name="l04354"></a><span class="lineno"> 4354</span>&#160;      <span class="keywordtype">unsigned</span> matrix_ncol = matrix_pt.ncol();</div>
<div class="line"><a name="l04355"></a><span class="lineno"> 4355</span>&#160; </div>
<div class="line"><a name="l04356"></a><span class="lineno"> 4356</span>&#160;      <span class="comment">// PARANOID checks involving only the in matrices.</span></div>
<div class="line"><a name="l04357"></a><span class="lineno"> 4357</span>&#160;<span class="preprocessor">#ifdef PARANOID</span></div>
<div class="line"><a name="l04358"></a><span class="lineno"> 4358</span>&#160;      <span class="comment">// Are there matrices to concatenate?</span></div>
<div class="line"><a name="l04359"></a><span class="lineno"> 4359</span>&#160;      <span class="keywordflow">if</span> (matrix_nrow == 0)</div>
<div class="line"><a name="l04360"></a><span class="lineno"> 4360</span>&#160;      {</div>
<div class="line"><a name="l04361"></a><span class="lineno"> 4361</span>&#160;        std::ostringstream error_message;</div>
<div class="line"><a name="l04362"></a><span class="lineno"> 4362</span>&#160;        error_message &lt;&lt; <span class="stringliteral">&quot;There are no matrices to concatenate.\n&quot;</span>;</div>
<div class="line"><a name="l04363"></a><span class="lineno"> 4363</span>&#160;        <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l04364"></a><span class="lineno"> 4364</span>&#160;                            <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l04365"></a><span class="lineno"> 4365</span>&#160;                            <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l04366"></a><span class="lineno"> 4366</span>&#160;      }</div>
<div class="line"><a name="l04367"></a><span class="lineno"> 4367</span>&#160; </div>
<div class="line"><a name="l04368"></a><span class="lineno"> 4368</span>&#160;      <span class="comment">// Does this matrix need concatenating?</span></div>
<div class="line"><a name="l04369"></a><span class="lineno"> 4369</span>&#160;      <span class="keywordflow">if</span> ((matrix_nrow == 1) &amp;&amp; (matrix_ncol == 1))</div>
<div class="line"><a name="l04370"></a><span class="lineno"> 4370</span>&#160;      {</div>
<div class="line"><a name="l04371"></a><span class="lineno"> 4371</span>&#160;        std::ostringstream warning_message;</div>
<div class="line"><a name="l04372"></a><span class="lineno"> 4372</span>&#160;        warning_message &lt;&lt; <span class="stringliteral">&quot;There is only one matrix to concatenate...\n&quot;</span></div>
<div class="line"><a name="l04373"></a><span class="lineno"> 4373</span>&#160;                        &lt;&lt; <span class="stringliteral">&quot;This does not require concatenating...\n&quot;</span>;</div>
<div class="line"><a name="l04374"></a><span class="lineno"> 4374</span>&#160;        OomphLibWarning(warning_message.str(),</div>
<div class="line"><a name="l04375"></a><span class="lineno"> 4375</span>&#160;                        <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l04376"></a><span class="lineno"> 4376</span>&#160;                        <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l04377"></a><span class="lineno"> 4377</span>&#160;      }</div>
<div class="line"><a name="l04378"></a><span class="lineno"> 4378</span>&#160; </div>
<div class="line"><a name="l04379"></a><span class="lineno"> 4379</span>&#160;      <span class="comment">// Are all sub matrices built?</span></div>
<div class="line"><a name="l04380"></a><span class="lineno"> 4380</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 0; block_row_i &lt; matrix_nrow; block_row_i++)</div>
<div class="line"><a name="l04381"></a><span class="lineno"> 4381</span>&#160;      {</div>
<div class="line"><a name="l04382"></a><span class="lineno"> 4382</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 0; block_col_i &lt; matrix_ncol; block_col_i++)</div>
<div class="line"><a name="l04383"></a><span class="lineno"> 4383</span>&#160;        {</div>
<div class="line"><a name="l04384"></a><span class="lineno"> 4384</span>&#160;          <span class="keywordflow">if</span> (!(matrix_pt(block_row_i, block_col_i)-&gt;built()))</div>
<div class="line"><a name="l04385"></a><span class="lineno"> 4385</span>&#160;          {</div>
<div class="line"><a name="l04386"></a><span class="lineno"> 4386</span>&#160;            std::ostringstream error_message;</div>
<div class="line"><a name="l04387"></a><span class="lineno"> 4387</span>&#160;            error_message &lt;&lt; <span class="stringliteral">&quot;The sub matrix (&quot;</span> &lt;&lt; block_row_i &lt;&lt; <span class="stringliteral">&quot;,&quot;</span></div>
<div class="line"><a name="l04388"></a><span class="lineno"> 4388</span>&#160;                          &lt;&lt; block_col_i &lt;&lt; <span class="stringliteral">&quot;)\n&quot;</span></div>
<div class="line"><a name="l04389"></a><span class="lineno"> 4389</span>&#160;                          &lt;&lt; <span class="stringliteral">&quot;is not built. \n&quot;</span>;</div>
<div class="line"><a name="l04390"></a><span class="lineno"> 4390</span>&#160;            <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l04391"></a><span class="lineno"> 4391</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l04392"></a><span class="lineno"> 4392</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l04393"></a><span class="lineno"> 4393</span>&#160;          }</div>
<div class="line"><a name="l04394"></a><span class="lineno"> 4394</span>&#160;        }</div>
<div class="line"><a name="l04395"></a><span class="lineno"> 4395</span>&#160;      }</div>
<div class="line"><a name="l04396"></a><span class="lineno"> 4396</span>&#160; </div>
<div class="line"><a name="l04397"></a><span class="lineno"> 4397</span>&#160;      <span class="comment">// Do all dimensions of sub matrices &quot;make sense&quot;?</span></div>
<div class="line"><a name="l04398"></a><span class="lineno"> 4398</span>&#160;      <span class="comment">// Compare the number of rows of each block matrix in a block row.</span></div>
<div class="line"><a name="l04399"></a><span class="lineno"> 4399</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 0; block_row_i &lt; matrix_nrow; block_row_i++)</div>
<div class="line"><a name="l04400"></a><span class="lineno"> 4400</span>&#160;      {</div>
<div class="line"><a name="l04401"></a><span class="lineno"> 4401</span>&#160;        <span class="comment">// Use the first column to compare against the rest.</span></div>
<div class="line"><a name="l04402"></a><span class="lineno"> 4402</span>&#160;        <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> current_block_nrow = matrix_pt(block_row_i, 0)-&gt;nrow();</div>
<div class="line"><a name="l04403"></a><span class="lineno"> 4403</span>&#160; </div>
<div class="line"><a name="l04404"></a><span class="lineno"> 4404</span>&#160;        <span class="comment">// Compare against columns 1 to matrix_ncol - 1</span></div>
<div class="line"><a name="l04405"></a><span class="lineno"> 4405</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 1; block_col_i &lt; matrix_ncol; block_col_i++)</div>
<div class="line"><a name="l04406"></a><span class="lineno"> 4406</span>&#160;        {</div>
<div class="line"><a name="l04407"></a><span class="lineno"> 4407</span>&#160;          <span class="comment">// Get the nrow for this sub block.</span></div>
<div class="line"><a name="l04408"></a><span class="lineno"> 4408</span>&#160;          <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> subblock_nrow =</div>
<div class="line"><a name="l04409"></a><span class="lineno"> 4409</span>&#160;            matrix_pt(block_row_i, block_col_i)-&gt;nrow();</div>
<div class="line"><a name="l04410"></a><span class="lineno"> 4410</span>&#160; </div>
<div class="line"><a name="l04411"></a><span class="lineno"> 4411</span>&#160;          <span class="keywordflow">if</span> (current_block_nrow != subblock_nrow)</div>
<div class="line"><a name="l04412"></a><span class="lineno"> 4412</span>&#160;          {</div>
<div class="line"><a name="l04413"></a><span class="lineno"> 4413</span>&#160;            std::ostringstream error_message;</div>
<div class="line"><a name="l04414"></a><span class="lineno"> 4414</span>&#160;            error_message &lt;&lt; <span class="stringliteral">&quot;The sub matrix (&quot;</span> &lt;&lt; block_row_i &lt;&lt; <span class="stringliteral">&quot;,&quot;</span></div>
<div class="line"><a name="l04415"></a><span class="lineno"> 4415</span>&#160;                          &lt;&lt; block_col_i &lt;&lt; <span class="stringliteral">&quot;)\n&quot;</span></div>
<div class="line"><a name="l04416"></a><span class="lineno"> 4416</span>&#160;                          &lt;&lt; <span class="stringliteral">&quot;requires nrow = &quot;</span> &lt;&lt; current_block_nrow</div>
<div class="line"><a name="l04417"></a><span class="lineno"> 4417</span>&#160;                          &lt;&lt; <span class="stringliteral">&quot;, but has nrow = &quot;</span> &lt;&lt; subblock_nrow &lt;&lt; <span class="stringliteral">&quot;.\n&quot;</span>;</div>
<div class="line"><a name="l04418"></a><span class="lineno"> 4418</span>&#160;            <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l04419"></a><span class="lineno"> 4419</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l04420"></a><span class="lineno"> 4420</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l04421"></a><span class="lineno"> 4421</span>&#160;          }</div>
<div class="line"><a name="l04422"></a><span class="lineno"> 4422</span>&#160;        }</div>
<div class="line"><a name="l04423"></a><span class="lineno"> 4423</span>&#160;      }</div>
<div class="line"><a name="l04424"></a><span class="lineno"> 4424</span>&#160; </div>
<div class="line"><a name="l04425"></a><span class="lineno"> 4425</span>&#160;      <span class="comment">// Compare the number of columns of each block matrix in a block column.</span></div>
<div class="line"><a name="l04426"></a><span class="lineno"> 4426</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 0; block_col_i &lt; matrix_ncol; block_col_i++)</div>
<div class="line"><a name="l04427"></a><span class="lineno"> 4427</span>&#160;      {</div>
<div class="line"><a name="l04428"></a><span class="lineno"> 4428</span>&#160;        <span class="comment">// Use the first row to compare against the rest.</span></div>
<div class="line"><a name="l04429"></a><span class="lineno"> 4429</span>&#160;        <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> current_block_ncol = matrix_pt(0, block_col_i)-&gt;ncol();</div>
<div class="line"><a name="l04430"></a><span class="lineno"> 4430</span>&#160; </div>
<div class="line"><a name="l04431"></a><span class="lineno"> 4431</span>&#160;        <span class="comment">// Compare against rows 1 to matrix_nrow - 1</span></div>
<div class="line"><a name="l04432"></a><span class="lineno"> 4432</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 1; block_row_i &lt; matrix_nrow; block_row_i++)</div>
<div class="line"><a name="l04433"></a><span class="lineno"> 4433</span>&#160;        {</div>
<div class="line"><a name="l04434"></a><span class="lineno"> 4434</span>&#160;          <span class="comment">// Get the ncol for this sub block.</span></div>
<div class="line"><a name="l04435"></a><span class="lineno"> 4435</span>&#160;          <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> subblock_ncol =</div>
<div class="line"><a name="l04436"></a><span class="lineno"> 4436</span>&#160;            matrix_pt(block_row_i, block_col_i)-&gt;ncol();</div>
<div class="line"><a name="l04437"></a><span class="lineno"> 4437</span>&#160; </div>
<div class="line"><a name="l04438"></a><span class="lineno"> 4438</span>&#160;          <span class="keywordflow">if</span> (current_block_ncol != subblock_ncol)</div>
<div class="line"><a name="l04439"></a><span class="lineno"> 4439</span>&#160;          {</div>
<div class="line"><a name="l04440"></a><span class="lineno"> 4440</span>&#160;            std::ostringstream error_message;</div>
<div class="line"><a name="l04441"></a><span class="lineno"> 4441</span>&#160;            error_message &lt;&lt; <span class="stringliteral">&quot;The sub matrix (&quot;</span> &lt;&lt; block_row_i &lt;&lt; <span class="stringliteral">&quot;,&quot;</span></div>
<div class="line"><a name="l04442"></a><span class="lineno"> 4442</span>&#160;                          &lt;&lt; block_col_i &lt;&lt; <span class="stringliteral">&quot;)\n&quot;</span></div>
<div class="line"><a name="l04443"></a><span class="lineno"> 4443</span>&#160;                          &lt;&lt; <span class="stringliteral">&quot;requires ncol = &quot;</span> &lt;&lt; current_block_ncol</div>
<div class="line"><a name="l04444"></a><span class="lineno"> 4444</span>&#160;                          &lt;&lt; <span class="stringliteral">&quot;, but has ncol = &quot;</span> &lt;&lt; subblock_ncol &lt;&lt; <span class="stringliteral">&quot;.\n&quot;</span>;</div>
<div class="line"><a name="l04445"></a><span class="lineno"> 4445</span>&#160;            <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l04446"></a><span class="lineno"> 4446</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l04447"></a><span class="lineno"> 4447</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l04448"></a><span class="lineno"> 4448</span>&#160;          }</div>
<div class="line"><a name="l04449"></a><span class="lineno"> 4449</span>&#160;        }</div>
<div class="line"><a name="l04450"></a><span class="lineno"> 4450</span>&#160;      }</div>
<div class="line"><a name="l04451"></a><span class="lineno"> 4451</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04452"></a><span class="lineno"> 4452</span>&#160; </div>
<div class="line"><a name="l04453"></a><span class="lineno"> 4453</span>&#160;      <span class="comment">// The communicator pointer from block (0,0)</span></div>
<div class="line"><a name="l04454"></a><span class="lineno"> 4454</span>&#160;      <span class="keyword">const</span> OomphCommunicator* <span class="keyword">const</span> comm_pt =</div>
<div class="line"><a name="l04455"></a><span class="lineno"> 4455</span>&#160;        matrix_pt(0, 0)-&gt;distribution_pt()-&gt;communicator_pt();</div>
<div class="line"><a name="l04456"></a><span class="lineno"> 4456</span>&#160; </div>
<div class="line"><a name="l04457"></a><span class="lineno"> 4457</span>&#160;      <span class="comment">// Check if the block (0,0) is distributed or not.</span></div>
<div class="line"><a name="l04458"></a><span class="lineno"> 4458</span>&#160;      <span class="keywordtype">bool</span> distributed = matrix_pt(0, 0)-&gt;distributed();</div>
<div class="line"><a name="l04459"></a><span class="lineno"> 4459</span>&#160; </div>
<div class="line"><a name="l04460"></a><span class="lineno"> 4460</span>&#160;      <span class="comment">// If the result matrix does not have a distribution, we create a uniform</span></div>
<div class="line"><a name="l04461"></a><span class="lineno"> 4461</span>&#160;      <span class="comment">// distribution.</span></div>
<div class="line"><a name="l04462"></a><span class="lineno"> 4462</span>&#160;      <span class="keywordflow">if</span> (!result_matrix.distribution_pt()-&gt;built())</div>
<div class="line"><a name="l04463"></a><span class="lineno"> 4463</span>&#160;      {</div>
<div class="line"><a name="l04464"></a><span class="lineno"> 4464</span>&#160;        <span class="comment">// Sum of sub matrix nrow. We use the first column.</span></div>
<div class="line"><a name="l04465"></a><span class="lineno"> 4465</span>&#160;        <span class="keywordtype">unsigned</span> tmp_nrow = 0;</div>
<div class="line"><a name="l04466"></a><span class="lineno"> 4466</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 0; block_row_i &lt; matrix_nrow; block_row_i++)</div>
<div class="line"><a name="l04467"></a><span class="lineno"> 4467</span>&#160;        {</div>
<div class="line"><a name="l04468"></a><span class="lineno"> 4468</span>&#160;          tmp_nrow += matrix_pt(block_row_i, 0)-&gt;nrow();</div>
<div class="line"><a name="l04469"></a><span class="lineno"> 4469</span>&#160;        }</div>
<div class="line"><a name="l04470"></a><span class="lineno"> 4470</span>&#160; </div>
<div class="line"><a name="l04471"></a><span class="lineno"> 4471</span>&#160;        LinearAlgebraDistribution tmp_distribution(</div>
<div class="line"><a name="l04472"></a><span class="lineno"> 4472</span>&#160;          comm_pt, tmp_nrow, distributed);</div>
<div class="line"><a name="l04473"></a><span class="lineno"> 4473</span>&#160; </div>
<div class="line"><a name="l04474"></a><span class="lineno"> 4474</span>&#160;        result_matrix.build(&amp;tmp_distribution);</div>
<div class="line"><a name="l04475"></a><span class="lineno"> 4475</span>&#160;      }</div>
<div class="line"><a name="l04476"></a><span class="lineno"> 4476</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l04477"></a><span class="lineno"> 4477</span>&#160;      <span class="comment">// A distribution is supplied for the result matrix.</span></div>
<div class="line"><a name="l04478"></a><span class="lineno"> 4478</span>&#160;      {</div>
<div class="line"><a name="l04479"></a><span class="lineno"> 4479</span>&#160;<span class="preprocessor">#ifdef PARANOID</span></div>
<div class="line"><a name="l04480"></a><span class="lineno"> 4480</span>&#160;        <span class="comment">// Check if the sum of the nrow from the sub matrices is the same as the</span></div>
<div class="line"><a name="l04481"></a><span class="lineno"> 4481</span>&#160;        <span class="comment">// the nrow from the result matrix.</span></div>
<div class="line"><a name="l04482"></a><span class="lineno"> 4482</span>&#160; </div>
<div class="line"><a name="l04483"></a><span class="lineno"> 4483</span>&#160;        <span class="comment">// Sum of sub matrix nrow. We use the first column.</span></div>
<div class="line"><a name="l04484"></a><span class="lineno"> 4484</span>&#160;        <span class="keywordtype">unsigned</span> tmp_nrow = 0;</div>
<div class="line"><a name="l04485"></a><span class="lineno"> 4485</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 0; block_row_i &lt; matrix_nrow; block_row_i++)</div>
<div class="line"><a name="l04486"></a><span class="lineno"> 4486</span>&#160;        {</div>
<div class="line"><a name="l04487"></a><span class="lineno"> 4487</span>&#160;          tmp_nrow += matrix_pt(block_row_i, 0)-&gt;nrow();</div>
<div class="line"><a name="l04488"></a><span class="lineno"> 4488</span>&#160;        }</div>
<div class="line"><a name="l04489"></a><span class="lineno"> 4489</span>&#160; </div>
<div class="line"><a name="l04490"></a><span class="lineno"> 4490</span>&#160;        <span class="keywordflow">if</span> (tmp_nrow != result_matrix.nrow())</div>
<div class="line"><a name="l04491"></a><span class="lineno"> 4491</span>&#160;        {</div>
<div class="line"><a name="l04492"></a><span class="lineno"> 4492</span>&#160;          std::ostringstream error_message;</div>
<div class="line"><a name="l04493"></a><span class="lineno"> 4493</span>&#160;          error_message &lt;&lt; <span class="stringliteral">&quot;The total number of rows from the matrices to\n&quot;</span></div>
<div class="line"><a name="l04494"></a><span class="lineno"> 4494</span>&#160;                        &lt;&lt; <span class="stringliteral">&quot;concatenate does not match the nrow from the\n&quot;</span></div>
<div class="line"><a name="l04495"></a><span class="lineno"> 4495</span>&#160;                        &lt;&lt; <span class="stringliteral">&quot;result matrix\n&quot;</span>;</div>
<div class="line"><a name="l04496"></a><span class="lineno"> 4496</span>&#160;          <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l04497"></a><span class="lineno"> 4497</span>&#160;                              <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l04498"></a><span class="lineno"> 4498</span>&#160;                              <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l04499"></a><span class="lineno"> 4499</span>&#160;        }</div>
<div class="line"><a name="l04500"></a><span class="lineno"> 4500</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04501"></a><span class="lineno"> 4501</span>&#160;      }</div>
<div class="line"><a name="l04502"></a><span class="lineno"> 4502</span>&#160; </div>
<div class="line"><a name="l04503"></a><span class="lineno"> 4503</span>&#160;<span class="preprocessor">#ifdef PARANOID</span></div>
<div class="line"><a name="l04504"></a><span class="lineno"> 4504</span>&#160; </div>
<div class="line"><a name="l04505"></a><span class="lineno"> 4505</span>&#160;      <span class="comment">// Are all the communicators the same?</span></div>
<div class="line"><a name="l04506"></a><span class="lineno"> 4506</span>&#160;      <span class="comment">// Compare the communicator for sub matrices (against the result matrix).</span></div>
<div class="line"><a name="l04507"></a><span class="lineno"> 4507</span>&#160;      {</div>
<div class="line"><a name="l04508"></a><span class="lineno"> 4508</span>&#160;        <span class="keyword">const</span> OomphCommunicator communicator =</div>
<div class="line"><a name="l04509"></a><span class="lineno"> 4509</span>&#160;          *(result_matrix.distribution_pt()-&gt;communicator_pt());</div>
<div class="line"><a name="l04510"></a><span class="lineno"> 4510</span>&#160; </div>
<div class="line"><a name="l04511"></a><span class="lineno"> 4511</span>&#160;        <span class="comment">// Are all communicator pointers the same?</span></div>
<div class="line"><a name="l04512"></a><span class="lineno"> 4512</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 0; block_row_i &lt; matrix_nrow; block_row_i++)</div>
<div class="line"><a name="l04513"></a><span class="lineno"> 4513</span>&#160;        {</div>
<div class="line"><a name="l04514"></a><span class="lineno"> 4514</span>&#160;          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 0; block_col_i &lt; matrix_ncol;</div>
<div class="line"><a name="l04515"></a><span class="lineno"> 4515</span>&#160;               block_col_i++)</div>
<div class="line"><a name="l04516"></a><span class="lineno"> 4516</span>&#160;          {</div>
<div class="line"><a name="l04517"></a><span class="lineno"> 4517</span>&#160;            <span class="keyword">const</span> OomphCommunicator another_communicator =</div>
<div class="line"><a name="l04518"></a><span class="lineno"> 4518</span>&#160;              *(matrix_pt(block_row_i, block_col_i)</div>
<div class="line"><a name="l04519"></a><span class="lineno"> 4519</span>&#160;                  -&gt;distribution_pt()</div>
<div class="line"><a name="l04520"></a><span class="lineno"> 4520</span>&#160;                  -&gt;communicator_pt());</div>
<div class="line"><a name="l04521"></a><span class="lineno"> 4521</span>&#160; </div>
<div class="line"><a name="l04522"></a><span class="lineno"> 4522</span>&#160;            <span class="keywordflow">if</span> (!(communicator == another_communicator))</div>
<div class="line"><a name="l04523"></a><span class="lineno"> 4523</span>&#160;            {</div>
<div class="line"><a name="l04524"></a><span class="lineno"> 4524</span>&#160;              std::ostringstream error_message;</div>
<div class="line"><a name="l04525"></a><span class="lineno"> 4525</span>&#160;              error_message &lt;&lt; <span class="stringliteral">&quot;The OomphCommunicator of the sub matrix (&quot;</span></div>
<div class="line"><a name="l04526"></a><span class="lineno"> 4526</span>&#160;                            &lt;&lt; block_row_i &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt; block_col_i &lt;&lt; <span class="stringliteral">&quot;)\n&quot;</span></div>
<div class="line"><a name="l04527"></a><span class="lineno"> 4527</span>&#160;                            &lt;&lt; <span class="stringliteral">&quot;does not have the same communicator as the &quot;</span></div>
<div class="line"><a name="l04528"></a><span class="lineno"> 4528</span>&#160;                               <span class="stringliteral">&quot;result matrix. \n&quot;</span>;</div>
<div class="line"><a name="l04529"></a><span class="lineno"> 4529</span>&#160;              <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l04530"></a><span class="lineno"> 4530</span>&#160;                                  <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l04531"></a><span class="lineno"> 4531</span>&#160;                                  <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l04532"></a><span class="lineno"> 4532</span>&#160;            }</div>
<div class="line"><a name="l04533"></a><span class="lineno"> 4533</span>&#160;          }</div>
<div class="line"><a name="l04534"></a><span class="lineno"> 4534</span>&#160;        }</div>
<div class="line"><a name="l04535"></a><span class="lineno"> 4535</span>&#160;      }</div>
<div class="line"><a name="l04536"></a><span class="lineno"> 4536</span>&#160; </div>
<div class="line"><a name="l04537"></a><span class="lineno"> 4537</span>&#160;      <span class="comment">// Are all the distributed boolean the same? This only applies if we have</span></div>
<div class="line"><a name="l04538"></a><span class="lineno"> 4538</span>&#160;      <span class="comment">// more than one processor. If there is only one processor, then it does</span></div>
<div class="line"><a name="l04539"></a><span class="lineno"> 4539</span>&#160;      <span class="comment">// not matter if it is distributed or not - they are conceptually the</span></div>
<div class="line"><a name="l04540"></a><span class="lineno"> 4540</span>&#160;      <span class="comment">// same.</span></div>
<div class="line"><a name="l04541"></a><span class="lineno"> 4541</span>&#160;      <span class="keywordflow">if</span> (comm_pt-&gt;nproc() != 1)</div>
<div class="line"><a name="l04542"></a><span class="lineno"> 4542</span>&#160;      {</div>
<div class="line"><a name="l04543"></a><span class="lineno"> 4543</span>&#160;        <span class="comment">// Compare distributed for sub matrices (against the result matrix).</span></div>
<div class="line"><a name="l04544"></a><span class="lineno"> 4544</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">bool</span> res_distributed = result_matrix.distributed();</div>
<div class="line"><a name="l04545"></a><span class="lineno"> 4545</span>&#160; </div>
<div class="line"><a name="l04546"></a><span class="lineno"> 4546</span>&#160;        <span class="comment">// Loop over all sub blocks.</span></div>
<div class="line"><a name="l04547"></a><span class="lineno"> 4547</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 0; block_row_i &lt; matrix_nrow; block_row_i++)</div>
<div class="line"><a name="l04548"></a><span class="lineno"> 4548</span>&#160;        {</div>
<div class="line"><a name="l04549"></a><span class="lineno"> 4549</span>&#160;          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 0; block_col_i &lt; matrix_ncol;</div>
<div class="line"><a name="l04550"></a><span class="lineno"> 4550</span>&#160;               block_col_i++)</div>
<div class="line"><a name="l04551"></a><span class="lineno"> 4551</span>&#160;          {</div>
<div class="line"><a name="l04552"></a><span class="lineno"> 4552</span>&#160;            <span class="keyword">const</span> <span class="keywordtype">bool</span> another_distributed =</div>
<div class="line"><a name="l04553"></a><span class="lineno"> 4553</span>&#160;              matrix_pt(block_row_i, block_col_i)-&gt;distributed();</div>
<div class="line"><a name="l04554"></a><span class="lineno"> 4554</span>&#160; </div>
<div class="line"><a name="l04555"></a><span class="lineno"> 4555</span>&#160;            <span class="keywordflow">if</span> (res_distributed != another_distributed)</div>
<div class="line"><a name="l04556"></a><span class="lineno"> 4556</span>&#160;            {</div>
<div class="line"><a name="l04557"></a><span class="lineno"> 4557</span>&#160;              std::ostringstream error_message;</div>
<div class="line"><a name="l04558"></a><span class="lineno"> 4558</span>&#160;              error_message &lt;&lt; <span class="stringliteral">&quot;The distributed boolean of the sub matrix (&quot;</span></div>
<div class="line"><a name="l04559"></a><span class="lineno"> 4559</span>&#160;                            &lt;&lt; block_row_i &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt; block_col_i &lt;&lt; <span class="stringliteral">&quot;)\n&quot;</span></div>
<div class="line"><a name="l04560"></a><span class="lineno"> 4560</span>&#160;                            &lt;&lt; <span class="stringliteral">&quot;is not the same as the result matrix. \n&quot;</span>;</div>
<div class="line"><a name="l04561"></a><span class="lineno"> 4561</span>&#160;              <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l04562"></a><span class="lineno"> 4562</span>&#160;                                  <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l04563"></a><span class="lineno"> 4563</span>&#160;                                  <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l04564"></a><span class="lineno"> 4564</span>&#160;            }</div>
<div class="line"><a name="l04565"></a><span class="lineno"> 4565</span>&#160;          }</div>
<div class="line"><a name="l04566"></a><span class="lineno"> 4566</span>&#160;        }</div>
<div class="line"><a name="l04567"></a><span class="lineno"> 4567</span>&#160;      }</div>
<div class="line"><a name="l04568"></a><span class="lineno"> 4568</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04569"></a><span class="lineno"> 4569</span>&#160; </div>
<div class="line"><a name="l04570"></a><span class="lineno"> 4570</span>&#160; </div>
<div class="line"><a name="l04571"></a><span class="lineno"> 4571</span>&#160;      <span class="comment">// Get the number of columns up to each block for offset</span></div>
<div class="line"><a name="l04572"></a><span class="lineno"> 4572</span>&#160;      <span class="comment">// in calculating the result column indices.</span></div>
<div class="line"><a name="l04573"></a><span class="lineno"> 4573</span>&#160;      <span class="comment">// Since the number of columns in each block column is the same,</span></div>
<div class="line"><a name="l04574"></a><span class="lineno"> 4574</span>&#160;      <span class="comment">// we only loop through the first block row (row zero).</span></div>
<div class="line"><a name="l04575"></a><span class="lineno"> 4575</span>&#160;      Vector&lt;unsigned long&gt; sum_of_ncol_up_to_block(matrix_ncol);</div>
<div class="line"><a name="l04576"></a><span class="lineno"> 4576</span>&#160; </div>
<div class="line"><a name="l04577"></a><span class="lineno"> 4577</span>&#160;      <span class="comment">// Also compute the total number of columns to build the resulting matrix.</span></div>
<div class="line"><a name="l04578"></a><span class="lineno"> 4578</span>&#160;      <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> res_ncol = 0;</div>
<div class="line"><a name="l04579"></a><span class="lineno"> 4579</span>&#160; </div>
<div class="line"><a name="l04580"></a><span class="lineno"> 4580</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 0; block_col_i &lt; matrix_ncol; block_col_i++)</div>
<div class="line"><a name="l04581"></a><span class="lineno"> 4581</span>&#160;      {</div>
<div class="line"><a name="l04582"></a><span class="lineno"> 4582</span>&#160;        sum_of_ncol_up_to_block[block_col_i] = res_ncol;</div>
<div class="line"><a name="l04583"></a><span class="lineno"> 4583</span>&#160;        res_ncol += matrix_pt(0, block_col_i)-&gt;ncol();</div>
<div class="line"><a name="l04584"></a><span class="lineno"> 4584</span>&#160;      }</div>
<div class="line"><a name="l04585"></a><span class="lineno"> 4585</span>&#160; </div>
<div class="line"><a name="l04586"></a><span class="lineno"> 4586</span>&#160;      <span class="comment">// We begin the process of extracting and ordering the values,</span></div>
<div class="line"><a name="l04587"></a><span class="lineno"> 4587</span>&#160;      <span class="comment">// column_indices and row_start of all the sub blocks.</span></div>
<div class="line"><a name="l04588"></a><span class="lineno"> 4588</span>&#160;      <span class="keywordflow">if</span> ((comm_pt-&gt;nproc() == 1) || !distributed)</div>
<div class="line"><a name="l04589"></a><span class="lineno"> 4589</span>&#160;      <span class="comment">// Serial version of the code.</span></div>
<div class="line"><a name="l04590"></a><span class="lineno"> 4590</span>&#160;      {</div>
<div class="line"><a name="l04591"></a><span class="lineno"> 4591</span>&#160;        <span class="comment">// Get the total number of non zero entries so we can reserve storage</span></div>
<div class="line"><a name="l04592"></a><span class="lineno"> 4592</span>&#160;        <span class="comment">// for the values and column_indices vectors.</span></div>
<div class="line"><a name="l04593"></a><span class="lineno"> 4593</span>&#160;        <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> res_nnz = 0;</div>
<div class="line"><a name="l04594"></a><span class="lineno"> 4594</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 0; block_row_i &lt; matrix_nrow; block_row_i++)</div>
<div class="line"><a name="l04595"></a><span class="lineno"> 4595</span>&#160;        {</div>
<div class="line"><a name="l04596"></a><span class="lineno"> 4596</span>&#160;          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 0; block_col_i &lt; matrix_ncol;</div>
<div class="line"><a name="l04597"></a><span class="lineno"> 4597</span>&#160;               block_col_i++)</div>
<div class="line"><a name="l04598"></a><span class="lineno"> 4598</span>&#160;          {</div>
<div class="line"><a name="l04599"></a><span class="lineno"> 4599</span>&#160;            res_nnz += matrix_pt(block_row_i, block_col_i)-&gt;nnz();</div>
<div class="line"><a name="l04600"></a><span class="lineno"> 4600</span>&#160;          }</div>
<div class="line"><a name="l04601"></a><span class="lineno"> 4601</span>&#160;        }</div>
<div class="line"><a name="l04602"></a><span class="lineno"> 4602</span>&#160; </div>
<div class="line"><a name="l04603"></a><span class="lineno"> 4603</span>&#160;        <span class="comment">// Declare the vectors required to build a CRDoubleMatrix</span></div>
<div class="line"><a name="l04604"></a><span class="lineno"> 4604</span>&#160;        Vector&lt;double&gt; res_values;</div>
<div class="line"><a name="l04605"></a><span class="lineno"> 4605</span>&#160;        Vector&lt;int&gt; res_column_indices;</div>
<div class="line"><a name="l04606"></a><span class="lineno"> 4606</span>&#160;        Vector&lt;int&gt; res_row_start;</div>
<div class="line"><a name="l04607"></a><span class="lineno"> 4607</span>&#160; </div>
<div class="line"><a name="l04608"></a><span class="lineno"> 4608</span>&#160;        <span class="comment">// Reserve space for the vectors.</span></div>
<div class="line"><a name="l04609"></a><span class="lineno"> 4609</span>&#160;        res_values.reserve(res_nnz);</div>
<div class="line"><a name="l04610"></a><span class="lineno"> 4610</span>&#160;        res_column_indices.reserve(res_nnz);</div>
<div class="line"><a name="l04611"></a><span class="lineno"> 4611</span>&#160;        res_row_start.reserve(result_matrix.nrow() + 1);</div>
<div class="line"><a name="l04612"></a><span class="lineno"> 4612</span>&#160; </div>
<div class="line"><a name="l04613"></a><span class="lineno"> 4613</span>&#160;        <span class="comment">// Now we fill in the data.</span></div>
<div class="line"><a name="l04614"></a><span class="lineno"> 4614</span>&#160; </div>
<div class="line"><a name="l04615"></a><span class="lineno"> 4615</span>&#160;        <span class="comment">// Running sum of nnz per row.</span></div>
<div class="line"><a name="l04616"></a><span class="lineno"> 4616</span>&#160;        <span class="keywordtype">int</span> nnz_running_sum = 0;</div>
<div class="line"><a name="l04617"></a><span class="lineno"> 4617</span>&#160; </div>
<div class="line"><a name="l04618"></a><span class="lineno"> 4618</span>&#160;        <span class="comment">// Loop through the block rows.</span></div>
<div class="line"><a name="l04619"></a><span class="lineno"> 4619</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 0; block_row_i &lt; matrix_nrow; block_row_i++)</div>
<div class="line"><a name="l04620"></a><span class="lineno"> 4620</span>&#160;        {</div>
<div class="line"><a name="l04621"></a><span class="lineno"> 4621</span>&#160;          <span class="comment">// Get the number of rows in this block row, from the first block.</span></div>
<div class="line"><a name="l04622"></a><span class="lineno"> 4622</span>&#160;          <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> block_row_nrow = matrix_pt(block_row_i, 0)-&gt;nrow();</div>
<div class="line"><a name="l04623"></a><span class="lineno"> 4623</span>&#160; </div>
<div class="line"><a name="l04624"></a><span class="lineno"> 4624</span>&#160;          <span class="comment">// Loop through the number of rows in this block row</span></div>
<div class="line"><a name="l04625"></a><span class="lineno"> 4625</span>&#160;          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> row_i = 0; row_i &lt; block_row_nrow; row_i++)</div>
<div class="line"><a name="l04626"></a><span class="lineno"> 4626</span>&#160;          {</div>
<div class="line"><a name="l04627"></a><span class="lineno"> 4627</span>&#160;            <span class="comment">// The row start is the nnz at the start of the row.</span></div>
<div class="line"><a name="l04628"></a><span class="lineno"> 4628</span>&#160;            res_row_start.push_back(nnz_running_sum);</div>
<div class="line"><a name="l04629"></a><span class="lineno"> 4629</span>&#160; </div>
<div class="line"><a name="l04630"></a><span class="lineno"> 4630</span>&#160;            <span class="comment">// Loop through the block columns</span></div>
<div class="line"><a name="l04631"></a><span class="lineno"> 4631</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 0; block_col_i &lt; matrix_ncol;</div>
<div class="line"><a name="l04632"></a><span class="lineno"> 4632</span>&#160;                 block_col_i++)</div>
<div class="line"><a name="l04633"></a><span class="lineno"> 4633</span>&#160;            {</div>
<div class="line"><a name="l04634"></a><span class="lineno"> 4634</span>&#160;              <span class="comment">// Get the current block.</span></div>
<div class="line"><a name="l04635"></a><span class="lineno"> 4635</span>&#160;              CRDoubleMatrix* current_block_pt =</div>
<div class="line"><a name="l04636"></a><span class="lineno"> 4636</span>&#160;                matrix_pt(block_row_i, block_col_i);</div>
<div class="line"><a name="l04637"></a><span class="lineno"> 4637</span>&#160; </div>
<div class="line"><a name="l04638"></a><span class="lineno"> 4638</span>&#160;              <span class="comment">// Get the values, column_indices and row_start for this block.</span></div>
<div class="line"><a name="l04639"></a><span class="lineno"> 4639</span>&#160;              <span class="keywordtype">double</span>* current_block_values = current_block_pt-&gt;value();</div>
<div class="line"><a name="l04640"></a><span class="lineno"> 4640</span>&#160;              <span class="keywordtype">int</span>* current_block_column_indices =</div>
<div class="line"><a name="l04641"></a><span class="lineno"> 4641</span>&#160;                current_block_pt-&gt;column_index();</div>
<div class="line"><a name="l04642"></a><span class="lineno"> 4642</span>&#160;              <span class="keywordtype">int</span>* current_block_row_start = current_block_pt-&gt;row_start();</div>
<div class="line"><a name="l04643"></a><span class="lineno"> 4643</span>&#160; </div>
<div class="line"><a name="l04644"></a><span class="lineno"> 4644</span>&#160;              <span class="keywordflow">for</span> (<span class="keywordtype">int</span> val_i = current_block_row_start[row_i];</div>
<div class="line"><a name="l04645"></a><span class="lineno"> 4645</span>&#160;                   val_i &lt; current_block_row_start[row_i + 1];</div>
<div class="line"><a name="l04646"></a><span class="lineno"> 4646</span>&#160;                   val_i++)</div>
<div class="line"><a name="l04647"></a><span class="lineno"> 4647</span>&#160;              {</div>
<div class="line"><a name="l04648"></a><span class="lineno"> 4648</span>&#160;                res_values.push_back(current_block_values[val_i]);</div>
<div class="line"><a name="l04649"></a><span class="lineno"> 4649</span>&#160;                res_column_indices.push_back(</div>
<div class="line"><a name="l04650"></a><span class="lineno"> 4650</span>&#160;                  current_block_column_indices[val_i] +</div>
<div class="line"><a name="l04651"></a><span class="lineno"> 4651</span>&#160;                  sum_of_ncol_up_to_block[block_col_i]);</div>
<div class="line"><a name="l04652"></a><span class="lineno"> 4652</span>&#160;              }</div>
<div class="line"><a name="l04653"></a><span class="lineno"> 4653</span>&#160; </div>
<div class="line"><a name="l04654"></a><span class="lineno"> 4654</span>&#160;              <span class="comment">// Update the running sum of nnz per row</span></div>
<div class="line"><a name="l04655"></a><span class="lineno"> 4655</span>&#160;              nnz_running_sum += current_block_row_start[row_i + 1] -</div>
<div class="line"><a name="l04656"></a><span class="lineno"> 4656</span>&#160;                                 current_block_row_start[row_i];</div>
<div class="line"><a name="l04657"></a><span class="lineno"> 4657</span>&#160;            } <span class="comment">// for block cols</span></div>
<div class="line"><a name="l04658"></a><span class="lineno"> 4658</span>&#160;          } <span class="comment">// for rows</span></div>
<div class="line"><a name="l04659"></a><span class="lineno"> 4659</span>&#160;        } <span class="comment">// for block rows</span></div>
<div class="line"><a name="l04660"></a><span class="lineno"> 4660</span>&#160; </div>
<div class="line"><a name="l04661"></a><span class="lineno"> 4661</span>&#160;        <span class="comment">// Fill in the last row start</span></div>
<div class="line"><a name="l04662"></a><span class="lineno"> 4662</span>&#160;        res_row_start.push_back(res_nnz);</div>
<div class="line"><a name="l04663"></a><span class="lineno"> 4663</span>&#160; </div>
<div class="line"><a name="l04664"></a><span class="lineno"> 4664</span>&#160;        <span class="comment">// Build the matrix</span></div>
<div class="line"><a name="l04665"></a><span class="lineno"> 4665</span>&#160;        result_matrix.build(</div>
<div class="line"><a name="l04666"></a><span class="lineno"> 4666</span>&#160;          res_ncol, res_values, res_column_indices, res_row_start);</div>
<div class="line"><a name="l04667"></a><span class="lineno"> 4667</span>&#160;      }</div>
<div class="line"><a name="l04668"></a><span class="lineno"> 4668</span>&#160;      <span class="comment">// Otherwise we are dealing with a distributed matrix.</span></div>
<div class="line"><a name="l04669"></a><span class="lineno"> 4669</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l04670"></a><span class="lineno"> 4670</span>&#160;      {</div>
<div class="line"><a name="l04671"></a><span class="lineno"> 4671</span>&#160;<span class="preprocessor">#ifdef OOMPH_HAS_MPI</span></div>
<div class="line"><a name="l04672"></a><span class="lineno"> 4672</span>&#160; </div>
<div class="line"><a name="l04673"></a><span class="lineno"> 4673</span>&#160;        <span class="comment">// Flag to enable timing. This is for debugging</span></div>
<div class="line"><a name="l04674"></a><span class="lineno"> 4674</span>&#160;        <span class="comment">// and/or testing purposes only.</span></div>
<div class="line"><a name="l04675"></a><span class="lineno"> 4675</span>&#160;        <span class="keywordtype">bool</span> enable_timing = <span class="keyword">false</span>;</div>
<div class="line"><a name="l04676"></a><span class="lineno"> 4676</span>&#160; </div>
<div class="line"><a name="l04677"></a><span class="lineno"> 4677</span>&#160;        <span class="comment">// Get the number of processors</span></div>
<div class="line"><a name="l04678"></a><span class="lineno"> 4678</span>&#160;        <span class="keywordtype">unsigned</span> nproc = comm_pt-&gt;nproc();</div>
<div class="line"><a name="l04679"></a><span class="lineno"> 4679</span>&#160; </div>
<div class="line"><a name="l04680"></a><span class="lineno"> 4680</span>&#160;        <span class="comment">// My rank</span></div>
<div class="line"><a name="l04681"></a><span class="lineno"> 4681</span>&#160;        <span class="keywordtype">unsigned</span> my_rank = comm_pt-&gt;my_rank();</div>
<div class="line"><a name="l04682"></a><span class="lineno"> 4682</span>&#160; </div>
<div class="line"><a name="l04683"></a><span class="lineno"> 4683</span>&#160;        <span class="comment">// Storage for the data (per processor) to send.</span></div>
<div class="line"><a name="l04684"></a><span class="lineno"> 4684</span>&#160;        Vector&lt;Vector&lt;unsigned&gt;&gt; column_indices_to_send(nproc);</div>
<div class="line"><a name="l04685"></a><span class="lineno"> 4685</span>&#160;        Vector&lt;Vector&lt;double&gt;&gt; values_to_send(nproc);</div>
<div class="line"><a name="l04686"></a><span class="lineno"> 4686</span>&#160; </div>
<div class="line"><a name="l04687"></a><span class="lineno"> 4687</span>&#160;        <span class="comment">// The sum of the nrow for the sub blocks (so far). This is used as an</span></div>
<div class="line"><a name="l04688"></a><span class="lineno"> 4688</span>&#160;        <span class="comment">// offset to calculate the global equation number in the result matrix.</span></div>
<div class="line"><a name="l04689"></a><span class="lineno"> 4689</span>&#160;        <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> sum_of_block_nrow = 0;</div>
<div class="line"><a name="l04690"></a><span class="lineno"> 4690</span>&#160; </div>
<div class="line"><a name="l04691"></a><span class="lineno"> 4691</span>&#160;        <span class="keywordtype">double</span> t_prep_data_start;</div>
<div class="line"><a name="l04692"></a><span class="lineno"> 4692</span>&#160;        <span class="keywordflow">if</span> (enable_timing)</div>
<div class="line"><a name="l04693"></a><span class="lineno"> 4693</span>&#160;        {</div>
<div class="line"><a name="l04694"></a><span class="lineno"> 4694</span>&#160;          t_prep_data_start = <a class="code" href="../../d9/dd8/oomph__metis__from__parmetis__3_81_81_2struct_8h.html#aae821c36bb7e6918e1414484f939c3d4">TimingHelpers::timer</a>();</div>
<div class="line"><a name="l04695"></a><span class="lineno"> 4695</span>&#160;        }</div>
<div class="line"><a name="l04696"></a><span class="lineno"> 4696</span>&#160; </div>
<div class="line"><a name="l04697"></a><span class="lineno"> 4697</span>&#160;        <span class="comment">// Get the pointer to the result distribution, for convenience...</span></div>
<div class="line"><a name="l04698"></a><span class="lineno"> 4698</span>&#160;        LinearAlgebraDistribution* res_distribution_pt =</div>
<div class="line"><a name="l04699"></a><span class="lineno"> 4699</span>&#160;          result_matrix.distribution_pt();</div>
<div class="line"><a name="l04700"></a><span class="lineno"> 4700</span>&#160; </div>
<div class="line"><a name="l04701"></a><span class="lineno"> 4701</span>&#160;        <span class="comment">// loop over the sub blocks to calculate the global_eqn, get the values</span></div>
<div class="line"><a name="l04702"></a><span class="lineno"> 4702</span>&#160;        <span class="comment">// and column indices.</span></div>
<div class="line"><a name="l04703"></a><span class="lineno"> 4703</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 0; block_row_i &lt; matrix_nrow; block_row_i++)</div>
<div class="line"><a name="l04704"></a><span class="lineno"> 4704</span>&#160;        {</div>
<div class="line"><a name="l04705"></a><span class="lineno"> 4705</span>&#160;          <span class="comment">// Get the number of local rows in this block_row from the first</span></div>
<div class="line"><a name="l04706"></a><span class="lineno"> 4706</span>&#160;          <span class="comment">// block.</span></div>
<div class="line"><a name="l04707"></a><span class="lineno"> 4707</span>&#160;          <span class="keywordtype">unsigned</span> current_block_nrow_local =</div>
<div class="line"><a name="l04708"></a><span class="lineno"> 4708</span>&#160;            matrix_pt(block_row_i, 0)-&gt;nrow_local();</div>
<div class="line"><a name="l04709"></a><span class="lineno"> 4709</span>&#160; </div>
<div class="line"><a name="l04710"></a><span class="lineno"> 4710</span>&#160;          <span class="comment">// Get the first_row for this block_row</span></div>
<div class="line"><a name="l04711"></a><span class="lineno"> 4711</span>&#160;          <span class="keywordtype">unsigned</span> current_block_row_first_row =</div>
<div class="line"><a name="l04712"></a><span class="lineno"> 4712</span>&#160;            matrix_pt(block_row_i, 0)-&gt;first_row();</div>
<div class="line"><a name="l04713"></a><span class="lineno"> 4713</span>&#160; </div>
<div class="line"><a name="l04714"></a><span class="lineno"> 4714</span>&#160;          <span class="comment">// Loop through the number of local rows</span></div>
<div class="line"><a name="l04715"></a><span class="lineno"> 4715</span>&#160;          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> sub_local_eqn = 0;</div>
<div class="line"><a name="l04716"></a><span class="lineno"> 4716</span>&#160;               sub_local_eqn &lt; current_block_nrow_local;</div>
<div class="line"><a name="l04717"></a><span class="lineno"> 4717</span>&#160;               sub_local_eqn++)</div>
<div class="line"><a name="l04718"></a><span class="lineno"> 4718</span>&#160;          {</div>
<div class="line"><a name="l04719"></a><span class="lineno"> 4719</span>&#160;            <span class="comment">// Calculate the corresponding (res_global_eqn) equation number</span></div>
<div class="line"><a name="l04720"></a><span class="lineno"> 4720</span>&#160;            <span class="comment">// for this local row number in this block.</span></div>
<div class="line"><a name="l04721"></a><span class="lineno"> 4721</span>&#160;            <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> res_global_eqn =</div>
<div class="line"><a name="l04722"></a><span class="lineno"> 4722</span>&#160;              sub_local_eqn + current_block_row_first_row + sum_of_block_nrow;</div>
<div class="line"><a name="l04723"></a><span class="lineno"> 4723</span>&#160; </div>
<div class="line"><a name="l04724"></a><span class="lineno"> 4724</span>&#160;            <span class="comment">// Get the processor that this global row belongs to.</span></div>
<div class="line"><a name="l04725"></a><span class="lineno"> 4725</span>&#160;            <span class="comment">// The rank_of_global_row(...) function loops through all the</span></div>
<div class="line"><a name="l04726"></a><span class="lineno"> 4726</span>&#160;            <span class="comment">// processors and does two unsigned comparisons. Since we have to do</span></div>
<div class="line"><a name="l04727"></a><span class="lineno"> 4727</span>&#160;            <span class="comment">// this for every row, it may be better to store a list mapping for</span></div>
<div class="line"><a name="l04728"></a><span class="lineno"> 4728</span>&#160;            <span class="comment">// very large number of processors.</span></div>
<div class="line"><a name="l04729"></a><span class="lineno"> 4729</span>&#160;            <span class="keywordtype">unsigned</span> res_p =</div>
<div class="line"><a name="l04730"></a><span class="lineno"> 4730</span>&#160;              res_distribution_pt-&gt;rank_of_global_row(res_global_eqn);</div>
<div class="line"><a name="l04731"></a><span class="lineno"> 4731</span>&#160; </div>
<div class="line"><a name="l04732"></a><span class="lineno"> 4732</span>&#160;            <span class="comment">// With the res_p, we get the res_first_row to</span></div>
<div class="line"><a name="l04733"></a><span class="lineno"> 4733</span>&#160;            <span class="comment">// work out the res_local_eqn</span></div>
<div class="line"><a name="l04734"></a><span class="lineno"> 4734</span>&#160;            <span class="keywordtype">unsigned</span> res_first_row = res_distribution_pt-&gt;first_row(res_p);</div>
<div class="line"><a name="l04735"></a><span class="lineno"> 4735</span>&#160;            <span class="keywordtype">unsigned</span> res_local_eqn = res_global_eqn - res_first_row;</div>
<div class="line"><a name="l04736"></a><span class="lineno"> 4736</span>&#160; </div>
<div class="line"><a name="l04737"></a><span class="lineno"> 4737</span>&#160;            <span class="comment">// Loop through the block columns, calculate the nnz. This is used</span></div>
<div class="line"><a name="l04738"></a><span class="lineno"> 4738</span>&#160;            <span class="comment">// to reserve space for the value and column_indices Vectors.</span></div>
<div class="line"><a name="l04739"></a><span class="lineno"> 4739</span>&#160;            <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> current_row_nnz = 0;</div>
<div class="line"><a name="l04740"></a><span class="lineno"> 4740</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 0; block_col_i &lt; matrix_ncol;</div>
<div class="line"><a name="l04741"></a><span class="lineno"> 4741</span>&#160;                 block_col_i++)</div>
<div class="line"><a name="l04742"></a><span class="lineno"> 4742</span>&#160;            {</div>
<div class="line"><a name="l04743"></a><span class="lineno"> 4743</span>&#160;              <span class="comment">// Get the row_start</span></div>
<div class="line"><a name="l04744"></a><span class="lineno"> 4744</span>&#160;              <span class="keywordtype">int</span>* current_block_row_start =</div>
<div class="line"><a name="l04745"></a><span class="lineno"> 4745</span>&#160;                matrix_pt(block_row_i, block_col_i)-&gt;row_start();</div>
<div class="line"><a name="l04746"></a><span class="lineno"> 4746</span>&#160; </div>
<div class="line"><a name="l04747"></a><span class="lineno"> 4747</span>&#160;              <span class="comment">// Update the nnz for this row.</span></div>
<div class="line"><a name="l04748"></a><span class="lineno"> 4748</span>&#160;              current_row_nnz += current_block_row_start[sub_local_eqn + 1] -</div>
<div class="line"><a name="l04749"></a><span class="lineno"> 4749</span>&#160;                                 current_block_row_start[sub_local_eqn];</div>
<div class="line"><a name="l04750"></a><span class="lineno"> 4750</span>&#160;            } <span class="comment">// for block column, get nnz.</span></div>
<div class="line"><a name="l04751"></a><span class="lineno"> 4751</span>&#160; </div>
<div class="line"><a name="l04752"></a><span class="lineno"> 4752</span>&#160;            <span class="comment">// Reserve space for efficiency.</span></div>
<div class="line"><a name="l04753"></a><span class="lineno"> 4753</span>&#160;            <span class="comment">// unsigned capacity_in_res_p_vec</span></div>
<div class="line"><a name="l04754"></a><span class="lineno"> 4754</span>&#160;            <span class="comment">//  = column_indices_to_send[res_p].capacity();</span></div>
<div class="line"><a name="l04755"></a><span class="lineno"> 4755</span>&#160; </div>
<div class="line"><a name="l04756"></a><span class="lineno"> 4756</span>&#160;            <span class="comment">// Reserve memory for nnz+2, since we need to store the</span></div>
<div class="line"><a name="l04757"></a><span class="lineno"> 4757</span>&#160;            <span class="comment">// res_local_eqn and nnz as well as the data (values/column</span></div>
<div class="line"><a name="l04758"></a><span class="lineno"> 4758</span>&#160;            <span class="comment">// indices). Note: The two reserve functions are called per row. If</span></div>
<div class="line"><a name="l04759"></a><span class="lineno"> 4759</span>&#160;            <span class="comment">// the matrix is very sparse (just a few elements per row), it will</span></div>
<div class="line"><a name="l04760"></a><span class="lineno"> 4760</span>&#160;            <span class="comment">// be more efficient to not reserve and let the STL vector handle</span></div>
<div class="line"><a name="l04761"></a><span class="lineno"> 4761</span>&#160;            <span class="comment">// this. On average, this implementation is more efficient.</span></div>
<div class="line"><a name="l04762"></a><span class="lineno"> 4762</span>&#160;            <span class="comment">// column_indices_to_send[res_p].reserve(capacity_in_res_p_vec</span></div>
<div class="line"><a name="l04763"></a><span class="lineno"> 4763</span>&#160;            <span class="comment">//    + current_row_nnz+2);</span></div>
<div class="line"><a name="l04764"></a><span class="lineno"> 4764</span>&#160;            <span class="comment">// values_to_send[res_p].reserve(capacity_in_res_p_vec</span></div>
<div class="line"><a name="l04765"></a><span class="lineno"> 4765</span>&#160;            <span class="comment">//    + current_row_nnz+2);</span></div>
<div class="line"><a name="l04766"></a><span class="lineno"> 4766</span>&#160; </div>
<div class="line"><a name="l04767"></a><span class="lineno"> 4767</span>&#160;            <span class="comment">// Push back the res_local_eqn and nnz</span></div>
<div class="line"><a name="l04768"></a><span class="lineno"> 4768</span>&#160;            column_indices_to_send[res_p].push_back(res_local_eqn);</div>
<div class="line"><a name="l04769"></a><span class="lineno"> 4769</span>&#160;            column_indices_to_send[res_p].push_back(current_row_nnz);</div>
<div class="line"><a name="l04770"></a><span class="lineno"> 4770</span>&#160;            values_to_send[res_p].push_back(res_local_eqn);</div>
<div class="line"><a name="l04771"></a><span class="lineno"> 4771</span>&#160;            values_to_send[res_p].push_back(current_row_nnz);</div>
<div class="line"><a name="l04772"></a><span class="lineno"> 4772</span>&#160; </div>
<div class="line"><a name="l04773"></a><span class="lineno"> 4773</span>&#160;            <span class="comment">// Loop through the block columns again and get the values</span></div>
<div class="line"><a name="l04774"></a><span class="lineno"> 4774</span>&#160;            <span class="comment">// and column_indices</span></div>
<div class="line"><a name="l04775"></a><span class="lineno"> 4775</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 0; block_col_i &lt; matrix_ncol;</div>
<div class="line"><a name="l04776"></a><span class="lineno"> 4776</span>&#160;                 block_col_i++)</div>
<div class="line"><a name="l04777"></a><span class="lineno"> 4777</span>&#160;            {</div>
<div class="line"><a name="l04778"></a><span class="lineno"> 4778</span>&#160;              <span class="comment">// Cache the pointer to the current block for convenience.</span></div>
<div class="line"><a name="l04779"></a><span class="lineno"> 4779</span>&#160;              CRDoubleMatrix* current_block_pt =</div>
<div class="line"><a name="l04780"></a><span class="lineno"> 4780</span>&#160;                matrix_pt(block_row_i, block_col_i);</div>
<div class="line"><a name="l04781"></a><span class="lineno"> 4781</span>&#160; </div>
<div class="line"><a name="l04782"></a><span class="lineno"> 4782</span>&#160;              <span class="comment">// Values, column indices and row_start for the current block.</span></div>
<div class="line"><a name="l04783"></a><span class="lineno"> 4783</span>&#160;              <span class="keywordtype">double</span>* current_block_values = current_block_pt-&gt;value();</div>
<div class="line"><a name="l04784"></a><span class="lineno"> 4784</span>&#160;              <span class="keywordtype">int</span>* current_block_column_indices =</div>
<div class="line"><a name="l04785"></a><span class="lineno"> 4785</span>&#160;                current_block_pt-&gt;column_index();</div>
<div class="line"><a name="l04786"></a><span class="lineno"> 4786</span>&#160;              <span class="keywordtype">int</span>* current_block_row_start = current_block_pt-&gt;row_start();</div>
<div class="line"><a name="l04787"></a><span class="lineno"> 4787</span>&#160; </div>
<div class="line"><a name="l04788"></a><span class="lineno"> 4788</span>&#160;              <span class="comment">// Loop though the values and column_indices</span></div>
<div class="line"><a name="l04789"></a><span class="lineno"> 4789</span>&#160;              <span class="keywordflow">for</span> (<span class="keywordtype">int</span> val_i = current_block_row_start[sub_local_eqn];</div>
<div class="line"><a name="l04790"></a><span class="lineno"> 4790</span>&#160;                   val_i &lt; current_block_row_start[sub_local_eqn + 1];</div>
<div class="line"><a name="l04791"></a><span class="lineno"> 4791</span>&#160;                   val_i++)</div>
<div class="line"><a name="l04792"></a><span class="lineno"> 4792</span>&#160;              {</div>
<div class="line"><a name="l04793"></a><span class="lineno"> 4793</span>&#160;                <span class="comment">// Push back the value.</span></div>
<div class="line"><a name="l04794"></a><span class="lineno"> 4794</span>&#160;                values_to_send[res_p].push_back(current_block_values[val_i]);</div>
<div class="line"><a name="l04795"></a><span class="lineno"> 4795</span>&#160; </div>
<div class="line"><a name="l04796"></a><span class="lineno"> 4796</span>&#160;                <span class="comment">// Push back the (offset) column index.</span></div>
<div class="line"><a name="l04797"></a><span class="lineno"> 4797</span>&#160;                column_indices_to_send[res_p].push_back(</div>
<div class="line"><a name="l04798"></a><span class="lineno"> 4798</span>&#160;                  current_block_column_indices[val_i] +</div>
<div class="line"><a name="l04799"></a><span class="lineno"> 4799</span>&#160;                  sum_of_ncol_up_to_block[block_col_i]);</div>
<div class="line"><a name="l04800"></a><span class="lineno"> 4800</span>&#160;              } <span class="comment">// for block columns</span></div>
<div class="line"><a name="l04801"></a><span class="lineno"> 4801</span>&#160;            } <span class="comment">// for block column, get values and column_indices.</span></div>
<div class="line"><a name="l04802"></a><span class="lineno"> 4802</span>&#160;          } <span class="comment">// for sub_local_eqn</span></div>
<div class="line"><a name="l04803"></a><span class="lineno"> 4803</span>&#160; </div>
<div class="line"><a name="l04804"></a><span class="lineno"> 4804</span>&#160;          <span class="comment">// update the sum_of_block_nrow</span></div>
<div class="line"><a name="l04805"></a><span class="lineno"> 4805</span>&#160;          sum_of_block_nrow += matrix_pt(block_row_i, 0)-&gt;nrow();</div>
<div class="line"><a name="l04806"></a><span class="lineno"> 4806</span>&#160; </div>
<div class="line"><a name="l04807"></a><span class="lineno"> 4807</span>&#160;        } <span class="comment">// for block_row</span></div>
<div class="line"><a name="l04808"></a><span class="lineno"> 4808</span>&#160; </div>
<div class="line"><a name="l04809"></a><span class="lineno"> 4809</span>&#160;        <span class="keywordflow">if</span> (enable_timing)</div>
<div class="line"><a name="l04810"></a><span class="lineno"> 4810</span>&#160;        {</div>
<div class="line"><a name="l04811"></a><span class="lineno"> 4811</span>&#160;          <span class="keywordtype">double</span> t_prep_data_finish = <a class="code" href="../../d9/dd8/oomph__metis__from__parmetis__3_81_81_2struct_8h.html#aae821c36bb7e6918e1414484f939c3d4">TimingHelpers::timer</a>();</div>
<div class="line"><a name="l04812"></a><span class="lineno"> 4812</span>&#160;          <span class="keywordtype">double</span> t_prep_data_time = t_prep_data_finish - t_prep_data_start;</div>
<div class="line"><a name="l04813"></a><span class="lineno"> 4813</span>&#160;          <a class="code" href="../../da/ddf/namespaceoomph.html#aec474227917784dc0a255faf289cfc16">oomph_info</a> &lt;&lt; <span class="stringliteral">&quot;Time for prep data: &quot;</span> &lt;&lt; t_prep_data_time &lt;&lt; std::endl;</div>
<div class="line"><a name="l04814"></a><span class="lineno"> 4814</span>&#160;        }</div>
<div class="line"><a name="l04815"></a><span class="lineno"> 4815</span>&#160; </div>
<div class="line"><a name="l04816"></a><span class="lineno"> 4816</span>&#160;        <span class="comment">// Prepare to send data!</span></div>
<div class="line"><a name="l04817"></a><span class="lineno"> 4817</span>&#160; </div>
<div class="line"><a name="l04818"></a><span class="lineno"> 4818</span>&#160;        <span class="comment">// Storage for the number of data to be sent to each processor.</span></div>
<div class="line"><a name="l04819"></a><span class="lineno"> 4819</span>&#160;        Vector&lt;int&gt; send_n(nproc, 0);</div>
<div class="line"><a name="l04820"></a><span class="lineno"> 4820</span>&#160; </div>
<div class="line"><a name="l04821"></a><span class="lineno"> 4821</span>&#160;        <span class="comment">// Storage for all the values/column indices to be sent</span></div>
<div class="line"><a name="l04822"></a><span class="lineno"> 4822</span>&#160;        <span class="comment">// to each processor.</span></div>
<div class="line"><a name="l04823"></a><span class="lineno"> 4823</span>&#160;        Vector&lt;double&gt; send_values_data;</div>
<div class="line"><a name="l04824"></a><span class="lineno"> 4824</span>&#160;        Vector&lt;unsigned&gt; send_column_indices_data;</div>
<div class="line"><a name="l04825"></a><span class="lineno"> 4825</span>&#160; </div>
<div class="line"><a name="l04826"></a><span class="lineno"> 4826</span>&#160;        <span class="comment">// Storage location within send_values_data</span></div>
<div class="line"><a name="l04827"></a><span class="lineno"> 4827</span>&#160;        <span class="comment">// (and send_column_indices_data) for data to be sent to each processor.</span></div>
<div class="line"><a name="l04828"></a><span class="lineno"> 4828</span>&#160;        Vector&lt;int&gt; send_displacement(nproc, 0);</div>
<div class="line"><a name="l04829"></a><span class="lineno"> 4829</span>&#160; </div>
<div class="line"><a name="l04830"></a><span class="lineno"> 4830</span>&#160;        <span class="keywordtype">double</span> t_total_ndata_start;</div>
<div class="line"><a name="l04831"></a><span class="lineno"> 4831</span>&#160;        <span class="keywordflow">if</span> (enable_timing) t_total_ndata_start = <a class="code" href="../../d9/dd8/oomph__metis__from__parmetis__3_81_81_2struct_8h.html#aae821c36bb7e6918e1414484f939c3d4">TimingHelpers::timer</a>();</div>
<div class="line"><a name="l04832"></a><span class="lineno"> 4832</span>&#160; </div>
<div class="line"><a name="l04833"></a><span class="lineno"> 4833</span>&#160;        <span class="comment">// Get the total amount of data which needs to be sent, so we can</span></div>
<div class="line"><a name="l04834"></a><span class="lineno"> 4834</span>&#160;        <span class="comment">// reserve space for it.</span></div>
<div class="line"><a name="l04835"></a><span class="lineno"> 4835</span>&#160;        <span class="keywordtype">unsigned</span> total_ndata = 0;</div>
<div class="line"><a name="l04836"></a><span class="lineno"> 4836</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> rank = 0; rank &lt; nproc; rank++)</div>
<div class="line"><a name="l04837"></a><span class="lineno"> 4837</span>&#160;        {</div>
<div class="line"><a name="l04838"></a><span class="lineno"> 4838</span>&#160;          <span class="keywordflow">if</span> (rank != my_rank)</div>
<div class="line"><a name="l04839"></a><span class="lineno"> 4839</span>&#160;          {</div>
<div class="line"><a name="l04840"></a><span class="lineno"> 4840</span>&#160;            total_ndata += values_to_send[rank].size();</div>
<div class="line"><a name="l04841"></a><span class="lineno"> 4841</span>&#160;          }</div>
<div class="line"><a name="l04842"></a><span class="lineno"> 4842</span>&#160;        }</div>
<div class="line"><a name="l04843"></a><span class="lineno"> 4843</span>&#160; </div>
<div class="line"><a name="l04844"></a><span class="lineno"> 4844</span>&#160;        <span class="keywordflow">if</span> (enable_timing)</div>
<div class="line"><a name="l04845"></a><span class="lineno"> 4845</span>&#160;        {</div>
<div class="line"><a name="l04846"></a><span class="lineno"> 4846</span>&#160;          <span class="keywordtype">double</span> t_total_ndata_finish = <a class="code" href="../../d9/dd8/oomph__metis__from__parmetis__3_81_81_2struct_8h.html#aae821c36bb7e6918e1414484f939c3d4">TimingHelpers::timer</a>();</div>
<div class="line"><a name="l04847"></a><span class="lineno"> 4847</span>&#160;          <span class="keywordtype">double</span> t_total_ndata_time =</div>
<div class="line"><a name="l04848"></a><span class="lineno"> 4848</span>&#160;            t_total_ndata_finish - t_total_ndata_start;</div>
<div class="line"><a name="l04849"></a><span class="lineno"> 4849</span>&#160;          <a class="code" href="../../da/ddf/namespaceoomph.html#aec474227917784dc0a255faf289cfc16">oomph_info</a> &lt;&lt; <span class="stringliteral">&quot;Time for total_ndata: &quot;</span> &lt;&lt; t_total_ndata_time</div>
<div class="line"><a name="l04850"></a><span class="lineno"> 4850</span>&#160;                     &lt;&lt; std::endl;</div>
<div class="line"><a name="l04851"></a><span class="lineno"> 4851</span>&#160;        }</div>
<div class="line"><a name="l04852"></a><span class="lineno"> 4852</span>&#160; </div>
<div class="line"><a name="l04853"></a><span class="lineno"> 4853</span>&#160;        <span class="keywordtype">double</span> t_flat_pack_start;</div>
<div class="line"><a name="l04854"></a><span class="lineno"> 4854</span>&#160;        <span class="keywordflow">if</span> (enable_timing) t_flat_pack_start = <a class="code" href="../../d9/dd8/oomph__metis__from__parmetis__3_81_81_2struct_8h.html#aae821c36bb7e6918e1414484f939c3d4">TimingHelpers::timer</a>();</div>
<div class="line"><a name="l04855"></a><span class="lineno"> 4855</span>&#160; </div>
<div class="line"><a name="l04856"></a><span class="lineno"> 4856</span>&#160;        <span class="comment">// Now we don&#39;t have to re-allocate data/memory when push_back is</span></div>
<div class="line"><a name="l04857"></a><span class="lineno"> 4857</span>&#160;        <span class="comment">// called. Nb. Using push_back without reserving memory may cause</span></div>
<div class="line"><a name="l04858"></a><span class="lineno"> 4858</span>&#160;        <span class="comment">// multiple re-allocation behind the scenes, this is expensive.</span></div>
<div class="line"><a name="l04859"></a><span class="lineno"> 4859</span>&#160;        send_values_data.reserve(total_ndata);</div>
<div class="line"><a name="l04860"></a><span class="lineno"> 4860</span>&#160;        send_column_indices_data.reserve(total_ndata);</div>
<div class="line"><a name="l04861"></a><span class="lineno"> 4861</span>&#160; </div>
<div class="line"><a name="l04862"></a><span class="lineno"> 4862</span>&#160;        <span class="comment">// Loop over all the processors to &quot;flat pack&quot; the data for sending.</span></div>
<div class="line"><a name="l04863"></a><span class="lineno"> 4863</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> rank = 0; rank &lt; nproc; rank++)</div>
<div class="line"><a name="l04864"></a><span class="lineno"> 4864</span>&#160;        {</div>
<div class="line"><a name="l04865"></a><span class="lineno"> 4865</span>&#160;          <span class="comment">// Set the offset for the current processor</span></div>
<div class="line"><a name="l04866"></a><span class="lineno"> 4866</span>&#160;          <span class="comment">// This only has to be done once for both values and column indices.</span></div>
<div class="line"><a name="l04867"></a><span class="lineno"> 4867</span>&#160;          send_displacement[rank] = send_values_data.size();</div>
<div class="line"><a name="l04868"></a><span class="lineno"> 4868</span>&#160; </div>
<div class="line"><a name="l04869"></a><span class="lineno"> 4869</span>&#160;          <span class="comment">// Don&#39;t bother to do anything if</span></div>
<div class="line"><a name="l04870"></a><span class="lineno"> 4870</span>&#160;          <span class="comment">// the processor in the loop is the current processor.</span></div>
<div class="line"><a name="l04871"></a><span class="lineno"> 4871</span>&#160;          <span class="keywordflow">if</span> (rank != my_rank)</div>
<div class="line"><a name="l04872"></a><span class="lineno"> 4872</span>&#160;          {</div>
<div class="line"><a name="l04873"></a><span class="lineno"> 4873</span>&#160;            <span class="comment">// Put the values into the send data vector.</span></div>
<div class="line"><a name="l04874"></a><span class="lineno"> 4874</span>&#160;            <span class="comment">// n_data is the same for both values and column indices.</span></div>
<div class="line"><a name="l04875"></a><span class="lineno"> 4875</span>&#160;            <span class="keywordtype">unsigned</span> n_data = values_to_send[rank].size();</div>
<div class="line"><a name="l04876"></a><span class="lineno"> 4876</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <a class="code" href="../../da/dd4/tut__arithmetic__redux__minmax_8cpp.html#a39513f0f8d942bf9ef17b2e87ac6d34e">j</a> = 0; <a class="code" href="../../da/dd4/tut__arithmetic__redux__minmax_8cpp.html#a39513f0f8d942bf9ef17b2e87ac6d34e">j</a> &lt; n_data; <a class="code" href="../../da/dd4/tut__arithmetic__redux__minmax_8cpp.html#a39513f0f8d942bf9ef17b2e87ac6d34e">j</a>++)</div>
<div class="line"><a name="l04877"></a><span class="lineno"> 4877</span>&#160;            {</div>
<div class="line"><a name="l04878"></a><span class="lineno"> 4878</span>&#160;              send_values_data.push_back(values_to_send[rank][<a class="code" href="../../da/dd4/tut__arithmetic__redux__minmax_8cpp.html#a39513f0f8d942bf9ef17b2e87ac6d34e">j</a>]);</div>
<div class="line"><a name="l04879"></a><span class="lineno"> 4879</span>&#160;              send_column_indices_data.push_back(</div>
<div class="line"><a name="l04880"></a><span class="lineno"> 4880</span>&#160;                column_indices_to_send[rank][<a class="code" href="../../da/dd4/tut__arithmetic__redux__minmax_8cpp.html#a39513f0f8d942bf9ef17b2e87ac6d34e">j</a>]);</div>
<div class="line"><a name="l04881"></a><span class="lineno"> 4881</span>&#160;            } <span class="comment">// for</span></div>
<div class="line"><a name="l04882"></a><span class="lineno"> 4882</span>&#160;          } <span class="comment">// if rank != my_rank</span></div>
<div class="line"><a name="l04883"></a><span class="lineno"> 4883</span>&#160; </div>
<div class="line"><a name="l04884"></a><span class="lineno"> 4884</span>&#160;          <span class="comment">// Find the number of data to be added to the vector.</span></div>
<div class="line"><a name="l04885"></a><span class="lineno"> 4885</span>&#160;          <span class="comment">// send_n is the same for both values and column indices.</span></div>
<div class="line"><a name="l04886"></a><span class="lineno"> 4886</span>&#160;          send_n[rank] = send_values_data.size() - send_displacement[rank];</div>
<div class="line"><a name="l04887"></a><span class="lineno"> 4887</span>&#160;        } <span class="comment">// loop over processors</span></div>
<div class="line"><a name="l04888"></a><span class="lineno"> 4888</span>&#160; </div>
<div class="line"><a name="l04889"></a><span class="lineno"> 4889</span>&#160;        <span class="keywordflow">if</span> (enable_timing)</div>
<div class="line"><a name="l04890"></a><span class="lineno"> 4890</span>&#160;        {</div>
<div class="line"><a name="l04891"></a><span class="lineno"> 4891</span>&#160;          <span class="keywordtype">double</span> t_flat_pack_finish = <a class="code" href="../../d9/dd8/oomph__metis__from__parmetis__3_81_81_2struct_8h.html#aae821c36bb7e6918e1414484f939c3d4">TimingHelpers::timer</a>();</div>
<div class="line"><a name="l04892"></a><span class="lineno"> 4892</span>&#160;          <span class="keywordtype">double</span> t_flat_pack_time = t_flat_pack_finish - t_flat_pack_start;</div>
<div class="line"><a name="l04893"></a><span class="lineno"> 4893</span>&#160;          <a class="code" href="../../da/ddf/namespaceoomph.html#aec474227917784dc0a255faf289cfc16">oomph_info</a> &lt;&lt; <span class="stringliteral">&quot;t_flat_pack_time: &quot;</span> &lt;&lt; t_flat_pack_time &lt;&lt; std::endl;</div>
<div class="line"><a name="l04894"></a><span class="lineno"> 4894</span>&#160;        }</div>
<div class="line"><a name="l04895"></a><span class="lineno"> 4895</span>&#160; </div>
<div class="line"><a name="l04896"></a><span class="lineno"> 4896</span>&#160;        <span class="keywordtype">double</span> t_sendn_start;</div>
<div class="line"><a name="l04897"></a><span class="lineno"> 4897</span>&#160;        <span class="keywordflow">if</span> (enable_timing) t_sendn_start = <a class="code" href="../../d9/dd8/oomph__metis__from__parmetis__3_81_81_2struct_8h.html#aae821c36bb7e6918e1414484f939c3d4">TimingHelpers::timer</a>();</div>
<div class="line"><a name="l04898"></a><span class="lineno"> 4898</span>&#160; </div>
<div class="line"><a name="l04899"></a><span class="lineno"> 4899</span>&#160;        <span class="comment">// Strorage for the number of data to be received from each processor</span></div>
<div class="line"><a name="l04900"></a><span class="lineno"> 4900</span>&#160;        Vector&lt;int&gt; receive_n(nproc, 0);</div>
<div class="line"><a name="l04901"></a><span class="lineno"> 4901</span>&#160; </div>
<div class="line"><a name="l04902"></a><span class="lineno"> 4902</span>&#160;        MPI_Alltoall(&amp;send_n[0],</div>
<div class="line"><a name="l04903"></a><span class="lineno"> 4903</span>&#160;                     1,</div>
<div class="line"><a name="l04904"></a><span class="lineno"> 4904</span>&#160;                     MPI_INT,</div>
<div class="line"><a name="l04905"></a><span class="lineno"> 4905</span>&#160;                     &amp;receive_n[0],</div>
<div class="line"><a name="l04906"></a><span class="lineno"> 4906</span>&#160;                     1,</div>
<div class="line"><a name="l04907"></a><span class="lineno"> 4907</span>&#160;                     MPI_INT,</div>
<div class="line"><a name="l04908"></a><span class="lineno"> 4908</span>&#160;                     comm_pt-&gt;mpi_comm());</div>
<div class="line"><a name="l04909"></a><span class="lineno"> 4909</span>&#160; </div>
<div class="line"><a name="l04910"></a><span class="lineno"> 4910</span>&#160;        <span class="keywordflow">if</span> (enable_timing)</div>
<div class="line"><a name="l04911"></a><span class="lineno"> 4911</span>&#160;        {</div>
<div class="line"><a name="l04912"></a><span class="lineno"> 4912</span>&#160;          <span class="keywordtype">double</span> t_sendn_finish = <a class="code" href="../../d9/dd8/oomph__metis__from__parmetis__3_81_81_2struct_8h.html#aae821c36bb7e6918e1414484f939c3d4">TimingHelpers::timer</a>();</div>
<div class="line"><a name="l04913"></a><span class="lineno"> 4913</span>&#160;          <span class="keywordtype">double</span> t_sendn_time = t_sendn_finish - t_sendn_start;</div>
<div class="line"><a name="l04914"></a><span class="lineno"> 4914</span>&#160;          <a class="code" href="../../da/ddf/namespaceoomph.html#aec474227917784dc0a255faf289cfc16">oomph_info</a> &lt;&lt; <span class="stringliteral">&quot;t_sendn_time: &quot;</span> &lt;&lt; t_sendn_time &lt;&lt; std::endl;</div>
<div class="line"><a name="l04915"></a><span class="lineno"> 4915</span>&#160;        }</div>
<div class="line"><a name="l04916"></a><span class="lineno"> 4916</span>&#160; </div>
<div class="line"><a name="l04917"></a><span class="lineno"> 4917</span>&#160; </div>
<div class="line"><a name="l04918"></a><span class="lineno"> 4918</span>&#160;        <span class="comment">// Prepare the data to be received</span></div>
<div class="line"><a name="l04919"></a><span class="lineno"> 4919</span>&#160;        <span class="comment">// by working out the displacement from the received data</span></div>
<div class="line"><a name="l04920"></a><span class="lineno"> 4920</span>&#160;        <span class="comment">// receive_displacement is the same for both values and column indices.</span></div>
<div class="line"><a name="l04921"></a><span class="lineno"> 4921</span>&#160;        Vector&lt;int&gt; receive_displacement(nproc, 0);</div>
<div class="line"><a name="l04922"></a><span class="lineno"> 4922</span>&#160;        <span class="keywordtype">int</span> receive_data_count = 0;</div>
<div class="line"><a name="l04923"></a><span class="lineno"> 4923</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> rank = 0; rank &lt; nproc; rank++)</div>
<div class="line"><a name="l04924"></a><span class="lineno"> 4924</span>&#160;        {</div>
<div class="line"><a name="l04925"></a><span class="lineno"> 4925</span>&#160;          receive_displacement[rank] = receive_data_count;</div>
<div class="line"><a name="l04926"></a><span class="lineno"> 4926</span>&#160;          receive_data_count += receive_n[rank];</div>
<div class="line"><a name="l04927"></a><span class="lineno"> 4927</span>&#160;        }</div>
<div class="line"><a name="l04928"></a><span class="lineno"> 4928</span>&#160; </div>
<div class="line"><a name="l04929"></a><span class="lineno"> 4929</span>&#160;        <span class="comment">// Now resize the receive buffer for all data from all processors.</span></div>
<div class="line"><a name="l04930"></a><span class="lineno"> 4930</span>&#160;        <span class="comment">// Make sure that it has a size of at least one.</span></div>
<div class="line"><a name="l04931"></a><span class="lineno"> 4931</span>&#160;        <span class="keywordflow">if</span> (receive_data_count == 0)</div>
<div class="line"><a name="l04932"></a><span class="lineno"> 4932</span>&#160;        {</div>
<div class="line"><a name="l04933"></a><span class="lineno"> 4933</span>&#160;          receive_data_count++;</div>
<div class="line"><a name="l04934"></a><span class="lineno"> 4934</span>&#160;        }</div>
<div class="line"><a name="l04935"></a><span class="lineno"> 4935</span>&#160;        Vector&lt;double&gt; receive_values_data(receive_data_count);</div>
<div class="line"><a name="l04936"></a><span class="lineno"> 4936</span>&#160;        Vector&lt;unsigned&gt; receive_column_indices_data(receive_data_count);</div>
<div class="line"><a name="l04937"></a><span class="lineno"> 4937</span>&#160; </div>
<div class="line"><a name="l04938"></a><span class="lineno"> 4938</span>&#160;        <span class="comment">// Make sure that the send buffer has size at least one</span></div>
<div class="line"><a name="l04939"></a><span class="lineno"> 4939</span>&#160;        <span class="comment">// so that we don&#39;t get a segmentation fault.</span></div>
<div class="line"><a name="l04940"></a><span class="lineno"> 4940</span>&#160;        <span class="keywordflow">if</span> (send_values_data.size() == 0)</div>
<div class="line"><a name="l04941"></a><span class="lineno"> 4941</span>&#160;        {</div>
<div class="line"><a name="l04942"></a><span class="lineno"> 4942</span>&#160;          send_values_data.resize(1);</div>
<div class="line"><a name="l04943"></a><span class="lineno"> 4943</span>&#160;        }</div>
<div class="line"><a name="l04944"></a><span class="lineno"> 4944</span>&#160; </div>
<div class="line"><a name="l04945"></a><span class="lineno"> 4945</span>&#160;        <span class="keywordtype">double</span> t_send_data_start;</div>
<div class="line"><a name="l04946"></a><span class="lineno"> 4946</span>&#160;        <span class="keywordflow">if</span> (enable_timing) t_send_data_start = <a class="code" href="../../d9/dd8/oomph__metis__from__parmetis__3_81_81_2struct_8h.html#aae821c36bb7e6918e1414484f939c3d4">TimingHelpers::timer</a>();</div>
<div class="line"><a name="l04947"></a><span class="lineno"> 4947</span>&#160; </div>
<div class="line"><a name="l04948"></a><span class="lineno"> 4948</span>&#160;        <span class="comment">// Now send the data between all processors</span></div>
<div class="line"><a name="l04949"></a><span class="lineno"> 4949</span>&#160;        MPI_Alltoallv(&amp;send_values_data[0],</div>
<div class="line"><a name="l04950"></a><span class="lineno"> 4950</span>&#160;                      &amp;send_n[0],</div>
<div class="line"><a name="l04951"></a><span class="lineno"> 4951</span>&#160;                      &amp;send_displacement[0],</div>
<div class="line"><a name="l04952"></a><span class="lineno"> 4952</span>&#160;                      MPI_DOUBLE,</div>
<div class="line"><a name="l04953"></a><span class="lineno"> 4953</span>&#160;                      &amp;receive_values_data[0],</div>
<div class="line"><a name="l04954"></a><span class="lineno"> 4954</span>&#160;                      &amp;receive_n[0],</div>
<div class="line"><a name="l04955"></a><span class="lineno"> 4955</span>&#160;                      &amp;receive_displacement[0],</div>
<div class="line"><a name="l04956"></a><span class="lineno"> 4956</span>&#160;                      MPI_DOUBLE,</div>
<div class="line"><a name="l04957"></a><span class="lineno"> 4957</span>&#160;                      comm_pt-&gt;mpi_comm());</div>
<div class="line"><a name="l04958"></a><span class="lineno"> 4958</span>&#160; </div>
<div class="line"><a name="l04959"></a><span class="lineno"> 4959</span>&#160;        <span class="comment">// Now send the data between all processors</span></div>
<div class="line"><a name="l04960"></a><span class="lineno"> 4960</span>&#160;        MPI_Alltoallv(&amp;send_column_indices_data[0],</div>
<div class="line"><a name="l04961"></a><span class="lineno"> 4961</span>&#160;                      &amp;send_n[0],</div>
<div class="line"><a name="l04962"></a><span class="lineno"> 4962</span>&#160;                      &amp;send_displacement[0],</div>
<div class="line"><a name="l04963"></a><span class="lineno"> 4963</span>&#160;                      MPI_UNSIGNED,</div>
<div class="line"><a name="l04964"></a><span class="lineno"> 4964</span>&#160;                      &amp;receive_column_indices_data[0],</div>
<div class="line"><a name="l04965"></a><span class="lineno"> 4965</span>&#160;                      &amp;receive_n[0],</div>
<div class="line"><a name="l04966"></a><span class="lineno"> 4966</span>&#160;                      &amp;receive_displacement[0],</div>
<div class="line"><a name="l04967"></a><span class="lineno"> 4967</span>&#160;                      MPI_UNSIGNED,</div>
<div class="line"><a name="l04968"></a><span class="lineno"> 4968</span>&#160;                      comm_pt-&gt;mpi_comm());</div>
<div class="line"><a name="l04969"></a><span class="lineno"> 4969</span>&#160; </div>
<div class="line"><a name="l04970"></a><span class="lineno"> 4970</span>&#160;        <span class="keywordflow">if</span> (enable_timing)</div>
<div class="line"><a name="l04971"></a><span class="lineno"> 4971</span>&#160;        {</div>
<div class="line"><a name="l04972"></a><span class="lineno"> 4972</span>&#160;          <span class="keywordtype">double</span> t_send_data_finish = <a class="code" href="../../d9/dd8/oomph__metis__from__parmetis__3_81_81_2struct_8h.html#aae821c36bb7e6918e1414484f939c3d4">TimingHelpers::timer</a>();</div>
<div class="line"><a name="l04973"></a><span class="lineno"> 4973</span>&#160;          <span class="keywordtype">double</span> t_send_data_time = t_send_data_finish - t_send_data_start;</div>
<div class="line"><a name="l04974"></a><span class="lineno"> 4974</span>&#160;          <a class="code" href="../../da/ddf/namespaceoomph.html#aec474227917784dc0a255faf289cfc16">oomph_info</a> &lt;&lt; <span class="stringliteral">&quot;t_send_data_time: &quot;</span> &lt;&lt; t_send_data_time &lt;&lt; std::endl;</div>
<div class="line"><a name="l04975"></a><span class="lineno"> 4975</span>&#160;        }</div>
<div class="line"><a name="l04976"></a><span class="lineno"> 4976</span>&#160; </div>
<div class="line"><a name="l04977"></a><span class="lineno"> 4977</span>&#160;        <span class="comment">// All the rows for this processor are stored in:</span></div>
<div class="line"><a name="l04978"></a><span class="lineno"> 4978</span>&#160;        <span class="comment">// from other processors:</span></div>
<div class="line"><a name="l04979"></a><span class="lineno"> 4979</span>&#160;        <span class="comment">// receive_column_indices_data and receive_values_data</span></div>
<div class="line"><a name="l04980"></a><span class="lineno"> 4980</span>&#160;        <span class="comment">// from this processor:</span></div>
<div class="line"><a name="l04981"></a><span class="lineno"> 4981</span>&#160;        <span class="comment">// column_indices_to_send[my_rank] and values_to_send[my_rank]</span></div>
<div class="line"><a name="l04982"></a><span class="lineno"> 4982</span>&#160;        <span class="comment">//</span></div>
<div class="line"><a name="l04983"></a><span class="lineno"> 4983</span>&#160;        <span class="comment">// They are in some order determined by the distribution.</span></div>
<div class="line"><a name="l04984"></a><span class="lineno"> 4984</span>&#160;        <span class="comment">// We need to re-arrange them. To do this, we do some pre-processing.</span></div>
<div class="line"><a name="l04985"></a><span class="lineno"> 4985</span>&#160; </div>
<div class="line"><a name="l04986"></a><span class="lineno"> 4986</span>&#160;        <span class="comment">// nrow_local for this processor.</span></div>
<div class="line"><a name="l04987"></a><span class="lineno"> 4987</span>&#160;        <span class="keywordtype">unsigned</span> res_nrow_local = res_distribution_pt-&gt;nrow_local();</div>
<div class="line"><a name="l04988"></a><span class="lineno"> 4988</span>&#160; </div>
<div class="line"><a name="l04989"></a><span class="lineno"> 4989</span>&#160;        <span class="comment">// Per row, store:</span></div>
<div class="line"><a name="l04990"></a><span class="lineno"> 4990</span>&#160;        <span class="comment">// 1) where this row came from, 0 - this proc, 1 - other procs.</span></div>
<div class="line"><a name="l04991"></a><span class="lineno"> 4991</span>&#160;        <span class="comment">// 2) the nnz,</span></div>
<div class="line"><a name="l04992"></a><span class="lineno"> 4992</span>&#160;        <span class="comment">// 3) the offset - where the values/columns in the receive data vectors</span></div>
<div class="line"><a name="l04993"></a><span class="lineno"> 4993</span>&#160;        <span class="comment">//                 begins. This is different from the offset of where</span></div>
<div class="line"><a name="l04994"></a><span class="lineno"> 4994</span>&#160;        <span class="comment">//                 the data from a certain processor starts.</span></div>
<div class="line"><a name="l04995"></a><span class="lineno"> 4995</span>&#160;        Vector&lt;Vector&lt;unsigned&gt;&gt; value_column_locations(res_nrow_local,</div>
<div class="line"><a name="l04996"></a><span class="lineno"> 4996</span>&#160;                                                        Vector&lt;unsigned&gt;(3, 0));</div>
<div class="line"><a name="l04997"></a><span class="lineno"> 4997</span>&#160; </div>
<div class="line"><a name="l04998"></a><span class="lineno"> 4998</span>&#160;        <span class="comment">// Store the local nnz so we can reserve space for</span></div>
<div class="line"><a name="l04999"></a><span class="lineno"> 4999</span>&#160;        <span class="comment">// the values and column indices.</span></div>
<div class="line"><a name="l05000"></a><span class="lineno"> 5000</span>&#160;        <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> res_nnz_local = 0;</div>
<div class="line"><a name="l05001"></a><span class="lineno"> 5001</span>&#160; </div>
<div class="line"><a name="l05002"></a><span class="lineno"> 5002</span>&#160;        <span class="keywordtype">double</span> t_locations_start;</div>
<div class="line"><a name="l05003"></a><span class="lineno"> 5003</span>&#160;        <span class="keywordflow">if</span> (enable_timing) t_locations_start = <a class="code" href="../../d9/dd8/oomph__metis__from__parmetis__3_81_81_2struct_8h.html#aae821c36bb7e6918e1414484f939c3d4">TimingHelpers::timer</a>();</div>
<div class="line"><a name="l05004"></a><span class="lineno"> 5004</span>&#160; </div>
<div class="line"><a name="l05005"></a><span class="lineno"> 5005</span>&#160;        <span class="comment">// Loop through the data currently on this processor.</span></div>
<div class="line"><a name="l05006"></a><span class="lineno"> 5006</span>&#160;        <span class="keywordtype">unsigned</span> location_i = 0;</div>
<div class="line"><a name="l05007"></a><span class="lineno"> 5007</span>&#160;        <span class="keywordtype">unsigned</span> my_column_indices_to_send_size =</div>
<div class="line"><a name="l05008"></a><span class="lineno"> 5008</span>&#160;          column_indices_to_send[my_rank].size();</div>
<div class="line"><a name="l05009"></a><span class="lineno"> 5009</span>&#160;        <span class="keywordflow">while</span> (location_i &lt; my_column_indices_to_send_size)</div>
<div class="line"><a name="l05010"></a><span class="lineno"> 5010</span>&#160;        {</div>
<div class="line"><a name="l05011"></a><span class="lineno"> 5011</span>&#160;          <span class="keywordtype">unsigned</span> current_local_eqn =</div>
<div class="line"><a name="l05012"></a><span class="lineno"> 5012</span>&#160;            column_indices_to_send[my_rank][location_i++];</div>
<div class="line"><a name="l05013"></a><span class="lineno"> 5013</span>&#160; </div>
<div class="line"><a name="l05014"></a><span class="lineno"> 5014</span>&#160;          <span class="keywordtype">unsigned</span> current_nnz = column_indices_to_send[my_rank][location_i++];</div>
<div class="line"><a name="l05015"></a><span class="lineno"> 5015</span>&#160; </div>
<div class="line"><a name="l05016"></a><span class="lineno"> 5016</span>&#160;          <span class="comment">// No need to fill [*][0] with 0 since it is already initialised to 0.</span></div>
<div class="line"><a name="l05017"></a><span class="lineno"> 5017</span>&#160; </div>
<div class="line"><a name="l05018"></a><span class="lineno"> 5018</span>&#160;          <span class="comment">// Store the nnz.</span></div>
<div class="line"><a name="l05019"></a><span class="lineno"> 5019</span>&#160;          value_column_locations[current_local_eqn][1] = current_nnz;</div>
<div class="line"><a name="l05020"></a><span class="lineno"> 5020</span>&#160; </div>
<div class="line"><a name="l05021"></a><span class="lineno"> 5021</span>&#160;          <span class="comment">// Also increment the res_local_nnz</span></div>
<div class="line"><a name="l05022"></a><span class="lineno"> 5022</span>&#160;          res_nnz_local += current_nnz;</div>
<div class="line"><a name="l05023"></a><span class="lineno"> 5023</span>&#160; </div>
<div class="line"><a name="l05024"></a><span class="lineno"> 5024</span>&#160;          <span class="comment">// Store the offset.</span></div>
<div class="line"><a name="l05025"></a><span class="lineno"> 5025</span>&#160;          value_column_locations[current_local_eqn][2] = location_i;</div>
<div class="line"><a name="l05026"></a><span class="lineno"> 5026</span>&#160; </div>
<div class="line"><a name="l05027"></a><span class="lineno"> 5027</span>&#160;          <span class="comment">// Update the location_i so it starts at the next row.</span></div>
<div class="line"><a name="l05028"></a><span class="lineno"> 5028</span>&#160;          location_i += current_nnz;</div>
<div class="line"><a name="l05029"></a><span class="lineno"> 5029</span>&#160;        }</div>
<div class="line"><a name="l05030"></a><span class="lineno"> 5030</span>&#160; </div>
<div class="line"><a name="l05031"></a><span class="lineno"> 5031</span>&#160;        <span class="comment">// Loop through the data from different processors.</span></div>
<div class="line"><a name="l05032"></a><span class="lineno"> 5032</span>&#160; </div>
<div class="line"><a name="l05033"></a><span class="lineno"> 5033</span>&#160;        <span class="comment">// Check to see if data has been received.</span></div>
<div class="line"><a name="l05034"></a><span class="lineno"> 5034</span>&#160;        <span class="keywordtype">bool</span> data_has_been_received = <span class="keyword">false</span>;</div>
<div class="line"><a name="l05035"></a><span class="lineno"> 5035</span>&#160;        <span class="keywordtype">unsigned</span> send_rank = 0;</div>
<div class="line"><a name="l05036"></a><span class="lineno"> 5036</span>&#160;        <span class="keywordflow">while</span> (send_rank &lt; nproc)</div>
<div class="line"><a name="l05037"></a><span class="lineno"> 5037</span>&#160;        {</div>
<div class="line"><a name="l05038"></a><span class="lineno"> 5038</span>&#160;          <span class="keywordflow">if</span> (receive_n[send_rank] &gt; 0)</div>
<div class="line"><a name="l05039"></a><span class="lineno"> 5039</span>&#160;          {</div>
<div class="line"><a name="l05040"></a><span class="lineno"> 5040</span>&#160;            data_has_been_received = <span class="keyword">true</span>;</div>
<div class="line"><a name="l05041"></a><span class="lineno"> 5041</span>&#160;            <span class="keywordflow">break</span>;</div>
<div class="line"><a name="l05042"></a><span class="lineno"> 5042</span>&#160;          }</div>
<div class="line"><a name="l05043"></a><span class="lineno"> 5043</span>&#160;          send_rank++;</div>
<div class="line"><a name="l05044"></a><span class="lineno"> 5044</span>&#160;        }</div>
<div class="line"><a name="l05045"></a><span class="lineno"> 5045</span>&#160; </div>
<div class="line"><a name="l05046"></a><span class="lineno"> 5046</span>&#160;        location_i = 0; <span class="comment">// start at 0.</span></div>
<div class="line"><a name="l05047"></a><span class="lineno"> 5047</span>&#160;        <span class="keywordflow">if</span> (data_has_been_received)</div>
<div class="line"><a name="l05048"></a><span class="lineno"> 5048</span>&#160;        {</div>
<div class="line"><a name="l05049"></a><span class="lineno"> 5049</span>&#160;          <span class="keywordtype">unsigned</span> receive_column_indices_data_size =</div>
<div class="line"><a name="l05050"></a><span class="lineno"> 5050</span>&#160;            receive_column_indices_data.size();</div>
<div class="line"><a name="l05051"></a><span class="lineno"> 5051</span>&#160;          <span class="keywordflow">while</span> (location_i &lt; receive_column_indices_data_size)</div>
<div class="line"><a name="l05052"></a><span class="lineno"> 5052</span>&#160;          {</div>
<div class="line"><a name="l05053"></a><span class="lineno"> 5053</span>&#160;            <span class="keywordtype">unsigned</span> current_local_eqn =</div>
<div class="line"><a name="l05054"></a><span class="lineno"> 5054</span>&#160;              receive_column_indices_data[location_i++];</div>
<div class="line"><a name="l05055"></a><span class="lineno"> 5055</span>&#160;            <span class="keywordtype">unsigned</span> current_nnz = receive_column_indices_data[location_i++];</div>
<div class="line"><a name="l05056"></a><span class="lineno"> 5056</span>&#160; </div>
<div class="line"><a name="l05057"></a><span class="lineno"> 5057</span>&#160;            <span class="comment">// These comes from other processors.</span></div>
<div class="line"><a name="l05058"></a><span class="lineno"> 5058</span>&#160;            value_column_locations[current_local_eqn][0] = 1;</div>
<div class="line"><a name="l05059"></a><span class="lineno"> 5059</span>&#160; </div>
<div class="line"><a name="l05060"></a><span class="lineno"> 5060</span>&#160;            <span class="comment">// Store the nnz.</span></div>
<div class="line"><a name="l05061"></a><span class="lineno"> 5061</span>&#160;            value_column_locations[current_local_eqn][1] = current_nnz;</div>
<div class="line"><a name="l05062"></a><span class="lineno"> 5062</span>&#160; </div>
<div class="line"><a name="l05063"></a><span class="lineno"> 5063</span>&#160;            <span class="comment">// Also increment the res_local_nnz</span></div>
<div class="line"><a name="l05064"></a><span class="lineno"> 5064</span>&#160;            res_nnz_local += current_nnz;</div>
<div class="line"><a name="l05065"></a><span class="lineno"> 5065</span>&#160; </div>
<div class="line"><a name="l05066"></a><span class="lineno"> 5066</span>&#160;            <span class="comment">// Store the offset.</span></div>
<div class="line"><a name="l05067"></a><span class="lineno"> 5067</span>&#160;            value_column_locations[current_local_eqn][2] = location_i;</div>
<div class="line"><a name="l05068"></a><span class="lineno"> 5068</span>&#160; </div>
<div class="line"><a name="l05069"></a><span class="lineno"> 5069</span>&#160;            <span class="comment">// Update the location_i so it starts at the next row.</span></div>
<div class="line"><a name="l05070"></a><span class="lineno"> 5070</span>&#160;            location_i += current_nnz;</div>
<div class="line"><a name="l05071"></a><span class="lineno"> 5071</span>&#160;          }</div>
<div class="line"><a name="l05072"></a><span class="lineno"> 5072</span>&#160;        }</div>
<div class="line"><a name="l05073"></a><span class="lineno"> 5073</span>&#160; </div>
<div class="line"><a name="l05074"></a><span class="lineno"> 5074</span>&#160;        <span class="keywordflow">if</span> (enable_timing)</div>
<div class="line"><a name="l05075"></a><span class="lineno"> 5075</span>&#160;        {</div>
<div class="line"><a name="l05076"></a><span class="lineno"> 5076</span>&#160;          <span class="keywordtype">double</span> t_locations_finish = <a class="code" href="../../d9/dd8/oomph__metis__from__parmetis__3_81_81_2struct_8h.html#aae821c36bb7e6918e1414484f939c3d4">TimingHelpers::timer</a>();</div>
<div class="line"><a name="l05077"></a><span class="lineno"> 5077</span>&#160;          <span class="keywordtype">double</span> t_locations_time = t_locations_finish - t_locations_start;</div>
<div class="line"><a name="l05078"></a><span class="lineno"> 5078</span>&#160;          <a class="code" href="../../da/ddf/namespaceoomph.html#aec474227917784dc0a255faf289cfc16">oomph_info</a> &lt;&lt; <span class="stringliteral">&quot;t_locations_time: &quot;</span> &lt;&lt; t_locations_time &lt;&lt; std::endl;</div>
<div class="line"><a name="l05079"></a><span class="lineno"> 5079</span>&#160;        }</div>
<div class="line"><a name="l05080"></a><span class="lineno"> 5080</span>&#160; </div>
<div class="line"><a name="l05081"></a><span class="lineno"> 5081</span>&#160;        <span class="keywordtype">double</span> t_fillvecs_start;</div>
<div class="line"><a name="l05082"></a><span class="lineno"> 5082</span>&#160;        <span class="keywordflow">if</span> (enable_timing) t_fillvecs_start = <a class="code" href="../../d9/dd8/oomph__metis__from__parmetis__3_81_81_2struct_8h.html#aae821c36bb7e6918e1414484f939c3d4">TimingHelpers::timer</a>();</div>
<div class="line"><a name="l05083"></a><span class="lineno"> 5083</span>&#160; </div>
<div class="line"><a name="l05084"></a><span class="lineno"> 5084</span>&#160;        <span class="comment">// Now loop through the locations and store the values</span></div>
<div class="line"><a name="l05085"></a><span class="lineno"> 5085</span>&#160;        <span class="comment">// the column indices in the correct order.</span></div>
<div class="line"><a name="l05086"></a><span class="lineno"> 5086</span>&#160;        Vector&lt;int&gt; res_column_indices;</div>
<div class="line"><a name="l05087"></a><span class="lineno"> 5087</span>&#160;        Vector&lt;double&gt; res_values;</div>
<div class="line"><a name="l05088"></a><span class="lineno"> 5088</span>&#160;        Vector&lt;int&gt; res_row_start;</div>
<div class="line"><a name="l05089"></a><span class="lineno"> 5089</span>&#160; </div>
<div class="line"><a name="l05090"></a><span class="lineno"> 5090</span>&#160;        res_column_indices.reserve(res_nnz_local);</div>
<div class="line"><a name="l05091"></a><span class="lineno"> 5091</span>&#160;        res_values.reserve(res_nnz_local);</div>
<div class="line"><a name="l05092"></a><span class="lineno"> 5092</span>&#160;        res_row_start.reserve(res_nrow_local + 1);</div>
<div class="line"><a name="l05093"></a><span class="lineno"> 5093</span>&#160; </div>
<div class="line"><a name="l05094"></a><span class="lineno"> 5094</span>&#160;        <span class="comment">// Running sum of nnz for the row_start. Must be int because</span></div>
<div class="line"><a name="l05095"></a><span class="lineno"> 5095</span>&#160;        <span class="comment">// res_row_start is templated with int.</span></div>
<div class="line"><a name="l05096"></a><span class="lineno"> 5096</span>&#160;        <span class="keywordtype">int</span> nnz_running_sum = 0;</div>
<div class="line"><a name="l05097"></a><span class="lineno"> 5097</span>&#160; </div>
<div class="line"><a name="l05098"></a><span class="lineno"> 5098</span>&#160;        <span class="comment">// Now insert the rows.</span></div>
<div class="line"><a name="l05099"></a><span class="lineno"> 5099</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> local_row_i = 0; local_row_i &lt; res_nrow_local;</div>
<div class="line"><a name="l05100"></a><span class="lineno"> 5100</span>&#160;             local_row_i++)</div>
<div class="line"><a name="l05101"></a><span class="lineno"> 5101</span>&#160;        {</div>
<div class="line"><a name="l05102"></a><span class="lineno"> 5102</span>&#160;          <span class="comment">// Fill the res_row_start with the nnz so far.</span></div>
<div class="line"><a name="l05103"></a><span class="lineno"> 5103</span>&#160;          res_row_start.push_back(nnz_running_sum);</div>
<div class="line"><a name="l05104"></a><span class="lineno"> 5104</span>&#160; </div>
<div class="line"><a name="l05105"></a><span class="lineno"> 5105</span>&#160;          <span class="keywordtype">bool</span> data_is_from_other_proc =</div>
<div class="line"><a name="l05106"></a><span class="lineno"> 5106</span>&#160;            <a class="code" href="../../d9/db9/classbool.html">bool</a>(value_column_locations[local_row_i][0]);</div>
<div class="line"><a name="l05107"></a><span class="lineno"> 5107</span>&#160; </div>
<div class="line"><a name="l05108"></a><span class="lineno"> 5108</span>&#160;          <span class="keywordtype">unsigned</span> row_i_nnz = value_column_locations[local_row_i][1];</div>
<div class="line"><a name="l05109"></a><span class="lineno"> 5109</span>&#160; </div>
<div class="line"><a name="l05110"></a><span class="lineno"> 5110</span>&#160;          <span class="keywordtype">unsigned</span> row_i_offset = value_column_locations[local_row_i][2];</div>
<div class="line"><a name="l05111"></a><span class="lineno"> 5111</span>&#160; </div>
<div class="line"><a name="l05112"></a><span class="lineno"> 5112</span>&#160;          <span class="keywordflow">if</span> (data_is_from_other_proc)</div>
<div class="line"><a name="l05113"></a><span class="lineno"> 5113</span>&#160;          {</div>
<div class="line"><a name="l05114"></a><span class="lineno"> 5114</span>&#160;            <span class="comment">// Insert range [offset, offset+nnz) from</span></div>
<div class="line"><a name="l05115"></a><span class="lineno"> 5115</span>&#160;            <span class="comment">// receive_column_indices_data and receive_values_data into</span></div>
<div class="line"><a name="l05116"></a><span class="lineno"> 5116</span>&#160;            <span class="comment">// res_column_indices and res_values respectively.</span></div>
<div class="line"><a name="l05117"></a><span class="lineno"> 5117</span>&#160;            res_column_indices.insert(</div>
<div class="line"><a name="l05118"></a><span class="lineno"> 5118</span>&#160;              res_column_indices.end(),</div>
<div class="line"><a name="l05119"></a><span class="lineno"> 5119</span>&#160;              receive_column_indices_data.begin() + row_i_offset,</div>
<div class="line"><a name="l05120"></a><span class="lineno"> 5120</span>&#160;              receive_column_indices_data.begin() + row_i_offset + row_i_nnz);</div>
<div class="line"><a name="l05121"></a><span class="lineno"> 5121</span>&#160; </div>
<div class="line"><a name="l05122"></a><span class="lineno"> 5122</span>&#160;            res_values.insert(res_values.end(),</div>
<div class="line"><a name="l05123"></a><span class="lineno"> 5123</span>&#160;                              receive_values_data.begin() + row_i_offset,</div>
<div class="line"><a name="l05124"></a><span class="lineno"> 5124</span>&#160;                              receive_values_data.begin() + row_i_offset +</div>
<div class="line"><a name="l05125"></a><span class="lineno"> 5125</span>&#160;                                row_i_nnz);</div>
<div class="line"><a name="l05126"></a><span class="lineno"> 5126</span>&#160;          }</div>
<div class="line"><a name="l05127"></a><span class="lineno"> 5127</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l05128"></a><span class="lineno"> 5128</span>&#160;          {</div>
<div class="line"><a name="l05129"></a><span class="lineno"> 5129</span>&#160;            res_column_indices.insert(res_column_indices.end(),</div>
<div class="line"><a name="l05130"></a><span class="lineno"> 5130</span>&#160;                                      column_indices_to_send[my_rank].begin() +</div>
<div class="line"><a name="l05131"></a><span class="lineno"> 5131</span>&#160;                                        row_i_offset,</div>
<div class="line"><a name="l05132"></a><span class="lineno"> 5132</span>&#160;                                      column_indices_to_send[my_rank].begin() +</div>
<div class="line"><a name="l05133"></a><span class="lineno"> 5133</span>&#160;                                        row_i_offset + row_i_nnz);</div>
<div class="line"><a name="l05134"></a><span class="lineno"> 5134</span>&#160; </div>
<div class="line"><a name="l05135"></a><span class="lineno"> 5135</span>&#160;            res_values.insert(res_values.end(),</div>
<div class="line"><a name="l05136"></a><span class="lineno"> 5136</span>&#160;                              values_to_send[my_rank].begin() + row_i_offset,</div>
<div class="line"><a name="l05137"></a><span class="lineno"> 5137</span>&#160;                              values_to_send[my_rank].begin() + row_i_offset +</div>
<div class="line"><a name="l05138"></a><span class="lineno"> 5138</span>&#160;                                row_i_nnz);</div>
<div class="line"><a name="l05139"></a><span class="lineno"> 5139</span>&#160;          }</div>
<div class="line"><a name="l05140"></a><span class="lineno"> 5140</span>&#160; </div>
<div class="line"><a name="l05141"></a><span class="lineno"> 5141</span>&#160;          <span class="comment">// Update the running sum of nnz</span></div>
<div class="line"><a name="l05142"></a><span class="lineno"> 5142</span>&#160;          nnz_running_sum += row_i_nnz;</div>
<div class="line"><a name="l05143"></a><span class="lineno"> 5143</span>&#160;        }</div>
<div class="line"><a name="l05144"></a><span class="lineno"> 5144</span>&#160; </div>
<div class="line"><a name="l05145"></a><span class="lineno"> 5145</span>&#160;        <span class="comment">// Insert the last row_start value</span></div>
<div class="line"><a name="l05146"></a><span class="lineno"> 5146</span>&#160;        res_row_start.push_back(res_nnz_local);</div>
<div class="line"><a name="l05147"></a><span class="lineno"> 5147</span>&#160; </div>
<div class="line"><a name="l05148"></a><span class="lineno"> 5148</span>&#160;        <span class="keywordflow">if</span> (enable_timing)</div>
<div class="line"><a name="l05149"></a><span class="lineno"> 5149</span>&#160;        {</div>
<div class="line"><a name="l05150"></a><span class="lineno"> 5150</span>&#160;          <span class="keywordtype">double</span> t_fillvecs_finish = <a class="code" href="../../d9/dd8/oomph__metis__from__parmetis__3_81_81_2struct_8h.html#aae821c36bb7e6918e1414484f939c3d4">TimingHelpers::timer</a>();</div>
<div class="line"><a name="l05151"></a><span class="lineno"> 5151</span>&#160;          <span class="keywordtype">double</span> t_fillvecs_time = t_fillvecs_finish - t_fillvecs_start;</div>
<div class="line"><a name="l05152"></a><span class="lineno"> 5152</span>&#160;          <a class="code" href="../../da/ddf/namespaceoomph.html#aec474227917784dc0a255faf289cfc16">oomph_info</a> &lt;&lt; <span class="stringliteral">&quot;t_fillvecs_time: &quot;</span> &lt;&lt; t_fillvecs_time &lt;&lt; std::endl;</div>
<div class="line"><a name="l05153"></a><span class="lineno"> 5153</span>&#160;        }</div>
<div class="line"><a name="l05154"></a><span class="lineno"> 5154</span>&#160; </div>
<div class="line"><a name="l05155"></a><span class="lineno"> 5155</span>&#160;        <span class="keywordtype">double</span> t_buildres_start;</div>
<div class="line"><a name="l05156"></a><span class="lineno"> 5156</span>&#160;        <span class="keywordflow">if</span> (enable_timing) t_buildres_start = <a class="code" href="../../d9/dd8/oomph__metis__from__parmetis__3_81_81_2struct_8h.html#aae821c36bb7e6918e1414484f939c3d4">TimingHelpers::timer</a>();</div>
<div class="line"><a name="l05157"></a><span class="lineno"> 5157</span>&#160; </div>
<div class="line"><a name="l05158"></a><span class="lineno"> 5158</span>&#160;        <span class="comment">// build the matrix.</span></div>
<div class="line"><a name="l05159"></a><span class="lineno"> 5159</span>&#160;        result_matrix.build(</div>
<div class="line"><a name="l05160"></a><span class="lineno"> 5160</span>&#160;          res_ncol, res_values, res_column_indices, res_row_start);</div>
<div class="line"><a name="l05161"></a><span class="lineno"> 5161</span>&#160; </div>
<div class="line"><a name="l05162"></a><span class="lineno"> 5162</span>&#160;        <span class="keywordflow">if</span> (enable_timing)</div>
<div class="line"><a name="l05163"></a><span class="lineno"> 5163</span>&#160;        {</div>
<div class="line"><a name="l05164"></a><span class="lineno"> 5164</span>&#160;          <span class="keywordtype">double</span> t_buildres_finish = <a class="code" href="../../d9/dd8/oomph__metis__from__parmetis__3_81_81_2struct_8h.html#aae821c36bb7e6918e1414484f939c3d4">TimingHelpers::timer</a>();</div>
<div class="line"><a name="l05165"></a><span class="lineno"> 5165</span>&#160;          <span class="keywordtype">double</span> t_buildres_time = t_buildres_finish - t_buildres_start;</div>
<div class="line"><a name="l05166"></a><span class="lineno"> 5166</span>&#160;          <a class="code" href="../../da/ddf/namespaceoomph.html#aec474227917784dc0a255faf289cfc16">oomph_info</a> &lt;&lt; <span class="stringliteral">&quot;t_buildres_time: &quot;</span> &lt;&lt; t_buildres_time &lt;&lt; std::endl;</div>
<div class="line"><a name="l05167"></a><span class="lineno"> 5167</span>&#160;        }</div>
<div class="line"><a name="l05168"></a><span class="lineno"> 5168</span>&#160;        <span class="comment">//  */</span></div>
<div class="line"><a name="l05169"></a><span class="lineno"> 5169</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l05170"></a><span class="lineno"> 5170</span>&#160;      }</div>
<div class="line"><a name="l05171"></a><span class="lineno"> 5171</span>&#160;    }</div>
<div class="ttc" id="aclassbool_html"><div class="ttname"><a href="../../d9/db9/classbool.html">bool</a></div></div>
<div class="ttc" id="anamespaceoomph_html_aec474227917784dc0a255faf289cfc16"><div class="ttname"><a href="../../da/ddf/namespaceoomph.html#aec474227917784dc0a255faf289cfc16">oomph::oomph_info</a></div><div class="ttdeci">OomphInfo oomph_info</div><div class="ttdef"><b>Definition:</b> oomph_definitions.cc:319</div></div>
<div class="ttc" id="aoomph__definitions_8h_html_a25c6813cc7341d125e2502f8923fb6c4"><div class="ttname"><a href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a></div><div class="ttdeci">#define OOMPH_EXCEPTION_LOCATION</div><div class="ttdef"><b>Definition:</b> oomph_definitions.h:61</div></div>
<div class="ttc" id="aoomph__definitions_8h_html_aa260cc4af589e30cea7fde997ae16667"><div class="ttname"><a href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a></div><div class="ttdeci">#define OOMPH_CURRENT_FUNCTION</div><div class="ttdef"><b>Definition:</b> oomph_definitions.h:86</div></div>
<div class="ttc" id="aoomph__metis__from__parmetis__3_81_81_2struct_8h_html_aae821c36bb7e6918e1414484f939c3d4"><div class="ttname"><a href="../../d9/dd8/oomph__metis__from__parmetis__3_81_81_2struct_8h.html#aae821c36bb7e6918e1414484f939c3d4">timer</a></div><div class="ttdeci">double timer</div><div class="ttdef"><b>Definition:</b> oomph_metis_from_parmetis_3.1.1/struct.h:210</div></div>
<div class="ttc" id="atut__arithmetic__redux__minmax_8cpp_html_a39513f0f8d942bf9ef17b2e87ac6d34e"><div class="ttname"><a href="../../da/dd4/tut__arithmetic__redux__minmax_8cpp.html#a39513f0f8d942bf9ef17b2e87ac6d34e">j</a></div><div class="ttdeci">std::ptrdiff_t j</div><div class="ttdef"><b>Definition:</b> tut_arithmetic_redux_minmax.cpp:2</div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html#af44bac2acd071317f96dae49cbb0d977">oomph::CRDoubleMatrix::build()</a>, <a class="el" href="../../de/dcb/classoomph_1_1LinearAlgebraDistribution.html#a92bfff97fd228b9c528922c39ab563b2">oomph::LinearAlgebraDistribution::built()</a>, <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html#a21b3dbb8ee74e1247f80ce4506c395f8">oomph::CRDoubleMatrix::column_index()</a>, <a class="el" href="../../de/dcb/classoomph_1_1LinearAlgebraDistribution.html#a2e4736826a65253f574d4f6f152ab514">oomph::LinearAlgebraDistribution::communicator_pt()</a>, <a class="el" href="../../df/d1e/classoomph_1_1DistributableLinearAlgebraObject.html#a5505731e7e73d7e4251c67c7adec6bf5">oomph::DistributableLinearAlgebraObject::distributed()</a>, <a class="el" href="../../df/d1e/classoomph_1_1DistributableLinearAlgebraObject.html#a603105384d60c9a3710378af39f538b9">oomph::DistributableLinearAlgebraObject::distribution_pt()</a>, <a class="el" href="../../de/dcb/classoomph_1_1LinearAlgebraDistribution.html#a2634e540a78fe1ee3f5c907aff500b58">oomph::LinearAlgebraDistribution::first_row()</a>, <a class="el" href="../../da/dd4/tut__arithmetic__redux__minmax_8cpp.html#a39513f0f8d942bf9ef17b2e87ac6d34e">j</a>, <a class="el" href="../../de/d83/classoomph_1_1OomphCommunicator.html#a670b34aab05bfe0b96d0e0fabf583c7a">oomph::OomphCommunicator::my_rank()</a>, <a class="el" href="../../d6/d13/classoomph_1_1DenseMatrix.html#a9937181f1cb4cfaed7aaf3b483c42456">oomph::DenseMatrix&lt; T &gt;::ncol()</a>, <a class="el" href="../../de/d83/classoomph_1_1OomphCommunicator.html#a6c78c72666f4b102c2bccf200f0853b7">oomph::OomphCommunicator::nproc()</a>, <a class="el" href="../../d6/d13/classoomph_1_1DenseMatrix.html#a1b425094510d833ffe91920747a0a962">oomph::DenseMatrix&lt; T &gt;::nrow()</a>, <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html#abd8d231b0549540144b4739a667b1e75">oomph::CRDoubleMatrix::nrow()</a>, <a class="el" href="../../de/dcb/classoomph_1_1LinearAlgebraDistribution.html#ac9310de740f9c3a61f8d5dab9bef88ca">oomph::LinearAlgebraDistribution::nrow_local()</a>, <a class="el" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>, <a class="el" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>, <a class="el" href="../../da/ddf/namespaceoomph.html#aec474227917784dc0a255faf289cfc16">oomph::oomph_info</a>, <a class="el" href="../../de/dcb/classoomph_1_1LinearAlgebraDistribution.html#acd5ffc5ff4b91a8e63677f9677cd0039">oomph::LinearAlgebraDistribution::rank_of_global_row()</a>, <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html#a25f1efd00318183abd8c65efede3f3f4">oomph::CRDoubleMatrix::row_start()</a>, <a class="el" href="../../de/dfb/namespaceoomph_1_1TimingHelpers.html#a9fb6ad7e2e01b0914e9f7072ef9ebfa6">oomph::TimingHelpers::timer()</a>, and <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html#ab8220b7c2bb763dab32a4d0fea7da6f4">oomph::CRDoubleMatrix::value()</a>.</p>

<p class="reference">Referenced by <a class="el" href="../../d6/d74/matrix__concatenation_8cc.html#a0ddf1224851353fc92bfbff6f499fa97">main()</a>, and <a class="el" href="../../da/da7/classoomph_1_1SpaceTimeNavierStokesSubsidiaryPreconditioner.html#a416c107b8095d5083b7a84775bae9881">oomph::SpaceTimeNavierStokesSubsidiaryPreconditioner::setup()</a>.</p>

</div>
</div>
<a id="ac04e094c973da752da4b76071ad09f44"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac04e094c973da752da4b76071ad09f44">&#9670;&nbsp;</a></span>concatenate_without_communication() <span class="overload">[1/2]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void oomph::CRDoubleMatrixHelpers::concatenate_without_communication </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="../../d4/df6/classoomph_1_1Vector.html">Vector</a>&lt; <a class="el" href="../../de/dcb/classoomph_1_1LinearAlgebraDistribution.html">LinearAlgebraDistribution</a> * &gt; &amp;&#160;</td>
          <td class="paramname"><em>block_distribution_pt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="../../d6/d13/classoomph_1_1DenseMatrix.html">DenseMatrix</a>&lt; <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html">CRDoubleMatrix</a> * &gt; &amp;&#160;</td>
          <td class="paramname"><em>matrix_pt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html">CRDoubleMatrix</a> &amp;&#160;</td>
          <td class="paramname"><em>result_matrix</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Concatenate CRDoubleMatrix matrices. This calls the other concatenate_without_communication(...) function, passing block_distribution_pt as both the row_distribution_pt and col_distribution_pt. This should only be called for block square matrices. </p>
<div class="fragment"><div class="line"><a name="l05889"></a><span class="lineno"> 5889</span>&#160;    {</div>
<div class="line"><a name="l05890"></a><span class="lineno"> 5890</span>&#160;<span class="preprocessor">#ifdef PARANOID</span></div>
<div class="line"><a name="l05891"></a><span class="lineno"> 5891</span>&#160;      <span class="comment">// The number of block rows and block columns.</span></div>
<div class="line"><a name="l05892"></a><span class="lineno"> 5892</span>&#160;      <span class="keywordtype">unsigned</span> matrix_nrow = matrix_pt.nrow();</div>
<div class="line"><a name="l05893"></a><span class="lineno"> 5893</span>&#160;      <span class="keywordtype">unsigned</span> matrix_ncol = matrix_pt.ncol();</div>
<div class="line"><a name="l05894"></a><span class="lineno"> 5894</span>&#160; </div>
<div class="line"><a name="l05895"></a><span class="lineno"> 5895</span>&#160;      <span class="comment">// Are there matrices to concatenate?</span></div>
<div class="line"><a name="l05896"></a><span class="lineno"> 5896</span>&#160;      <span class="keywordflow">if</span> (matrix_nrow == 0)</div>
<div class="line"><a name="l05897"></a><span class="lineno"> 5897</span>&#160;      {</div>
<div class="line"><a name="l05898"></a><span class="lineno"> 5898</span>&#160;        std::ostringstream error_message;</div>
<div class="line"><a name="l05899"></a><span class="lineno"> 5899</span>&#160;        error_message &lt;&lt; <span class="stringliteral">&quot;There are no matrices to concatenate.\n&quot;</span>;</div>
<div class="line"><a name="l05900"></a><span class="lineno"> 5900</span>&#160;        <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l05901"></a><span class="lineno"> 5901</span>&#160;                            <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l05902"></a><span class="lineno"> 5902</span>&#160;                            <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l05903"></a><span class="lineno"> 5903</span>&#160;      }</div>
<div class="line"><a name="l05904"></a><span class="lineno"> 5904</span>&#160; </div>
<div class="line"><a name="l05905"></a><span class="lineno"> 5905</span>&#160;      <span class="comment">// Ensure that the sub matrices is a square block matrix.</span></div>
<div class="line"><a name="l05906"></a><span class="lineno"> 5906</span>&#160;      <span class="keywordflow">if</span> (matrix_nrow != matrix_ncol)</div>
<div class="line"><a name="l05907"></a><span class="lineno"> 5907</span>&#160;      {</div>
<div class="line"><a name="l05908"></a><span class="lineno"> 5908</span>&#160;        std::ostringstream error_message;</div>
<div class="line"><a name="l05909"></a><span class="lineno"> 5909</span>&#160;        error_message</div>
<div class="line"><a name="l05910"></a><span class="lineno"> 5910</span>&#160;          &lt;&lt; <span class="stringliteral">&quot;The number of block rows and block columns\n&quot;</span></div>
<div class="line"><a name="l05911"></a><span class="lineno"> 5911</span>&#160;          &lt;&lt; <span class="stringliteral">&quot;must be the same. Otherwise, call the other\n&quot;</span></div>
<div class="line"><a name="l05912"></a><span class="lineno"> 5912</span>&#160;          &lt;&lt; <span class="stringliteral">&quot;concatenate_without_communication function, passing in\n&quot;</span></div>
<div class="line"><a name="l05913"></a><span class="lineno"> 5913</span>&#160;          &lt;&lt; <span class="stringliteral">&quot;a Vector of distributions describing how to permute the\n&quot;</span></div>
<div class="line"><a name="l05914"></a><span class="lineno"> 5914</span>&#160;          &lt;&lt; <span class="stringliteral">&quot;columns.&quot;</span>;</div>
<div class="line"><a name="l05915"></a><span class="lineno"> 5915</span>&#160;        <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l05916"></a><span class="lineno"> 5916</span>&#160;                            <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l05917"></a><span class="lineno"> 5917</span>&#160;                            <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l05918"></a><span class="lineno"> 5918</span>&#160;      }</div>
<div class="line"><a name="l05919"></a><span class="lineno"> 5919</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l05920"></a><span class="lineno"> 5920</span>&#160; </div>
<div class="line"><a name="l05921"></a><span class="lineno"> 5921</span>&#160;      <a class="code" href="../../dd/d95/namespaceoomph_1_1CRDoubleMatrixHelpers.html#ac04e094c973da752da4b76071ad09f44">concatenate_without_communication</a>(</div>
<div class="line"><a name="l05922"></a><span class="lineno"> 5922</span>&#160;        block_distribution_pt, block_distribution_pt, matrix_pt, result_matrix);</div>
<div class="line"><a name="l05923"></a><span class="lineno"> 5923</span>&#160;    }</div>
<div class="ttc" id="anamespaceoomph_1_1CRDoubleMatrixHelpers_html_ac04e094c973da752da4b76071ad09f44"><div class="ttname"><a href="../../dd/d95/namespaceoomph_1_1CRDoubleMatrixHelpers.html#ac04e094c973da752da4b76071ad09f44">oomph::CRDoubleMatrixHelpers::concatenate_without_communication</a></div><div class="ttdeci">void concatenate_without_communication(const Vector&lt; LinearAlgebraDistribution * &gt; &amp;block_distribution_pt, const DenseMatrix&lt; CRDoubleMatrix * &gt; &amp;matrix_pt, CRDoubleMatrix &amp;result_matrix)</div><div class="ttdef"><b>Definition:</b> matrices.cc:5885</div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="../../dd/d95/namespaceoomph_1_1CRDoubleMatrixHelpers.html#a996568831ca0db90f080560dd400b3d6">concatenate_without_communication()</a>, <a class="el" href="../../d6/d13/classoomph_1_1DenseMatrix.html#a9937181f1cb4cfaed7aaf3b483c42456">oomph::DenseMatrix&lt; T &gt;::ncol()</a>, <a class="el" href="../../d6/d13/classoomph_1_1DenseMatrix.html#a1b425094510d833ffe91920747a0a962">oomph::DenseMatrix&lt; T &gt;::nrow()</a>, <a class="el" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>, and <a class="el" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>.</p>

</div>
</div>
<a id="a996568831ca0db90f080560dd400b3d6"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a996568831ca0db90f080560dd400b3d6">&#9670;&nbsp;</a></span>concatenate_without_communication() <span class="overload">[2/2]</span></h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void oomph::CRDoubleMatrixHelpers::concatenate_without_communication </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="../../d4/df6/classoomph_1_1Vector.html">Vector</a>&lt; <a class="el" href="../../de/dcb/classoomph_1_1LinearAlgebraDistribution.html">LinearAlgebraDistribution</a> * &gt; &amp;&#160;</td>
          <td class="paramname"><em>row_distribution_pt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="../../d4/df6/classoomph_1_1Vector.html">Vector</a>&lt; <a class="el" href="../../de/dcb/classoomph_1_1LinearAlgebraDistribution.html">LinearAlgebraDistribution</a> * &gt; &amp;&#160;</td>
          <td class="paramname"><em>col_distribution_pt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="../../d6/d13/classoomph_1_1DenseMatrix.html">DenseMatrix</a>&lt; <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html">CRDoubleMatrix</a> * &gt; &amp;&#160;</td>
          <td class="paramname"><em>matrix_pt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html">CRDoubleMatrix</a> &amp;&#160;</td>
          <td class="paramname"><em>result_matrix</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Concatenate CRDoubleMatrix matrices.</p>
<p>The Vector row_distribution_pt contains the LinearAlgebraDistribution of each block row. The Vector col_distribution_pt contains the LinearAlgebraDistribution of each block column. The DenseMatrix matrix_pt contains pointers to the CRDoubleMatrices to concatenate. The CRDoubleMatrix result_matrix is the result matrix.</p>
<p>The result matrix is a permutation of the sub matrices such that the data stays on the same processor when the result matrix is built, there is no communication between processors. Thus the block structure of the sub matrices are NOT preserved in the result matrix. The rows are block-permuted, defined by the concatenation of the distributions in row_distribution_pt. Similarly, the columns are block-permuted, defined by the concatenation of the distributions in col_distribution_pt. For more details on the block-permutation, see LinearAlgebraDistributionHelpers::concatenate(...).</p>
<p>If one wishes to preserve the block structure of the sub matrices in the result matrix, consider using CRDoubleMatrixHelpers::concatenate(...), which uses communication between processors to ensure that the block structure of the sub matrices are preserved.</p>
<p>The matrix manipulation functions CRDoubleMatrixHelpers::concatenate(...) and CRDoubleMatrixHelpers::concatenate_without_communication(...) are analogous to the Vector manipulation functions DoubleVectorHelpers::concatenate(...) and DoubleVectorHelpers::concatenate_without_communication(...). Please look at the DoubleVector functions for an illustration of the differences between concatenate(...) and concatenate_without_communication(...).</p>
<p>Distribution of the result matrix: If the result matrix does not have a distribution built, then it will be given a distribution built from the concatenation of the distributions from row_distribution_pt, see LinearAlgebraDistributionHelpers::concatenate(...) for more detail. Otherwise we use the existing distribution. If there is an existing distribution then it must be the same as the distribution from the concatenation of row distributions as described above. Why don't we always compute the distribution "on the fly"? Because a non-uniform distribution requires communication. All block preconditioner distributions are concatenations of the distributions of the individual blocks. </p>
<p>/////////////// END OF PARANOID TESTS ////////////////////////////////////</p>
<div class="fragment"><div class="line"><a name="l05228"></a><span class="lineno"> 5228</span>&#160;    {</div>
<div class="line"><a name="l05229"></a><span class="lineno"> 5229</span>&#160;      <span class="comment">// The number of block rows and block columns.</span></div>
<div class="line"><a name="l05230"></a><span class="lineno"> 5230</span>&#160;      <span class="keywordtype">unsigned</span> matrix_nrow = matrix_pt.nrow();</div>
<div class="line"><a name="l05231"></a><span class="lineno"> 5231</span>&#160;      <span class="keywordtype">unsigned</span> matrix_ncol = matrix_pt.ncol();</div>
<div class="line"><a name="l05232"></a><span class="lineno"> 5232</span>&#160; </div>
<div class="line"><a name="l05233"></a><span class="lineno"> 5233</span>&#160;      <span class="comment">// PARANOID checks involving in matrices and block_distribution only.</span></div>
<div class="line"><a name="l05234"></a><span class="lineno"> 5234</span>&#160;      <span class="comment">// PARANOID checks involving the result matrix will come later since</span></div>
<div class="line"><a name="l05235"></a><span class="lineno"> 5235</span>&#160;      <span class="comment">// we have to create the result matrix distribution from the in</span></div>
<div class="line"><a name="l05236"></a><span class="lineno"> 5236</span>&#160;      <span class="comment">// distribution if it does not already exist.</span></div>
<div class="line"><a name="l05237"></a><span class="lineno"> 5237</span>&#160;<span class="preprocessor">#ifdef PARANOID</span></div>
<div class="line"><a name="l05238"></a><span class="lineno"> 5238</span>&#160; </div>
<div class="line"><a name="l05239"></a><span class="lineno"> 5239</span>&#160;      <span class="comment">// Are there matrices to concatenate?</span></div>
<div class="line"><a name="l05240"></a><span class="lineno"> 5240</span>&#160;      <span class="keywordflow">if</span> (matrix_nrow == 0 || matrix_ncol == 0)</div>
<div class="line"><a name="l05241"></a><span class="lineno"> 5241</span>&#160;      {</div>
<div class="line"><a name="l05242"></a><span class="lineno"> 5242</span>&#160;        std::ostringstream error_message;</div>
<div class="line"><a name="l05243"></a><span class="lineno"> 5243</span>&#160;        error_message &lt;&lt; <span class="stringliteral">&quot;There are no matrices to concatenate.\n&quot;</span>;</div>
<div class="line"><a name="l05244"></a><span class="lineno"> 5244</span>&#160;        <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l05245"></a><span class="lineno"> 5245</span>&#160;                            <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l05246"></a><span class="lineno"> 5246</span>&#160;                            <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l05247"></a><span class="lineno"> 5247</span>&#160;      }</div>
<div class="line"><a name="l05248"></a><span class="lineno"> 5248</span>&#160; </div>
<div class="line"><a name="l05249"></a><span class="lineno"> 5249</span>&#160;      <span class="comment">// Does this matrix need concatenating?</span></div>
<div class="line"><a name="l05250"></a><span class="lineno"> 5250</span>&#160;      <span class="keywordflow">if</span> ((matrix_nrow == 1) &amp;&amp; (matrix_ncol == 1))</div>
<div class="line"><a name="l05251"></a><span class="lineno"> 5251</span>&#160;      {</div>
<div class="line"><a name="l05252"></a><span class="lineno"> 5252</span>&#160;        std::ostringstream warning_message;</div>
<div class="line"><a name="l05253"></a><span class="lineno"> 5253</span>&#160;        warning_message &lt;&lt; <span class="stringliteral">&quot;There is only one matrix to concatenate...\n&quot;</span></div>
<div class="line"><a name="l05254"></a><span class="lineno"> 5254</span>&#160;                        &lt;&lt; <span class="stringliteral">&quot;This does not require concatenating...\n&quot;</span>;</div>
<div class="line"><a name="l05255"></a><span class="lineno"> 5255</span>&#160;        OomphLibWarning(warning_message.str(),</div>
<div class="line"><a name="l05256"></a><span class="lineno"> 5256</span>&#160;                        <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l05257"></a><span class="lineno"> 5257</span>&#160;                        <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l05258"></a><span class="lineno"> 5258</span>&#160;      }</div>
<div class="line"><a name="l05259"></a><span class="lineno"> 5259</span>&#160; </div>
<div class="line"><a name="l05260"></a><span class="lineno"> 5260</span>&#160; </div>
<div class="line"><a name="l05261"></a><span class="lineno"> 5261</span>&#160;      <span class="comment">// The distribution for each block row is stored in row_distribution_pt.</span></div>
<div class="line"><a name="l05262"></a><span class="lineno"> 5262</span>&#160;      <span class="comment">// So the number of distributions in row_distribution_pt must be the</span></div>
<div class="line"><a name="l05263"></a><span class="lineno"> 5263</span>&#160;      <span class="comment">// same as matrix_nrow.</span></div>
<div class="line"><a name="l05264"></a><span class="lineno"> 5264</span>&#160;      <span class="keywordflow">if</span> (matrix_nrow != row_distribution_pt.size())</div>
<div class="line"><a name="l05265"></a><span class="lineno"> 5265</span>&#160;      {</div>
<div class="line"><a name="l05266"></a><span class="lineno"> 5266</span>&#160;        std::ostringstream error_message;</div>
<div class="line"><a name="l05267"></a><span class="lineno"> 5267</span>&#160;        error_message &lt;&lt; <span class="stringliteral">&quot;The number of row distributions must be the same as\n&quot;</span></div>
<div class="line"><a name="l05268"></a><span class="lineno"> 5268</span>&#160;                      &lt;&lt; <span class="stringliteral">&quot;the number of block rows.&quot;</span>;</div>
<div class="line"><a name="l05269"></a><span class="lineno"> 5269</span>&#160;        <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l05270"></a><span class="lineno"> 5270</span>&#160;                            <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l05271"></a><span class="lineno"> 5271</span>&#160;                            <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l05272"></a><span class="lineno"> 5272</span>&#160;      }</div>
<div class="line"><a name="l05273"></a><span class="lineno"> 5273</span>&#160; </div>
<div class="line"><a name="l05274"></a><span class="lineno"> 5274</span>&#160;      <span class="comment">// The number of distributions for the columns must match the number of</span></div>
<div class="line"><a name="l05275"></a><span class="lineno"> 5275</span>&#160;      <span class="comment">// block columns.</span></div>
<div class="line"><a name="l05276"></a><span class="lineno"> 5276</span>&#160;      <span class="keywordflow">if</span> (matrix_ncol != col_distribution_pt.size())</div>
<div class="line"><a name="l05277"></a><span class="lineno"> 5277</span>&#160;      {</div>
<div class="line"><a name="l05278"></a><span class="lineno"> 5278</span>&#160;        std::ostringstream error_message;</div>
<div class="line"><a name="l05279"></a><span class="lineno"> 5279</span>&#160;        error_message</div>
<div class="line"><a name="l05280"></a><span class="lineno"> 5280</span>&#160;          &lt;&lt; <span class="stringliteral">&quot;The number of column distributions must be the same as\n&quot;</span></div>
<div class="line"><a name="l05281"></a><span class="lineno"> 5281</span>&#160;          &lt;&lt; <span class="stringliteral">&quot;the number of block columns.&quot;</span>;</div>
<div class="line"><a name="l05282"></a><span class="lineno"> 5282</span>&#160;        <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l05283"></a><span class="lineno"> 5283</span>&#160;                            <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l05284"></a><span class="lineno"> 5284</span>&#160;                            <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l05285"></a><span class="lineno"> 5285</span>&#160;      }</div>
<div class="line"><a name="l05286"></a><span class="lineno"> 5286</span>&#160; </div>
<div class="line"><a name="l05287"></a><span class="lineno"> 5287</span>&#160;      <span class="comment">// Check that all pointers in row_distribution_pt is not null.</span></div>
<div class="line"><a name="l05288"></a><span class="lineno"> 5288</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 0; block_row_i &lt; matrix_nrow; block_row_i++)</div>
<div class="line"><a name="l05289"></a><span class="lineno"> 5289</span>&#160;      {</div>
<div class="line"><a name="l05290"></a><span class="lineno"> 5290</span>&#160;        <span class="keywordflow">if</span> (row_distribution_pt[block_row_i] == 0)</div>
<div class="line"><a name="l05291"></a><span class="lineno"> 5291</span>&#160;        {</div>
<div class="line"><a name="l05292"></a><span class="lineno"> 5292</span>&#160;          std::ostringstream error_message;</div>
<div class="line"><a name="l05293"></a><span class="lineno"> 5293</span>&#160;          error_message &lt;&lt; <span class="stringliteral">&quot;The row distribution pointer in position &quot;</span></div>
<div class="line"><a name="l05294"></a><span class="lineno"> 5294</span>&#160;                        &lt;&lt; block_row_i &lt;&lt; <span class="stringliteral">&quot; is null.\n&quot;</span>;</div>
<div class="line"><a name="l05295"></a><span class="lineno"> 5295</span>&#160;          <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l05296"></a><span class="lineno"> 5296</span>&#160;                              <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l05297"></a><span class="lineno"> 5297</span>&#160;                              <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l05298"></a><span class="lineno"> 5298</span>&#160;        }</div>
<div class="line"><a name="l05299"></a><span class="lineno"> 5299</span>&#160;      }</div>
<div class="line"><a name="l05300"></a><span class="lineno"> 5300</span>&#160; </div>
<div class="line"><a name="l05301"></a><span class="lineno"> 5301</span>&#160;      <span class="comment">// Check that all pointers in row_distribution_pt is not null.</span></div>
<div class="line"><a name="l05302"></a><span class="lineno"> 5302</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 0; block_col_i &lt; matrix_ncol; block_col_i++)</div>
<div class="line"><a name="l05303"></a><span class="lineno"> 5303</span>&#160;      {</div>
<div class="line"><a name="l05304"></a><span class="lineno"> 5304</span>&#160;        <span class="keywordflow">if</span> (col_distribution_pt[block_col_i] == 0)</div>
<div class="line"><a name="l05305"></a><span class="lineno"> 5305</span>&#160;        {</div>
<div class="line"><a name="l05306"></a><span class="lineno"> 5306</span>&#160;          std::ostringstream error_message;</div>
<div class="line"><a name="l05307"></a><span class="lineno"> 5307</span>&#160;          error_message &lt;&lt; <span class="stringliteral">&quot;The column distribution pointer in position &quot;</span></div>
<div class="line"><a name="l05308"></a><span class="lineno"> 5308</span>&#160;                        &lt;&lt; block_col_i &lt;&lt; <span class="stringliteral">&quot; is null.\n&quot;</span>;</div>
<div class="line"><a name="l05309"></a><span class="lineno"> 5309</span>&#160;          <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l05310"></a><span class="lineno"> 5310</span>&#160;                              <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l05311"></a><span class="lineno"> 5311</span>&#160;                              <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l05312"></a><span class="lineno"> 5312</span>&#160;        }</div>
<div class="line"><a name="l05313"></a><span class="lineno"> 5313</span>&#160;      }</div>
<div class="line"><a name="l05314"></a><span class="lineno"> 5314</span>&#160; </div>
<div class="line"><a name="l05315"></a><span class="lineno"> 5315</span>&#160;      <span class="comment">// Check that all distributions are built.</span></div>
<div class="line"><a name="l05316"></a><span class="lineno"> 5316</span>&#160;      <span class="comment">// First the row distributions</span></div>
<div class="line"><a name="l05317"></a><span class="lineno"> 5317</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 0; block_row_i &lt; matrix_nrow; block_row_i++)</div>
<div class="line"><a name="l05318"></a><span class="lineno"> 5318</span>&#160;      {</div>
<div class="line"><a name="l05319"></a><span class="lineno"> 5319</span>&#160;        <span class="keywordflow">if</span> (!row_distribution_pt[block_row_i]-&gt;built())</div>
<div class="line"><a name="l05320"></a><span class="lineno"> 5320</span>&#160;        {</div>
<div class="line"><a name="l05321"></a><span class="lineno"> 5321</span>&#160;          std::ostringstream error_message;</div>
<div class="line"><a name="l05322"></a><span class="lineno"> 5322</span>&#160;          error_message &lt;&lt; <span class="stringliteral">&quot;The distribution pointer in position &quot;</span></div>
<div class="line"><a name="l05323"></a><span class="lineno"> 5323</span>&#160;                        &lt;&lt; block_row_i &lt;&lt; <span class="stringliteral">&quot; is not built.\n&quot;</span>;</div>
<div class="line"><a name="l05324"></a><span class="lineno"> 5324</span>&#160;          <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l05325"></a><span class="lineno"> 5325</span>&#160;                              <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l05326"></a><span class="lineno"> 5326</span>&#160;                              <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l05327"></a><span class="lineno"> 5327</span>&#160;        }</div>
<div class="line"><a name="l05328"></a><span class="lineno"> 5328</span>&#160;      }</div>
<div class="line"><a name="l05329"></a><span class="lineno"> 5329</span>&#160;      <span class="comment">// Now the column distributions</span></div>
<div class="line"><a name="l05330"></a><span class="lineno"> 5330</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 0; block_col_i &lt; matrix_ncol; block_col_i++)</div>
<div class="line"><a name="l05331"></a><span class="lineno"> 5331</span>&#160;      {</div>
<div class="line"><a name="l05332"></a><span class="lineno"> 5332</span>&#160;        <span class="keywordflow">if</span> (!col_distribution_pt[block_col_i]-&gt;built())</div>
<div class="line"><a name="l05333"></a><span class="lineno"> 5333</span>&#160;        {</div>
<div class="line"><a name="l05334"></a><span class="lineno"> 5334</span>&#160;          std::ostringstream error_message;</div>
<div class="line"><a name="l05335"></a><span class="lineno"> 5335</span>&#160;          error_message &lt;&lt; <span class="stringliteral">&quot;The distribution pointer in position &quot;</span></div>
<div class="line"><a name="l05336"></a><span class="lineno"> 5336</span>&#160;                        &lt;&lt; block_col_i &lt;&lt; <span class="stringliteral">&quot; is not built.\n&quot;</span>;</div>
<div class="line"><a name="l05337"></a><span class="lineno"> 5337</span>&#160;          <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l05338"></a><span class="lineno"> 5338</span>&#160;                              <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l05339"></a><span class="lineno"> 5339</span>&#160;                              <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l05340"></a><span class="lineno"> 5340</span>&#160;        }</div>
<div class="line"><a name="l05341"></a><span class="lineno"> 5341</span>&#160;      }</div>
<div class="line"><a name="l05342"></a><span class="lineno"> 5342</span>&#160; </div>
<div class="line"><a name="l05343"></a><span class="lineno"> 5343</span>&#160;      <span class="comment">// Check that all communicators in row_distribution_pt are the same.</span></div>
<div class="line"><a name="l05344"></a><span class="lineno"> 5344</span>&#160;      <span class="keyword">const</span> OomphCommunicator first_row_comm =</div>
<div class="line"><a name="l05345"></a><span class="lineno"> 5345</span>&#160;        *(row_distribution_pt[0]-&gt;communicator_pt());</div>
<div class="line"><a name="l05346"></a><span class="lineno"> 5346</span>&#160; </div>
<div class="line"><a name="l05347"></a><span class="lineno"> 5347</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 1; block_row_i &lt; matrix_nrow; block_row_i++)</div>
<div class="line"><a name="l05348"></a><span class="lineno"> 5348</span>&#160;      {</div>
<div class="line"><a name="l05349"></a><span class="lineno"> 5349</span>&#160;        <span class="keyword">const</span> OomphCommunicator current_comm =</div>
<div class="line"><a name="l05350"></a><span class="lineno"> 5350</span>&#160;          *(row_distribution_pt[block_row_i]-&gt;communicator_pt());</div>
<div class="line"><a name="l05351"></a><span class="lineno"> 5351</span>&#160; </div>
<div class="line"><a name="l05352"></a><span class="lineno"> 5352</span>&#160;        <span class="keywordflow">if</span> (first_row_comm != current_comm)</div>
<div class="line"><a name="l05353"></a><span class="lineno"> 5353</span>&#160;        {</div>
<div class="line"><a name="l05354"></a><span class="lineno"> 5354</span>&#160;          std::ostringstream error_message;</div>
<div class="line"><a name="l05355"></a><span class="lineno"> 5355</span>&#160;          error_message</div>
<div class="line"><a name="l05356"></a><span class="lineno"> 5356</span>&#160;            &lt;&lt; <span class="stringliteral">&quot;The communicator from the row distribution in position &quot;</span></div>
<div class="line"><a name="l05357"></a><span class="lineno"> 5357</span>&#160;            &lt;&lt; block_row_i &lt;&lt; <span class="stringliteral">&quot; is not the same as the first &quot;</span></div>
<div class="line"><a name="l05358"></a><span class="lineno"> 5358</span>&#160;            &lt;&lt; <span class="stringliteral">&quot;communicator from row_distribution_pt&quot;</span>;</div>
<div class="line"><a name="l05359"></a><span class="lineno"> 5359</span>&#160;          <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l05360"></a><span class="lineno"> 5360</span>&#160;                              <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l05361"></a><span class="lineno"> 5361</span>&#160;                              <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l05362"></a><span class="lineno"> 5362</span>&#160;        }</div>
<div class="line"><a name="l05363"></a><span class="lineno"> 5363</span>&#160;      }</div>
<div class="line"><a name="l05364"></a><span class="lineno"> 5364</span>&#160; </div>
<div class="line"><a name="l05365"></a><span class="lineno"> 5365</span>&#160;      <span class="comment">// Check that all communicators in col_distribution_pt are the same as the</span></div>
<div class="line"><a name="l05366"></a><span class="lineno"> 5366</span>&#160;      <span class="comment">// first row communicator from above.</span></div>
<div class="line"><a name="l05367"></a><span class="lineno"> 5367</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 0; block_col_i &lt; matrix_ncol; block_col_i++)</div>
<div class="line"><a name="l05368"></a><span class="lineno"> 5368</span>&#160;      {</div>
<div class="line"><a name="l05369"></a><span class="lineno"> 5369</span>&#160;        <span class="keyword">const</span> OomphCommunicator current_comm =</div>
<div class="line"><a name="l05370"></a><span class="lineno"> 5370</span>&#160;          *(col_distribution_pt[block_col_i]-&gt;communicator_pt());</div>
<div class="line"><a name="l05371"></a><span class="lineno"> 5371</span>&#160; </div>
<div class="line"><a name="l05372"></a><span class="lineno"> 5372</span>&#160;        <span class="keywordflow">if</span> (first_row_comm != current_comm)</div>
<div class="line"><a name="l05373"></a><span class="lineno"> 5373</span>&#160;        {</div>
<div class="line"><a name="l05374"></a><span class="lineno"> 5374</span>&#160;          std::ostringstream error_message;</div>
<div class="line"><a name="l05375"></a><span class="lineno"> 5375</span>&#160;          error_message</div>
<div class="line"><a name="l05376"></a><span class="lineno"> 5376</span>&#160;            &lt;&lt; <span class="stringliteral">&quot;The communicator from the col distribution in position &quot;</span></div>
<div class="line"><a name="l05377"></a><span class="lineno"> 5377</span>&#160;            &lt;&lt; block_col_i &lt;&lt; <span class="stringliteral">&quot; is not the same as the first &quot;</span></div>
<div class="line"><a name="l05378"></a><span class="lineno"> 5378</span>&#160;            &lt;&lt; <span class="stringliteral">&quot;communicator from row_distribution_pt&quot;</span>;</div>
<div class="line"><a name="l05379"></a><span class="lineno"> 5379</span>&#160;          <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l05380"></a><span class="lineno"> 5380</span>&#160;                              <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l05381"></a><span class="lineno"> 5381</span>&#160;                              <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l05382"></a><span class="lineno"> 5382</span>&#160;        }</div>
<div class="line"><a name="l05383"></a><span class="lineno"> 5383</span>&#160;      }</div>
<div class="line"><a name="l05384"></a><span class="lineno"> 5384</span>&#160; </div>
<div class="line"><a name="l05385"></a><span class="lineno"> 5385</span>&#160;      <span class="comment">// Are all sub matrices built? If the matrix_pt is not null, make sure</span></div>
<div class="line"><a name="l05386"></a><span class="lineno"> 5386</span>&#160;      <span class="comment">// that it is built.</span></div>
<div class="line"><a name="l05387"></a><span class="lineno"> 5387</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 0; block_row_i &lt; matrix_nrow; block_row_i++)</div>
<div class="line"><a name="l05388"></a><span class="lineno"> 5388</span>&#160;      {</div>
<div class="line"><a name="l05389"></a><span class="lineno"> 5389</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 0; block_col_i &lt; matrix_ncol; block_col_i++)</div>
<div class="line"><a name="l05390"></a><span class="lineno"> 5390</span>&#160;        {</div>
<div class="line"><a name="l05391"></a><span class="lineno"> 5391</span>&#160;          <span class="keywordflow">if</span> (matrix_pt(block_row_i, block_col_i) != 0 &amp;&amp;</div>
<div class="line"><a name="l05392"></a><span class="lineno"> 5392</span>&#160;              !(matrix_pt(block_row_i, block_col_i)-&gt;built()))</div>
<div class="line"><a name="l05393"></a><span class="lineno"> 5393</span>&#160;          {</div>
<div class="line"><a name="l05394"></a><span class="lineno"> 5394</span>&#160;            std::ostringstream error_message;</div>
<div class="line"><a name="l05395"></a><span class="lineno"> 5395</span>&#160;            error_message &lt;&lt; <span class="stringliteral">&quot;The sub matrix_pt(&quot;</span> &lt;&lt; block_row_i &lt;&lt; <span class="stringliteral">&quot;,&quot;</span></div>
<div class="line"><a name="l05396"></a><span class="lineno"> 5396</span>&#160;                          &lt;&lt; block_col_i &lt;&lt; <span class="stringliteral">&quot;)\n&quot;</span></div>
<div class="line"><a name="l05397"></a><span class="lineno"> 5397</span>&#160;                          &lt;&lt; <span class="stringliteral">&quot;is not built.\n&quot;</span>;</div>
<div class="line"><a name="l05398"></a><span class="lineno"> 5398</span>&#160;            <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l05399"></a><span class="lineno"> 5399</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l05400"></a><span class="lineno"> 5400</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l05401"></a><span class="lineno"> 5401</span>&#160;          }</div>
<div class="line"><a name="l05402"></a><span class="lineno"> 5402</span>&#160;        }</div>
<div class="line"><a name="l05403"></a><span class="lineno"> 5403</span>&#160;      }</div>
<div class="line"><a name="l05404"></a><span class="lineno"> 5404</span>&#160; </div>
<div class="line"><a name="l05405"></a><span class="lineno"> 5405</span>&#160;      <span class="comment">// For the matrices which are built, do they have the same communicator as</span></div>
<div class="line"><a name="l05406"></a><span class="lineno"> 5406</span>&#160;      <span class="comment">// the first communicator from row_distribution_pt?</span></div>
<div class="line"><a name="l05407"></a><span class="lineno"> 5407</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 0; block_row_i &lt; matrix_nrow; block_row_i++)</div>
<div class="line"><a name="l05408"></a><span class="lineno"> 5408</span>&#160;      {</div>
<div class="line"><a name="l05409"></a><span class="lineno"> 5409</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 0; block_col_i &lt; matrix_ncol; block_col_i++)</div>
<div class="line"><a name="l05410"></a><span class="lineno"> 5410</span>&#160;        {</div>
<div class="line"><a name="l05411"></a><span class="lineno"> 5411</span>&#160;          <span class="keywordflow">if</span> (matrix_pt(block_row_i, block_col_i) != 0)</div>
<div class="line"><a name="l05412"></a><span class="lineno"> 5412</span>&#160;          {</div>
<div class="line"><a name="l05413"></a><span class="lineno"> 5413</span>&#160;            <span class="keyword">const</span> OomphCommunicator current_comm =</div>
<div class="line"><a name="l05414"></a><span class="lineno"> 5414</span>&#160;              *(matrix_pt(block_row_i, block_col_i)</div>
<div class="line"><a name="l05415"></a><span class="lineno"> 5415</span>&#160;                  -&gt;distribution_pt()</div>
<div class="line"><a name="l05416"></a><span class="lineno"> 5416</span>&#160;                  -&gt;communicator_pt());</div>
<div class="line"><a name="l05417"></a><span class="lineno"> 5417</span>&#160;            <span class="keywordflow">if</span> (first_row_comm != current_comm)</div>
<div class="line"><a name="l05418"></a><span class="lineno"> 5418</span>&#160;            {</div>
<div class="line"><a name="l05419"></a><span class="lineno"> 5419</span>&#160;              std::ostringstream error_message;</div>
<div class="line"><a name="l05420"></a><span class="lineno"> 5420</span>&#160;              error_message</div>
<div class="line"><a name="l05421"></a><span class="lineno"> 5421</span>&#160;                &lt;&lt; <span class="stringliteral">&quot;The sub matrix_pt(&quot;</span> &lt;&lt; block_row_i &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt; block_col_i</div>
<div class="line"><a name="l05422"></a><span class="lineno"> 5422</span>&#160;                &lt;&lt; <span class="stringliteral">&quot;)\n&quot;</span></div>
<div class="line"><a name="l05423"></a><span class="lineno"> 5423</span>&#160;                &lt;&lt; <span class="stringliteral">&quot;does not have the same communicator pointer as those in\n&quot;</span></div>
<div class="line"><a name="l05424"></a><span class="lineno"> 5424</span>&#160;                &lt;&lt; <span class="stringliteral">&quot;(row|col)_distribution_pt.\n&quot;</span>;</div>
<div class="line"><a name="l05425"></a><span class="lineno"> 5425</span>&#160;              <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l05426"></a><span class="lineno"> 5426</span>&#160;                                  <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l05427"></a><span class="lineno"> 5427</span>&#160;                                  <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l05428"></a><span class="lineno"> 5428</span>&#160;            }</div>
<div class="line"><a name="l05429"></a><span class="lineno"> 5429</span>&#160;          }</div>
<div class="line"><a name="l05430"></a><span class="lineno"> 5430</span>&#160;        }</div>
<div class="line"><a name="l05431"></a><span class="lineno"> 5431</span>&#160;      }</div>
<div class="line"><a name="l05432"></a><span class="lineno"> 5432</span>&#160; </div>
<div class="line"><a name="l05433"></a><span class="lineno"> 5433</span>&#160;      <span class="comment">// Do all dimensions of sub matrices &quot;make sense&quot;?</span></div>
<div class="line"><a name="l05434"></a><span class="lineno"> 5434</span>&#160;      <span class="comment">// Compare the number of rows of each block matrix in a block row.</span></div>
<div class="line"><a name="l05435"></a><span class="lineno"> 5435</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 0; block_row_i &lt; matrix_nrow; block_row_i++)</div>
<div class="line"><a name="l05436"></a><span class="lineno"> 5436</span>&#160;      {</div>
<div class="line"><a name="l05437"></a><span class="lineno"> 5437</span>&#160;        <span class="comment">// Use the first column to compare against the rest.</span></div>
<div class="line"><a name="l05438"></a><span class="lineno"> 5438</span>&#160;        <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> current_block_nrow =</div>
<div class="line"><a name="l05439"></a><span class="lineno"> 5439</span>&#160;          row_distribution_pt[block_row_i]-&gt;nrow();</div>
<div class="line"><a name="l05440"></a><span class="lineno"> 5440</span>&#160; </div>
<div class="line"><a name="l05441"></a><span class="lineno"> 5441</span>&#160;        <span class="comment">// Compare against columns 0 to matrix_ncol - 1</span></div>
<div class="line"><a name="l05442"></a><span class="lineno"> 5442</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 0; block_col_i &lt; matrix_ncol; block_col_i++)</div>
<div class="line"><a name="l05443"></a><span class="lineno"> 5443</span>&#160;        {</div>
<div class="line"><a name="l05444"></a><span class="lineno"> 5444</span>&#160;          <span class="comment">// Perform the check if the matrix_pt is not null.</span></div>
<div class="line"><a name="l05445"></a><span class="lineno"> 5445</span>&#160;          <span class="keywordflow">if</span> (matrix_pt(block_row_i, block_col_i) != 0)</div>
<div class="line"><a name="l05446"></a><span class="lineno"> 5446</span>&#160;          {</div>
<div class="line"><a name="l05447"></a><span class="lineno"> 5447</span>&#160;            <span class="comment">// Get the nrow for this sub block.</span></div>
<div class="line"><a name="l05448"></a><span class="lineno"> 5448</span>&#160;            <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> subblock_nrow =</div>
<div class="line"><a name="l05449"></a><span class="lineno"> 5449</span>&#160;              matrix_pt(block_row_i, block_col_i)-&gt;nrow();</div>
<div class="line"><a name="l05450"></a><span class="lineno"> 5450</span>&#160; </div>
<div class="line"><a name="l05451"></a><span class="lineno"> 5451</span>&#160;            <span class="keywordflow">if</span> (current_block_nrow != subblock_nrow)</div>
<div class="line"><a name="l05452"></a><span class="lineno"> 5452</span>&#160;            {</div>
<div class="line"><a name="l05453"></a><span class="lineno"> 5453</span>&#160;              std::ostringstream error_message;</div>
<div class="line"><a name="l05454"></a><span class="lineno"> 5454</span>&#160;              error_message &lt;&lt; <span class="stringliteral">&quot;The sub matrix (&quot;</span> &lt;&lt; block_row_i &lt;&lt; <span class="stringliteral">&quot;,&quot;</span></div>
<div class="line"><a name="l05455"></a><span class="lineno"> 5455</span>&#160;                            &lt;&lt; block_col_i &lt;&lt; <span class="stringliteral">&quot;)\n&quot;</span></div>
<div class="line"><a name="l05456"></a><span class="lineno"> 5456</span>&#160;                            &lt;&lt; <span class="stringliteral">&quot;requires nrow = &quot;</span> &lt;&lt; current_block_nrow</div>
<div class="line"><a name="l05457"></a><span class="lineno"> 5457</span>&#160;                            &lt;&lt; <span class="stringliteral">&quot;, but has nrow = &quot;</span> &lt;&lt; subblock_nrow &lt;&lt; <span class="stringliteral">&quot;.\n&quot;</span></div>
<div class="line"><a name="l05458"></a><span class="lineno"> 5458</span>&#160;                            &lt;&lt; <span class="stringliteral">&quot;Either the row_distribution_pt is incorrect or &quot;</span></div>
<div class="line"><a name="l05459"></a><span class="lineno"> 5459</span>&#160;                            &lt;&lt; <span class="stringliteral">&quot;the sub matrices are incorrect.\n&quot;</span>;</div>
<div class="line"><a name="l05460"></a><span class="lineno"> 5460</span>&#160;              <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l05461"></a><span class="lineno"> 5461</span>&#160;                                  <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l05462"></a><span class="lineno"> 5462</span>&#160;                                  <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l05463"></a><span class="lineno"> 5463</span>&#160;            }</div>
<div class="line"><a name="l05464"></a><span class="lineno"> 5464</span>&#160;          }</div>
<div class="line"><a name="l05465"></a><span class="lineno"> 5465</span>&#160;        }</div>
<div class="line"><a name="l05466"></a><span class="lineno"> 5466</span>&#160;      }</div>
<div class="line"><a name="l05467"></a><span class="lineno"> 5467</span>&#160; </div>
<div class="line"><a name="l05468"></a><span class="lineno"> 5468</span>&#160;      <span class="comment">// Compare the number of columns of each block matrix in a block column.</span></div>
<div class="line"><a name="l05469"></a><span class="lineno"> 5469</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 0; block_col_i &lt; matrix_ncol; block_col_i++)</div>
<div class="line"><a name="l05470"></a><span class="lineno"> 5470</span>&#160;      {</div>
<div class="line"><a name="l05471"></a><span class="lineno"> 5471</span>&#160;        <span class="comment">// Get the current block ncol from the linear algebra distribution.</span></div>
<div class="line"><a name="l05472"></a><span class="lineno"> 5472</span>&#160;        <span class="comment">// Note that we assume that the dimensions are symmetrical.</span></div>
<div class="line"><a name="l05473"></a><span class="lineno"> 5473</span>&#160;        <span class="keywordtype">unsigned</span> current_block_ncol = col_distribution_pt[block_col_i]-&gt;nrow();</div>
<div class="line"><a name="l05474"></a><span class="lineno"> 5474</span>&#160; </div>
<div class="line"><a name="l05475"></a><span class="lineno"> 5475</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 0; block_row_i &lt; matrix_nrow; block_row_i++)</div>
<div class="line"><a name="l05476"></a><span class="lineno"> 5476</span>&#160;        {</div>
<div class="line"><a name="l05477"></a><span class="lineno"> 5477</span>&#160;          <span class="keywordflow">if</span> (matrix_pt(block_row_i, block_col_i) != 0)</div>
<div class="line"><a name="l05478"></a><span class="lineno"> 5478</span>&#160;          {</div>
<div class="line"><a name="l05479"></a><span class="lineno"> 5479</span>&#160;            <span class="comment">// Get the ncol for this sub block.</span></div>
<div class="line"><a name="l05480"></a><span class="lineno"> 5480</span>&#160;            <span class="keywordtype">unsigned</span> subblock_ncol =</div>
<div class="line"><a name="l05481"></a><span class="lineno"> 5481</span>&#160;              matrix_pt(block_row_i, block_col_i)-&gt;ncol();</div>
<div class="line"><a name="l05482"></a><span class="lineno"> 5482</span>&#160; </div>
<div class="line"><a name="l05483"></a><span class="lineno"> 5483</span>&#160;            <span class="keywordflow">if</span> (current_block_ncol != subblock_ncol)</div>
<div class="line"><a name="l05484"></a><span class="lineno"> 5484</span>&#160;            {</div>
<div class="line"><a name="l05485"></a><span class="lineno"> 5485</span>&#160;              std::ostringstream error_message;</div>
<div class="line"><a name="l05486"></a><span class="lineno"> 5486</span>&#160;              error_message &lt;&lt; <span class="stringliteral">&quot;The sub matrix (&quot;</span> &lt;&lt; block_row_i &lt;&lt; <span class="stringliteral">&quot;,&quot;</span></div>
<div class="line"><a name="l05487"></a><span class="lineno"> 5487</span>&#160;                            &lt;&lt; block_col_i &lt;&lt; <span class="stringliteral">&quot;)\n&quot;</span></div>
<div class="line"><a name="l05488"></a><span class="lineno"> 5488</span>&#160;                            &lt;&lt; <span class="stringliteral">&quot;requires ncol = &quot;</span> &lt;&lt; current_block_ncol</div>
<div class="line"><a name="l05489"></a><span class="lineno"> 5489</span>&#160;                            &lt;&lt; <span class="stringliteral">&quot;, but has ncol = &quot;</span> &lt;&lt; subblock_ncol &lt;&lt; <span class="stringliteral">&quot;.\n&quot;</span></div>
<div class="line"><a name="l05490"></a><span class="lineno"> 5490</span>&#160;                            &lt;&lt; <span class="stringliteral">&quot;Either the col_distribution_pt is incorrect or &quot;</span></div>
<div class="line"><a name="l05491"></a><span class="lineno"> 5491</span>&#160;                            &lt;&lt; <span class="stringliteral">&quot;the sub matrices are incorrect.\n&quot;</span>;</div>
<div class="line"><a name="l05492"></a><span class="lineno"> 5492</span>&#160;              <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l05493"></a><span class="lineno"> 5493</span>&#160;                                  <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l05494"></a><span class="lineno"> 5494</span>&#160;                                  <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l05495"></a><span class="lineno"> 5495</span>&#160;            }</div>
<div class="line"><a name="l05496"></a><span class="lineno"> 5496</span>&#160;          }</div>
<div class="line"><a name="l05497"></a><span class="lineno"> 5497</span>&#160;        }</div>
<div class="line"><a name="l05498"></a><span class="lineno"> 5498</span>&#160;      }</div>
<div class="line"><a name="l05499"></a><span class="lineno"> 5499</span>&#160; </div>
<div class="line"><a name="l05500"></a><span class="lineno"> 5500</span>&#160;      <span class="comment">// Ensure that the distributions for all sub matrices in the same block</span></div>
<div class="line"><a name="l05501"></a><span class="lineno"> 5501</span>&#160;      <span class="comment">// row are the same. This is because we permute the row across several</span></div>
<div class="line"><a name="l05502"></a><span class="lineno"> 5502</span>&#160;      <span class="comment">// matrices.</span></div>
<div class="line"><a name="l05503"></a><span class="lineno"> 5503</span>&#160; </div>
<div class="line"><a name="l05504"></a><span class="lineno"> 5504</span>&#160;      <span class="comment">// Loop through each block row.</span></div>
<div class="line"><a name="l05505"></a><span class="lineno"> 5505</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 0; block_row_i &lt; matrix_nrow; block_row_i++)</div>
<div class="line"><a name="l05506"></a><span class="lineno"> 5506</span>&#160;      {</div>
<div class="line"><a name="l05507"></a><span class="lineno"> 5507</span>&#160;        <span class="comment">// Get the distribution from the first block in this row.</span></div>
<div class="line"><a name="l05508"></a><span class="lineno"> 5508</span>&#160;        LinearAlgebraDistribution* block_row_distribution_pt =</div>
<div class="line"><a name="l05509"></a><span class="lineno"> 5509</span>&#160;          row_distribution_pt[block_row_i];</div>
<div class="line"><a name="l05510"></a><span class="lineno"> 5510</span>&#160; </div>
<div class="line"><a name="l05511"></a><span class="lineno"> 5511</span>&#160;        <span class="comment">// Loop through the block columns</span></div>
<div class="line"><a name="l05512"></a><span class="lineno"> 5512</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 0; block_col_i &lt; matrix_ncol; block_col_i++)</div>
<div class="line"><a name="l05513"></a><span class="lineno"> 5513</span>&#160;        {</div>
<div class="line"><a name="l05514"></a><span class="lineno"> 5514</span>&#160;          <span class="keywordflow">if</span> (matrix_pt(block_row_i, block_col_i) != 0)</div>
<div class="line"><a name="l05515"></a><span class="lineno"> 5515</span>&#160;          {</div>
<div class="line"><a name="l05516"></a><span class="lineno"> 5516</span>&#160;            <span class="comment">// Get the distribution for this block.</span></div>
<div class="line"><a name="l05517"></a><span class="lineno"> 5517</span>&#160;            LinearAlgebraDistribution* current_block_distribution_pt =</div>
<div class="line"><a name="l05518"></a><span class="lineno"> 5518</span>&#160;              matrix_pt(block_row_i, block_col_i)-&gt;distribution_pt();</div>
<div class="line"><a name="l05519"></a><span class="lineno"> 5519</span>&#160; </div>
<div class="line"><a name="l05520"></a><span class="lineno"> 5520</span>&#160;            <span class="comment">// Ensure that the in matrices is a square block matrix.</span></div>
<div class="line"><a name="l05521"></a><span class="lineno"> 5521</span>&#160;            <span class="keywordflow">if</span> ((*block_row_distribution_pt) !=</div>
<div class="line"><a name="l05522"></a><span class="lineno"> 5522</span>&#160;                (*current_block_distribution_pt))</div>
<div class="line"><a name="l05523"></a><span class="lineno"> 5523</span>&#160;            {</div>
<div class="line"><a name="l05524"></a><span class="lineno"> 5524</span>&#160;              std::ostringstream error_message;</div>
<div class="line"><a name="l05525"></a><span class="lineno"> 5525</span>&#160;              error_message</div>
<div class="line"><a name="l05526"></a><span class="lineno"> 5526</span>&#160;                &lt;&lt; <span class="stringliteral">&quot;Sub block(&quot;</span> &lt;&lt; block_row_i &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt; block_col_i &lt;&lt; <span class="stringliteral">&quot;)&quot;</span></div>
<div class="line"><a name="l05527"></a><span class="lineno"> 5527</span>&#160;                &lt;&lt; <span class="stringliteral">&quot;does not have the same distributoin as the first&quot;</span></div>
<div class="line"><a name="l05528"></a><span class="lineno"> 5528</span>&#160;                &lt;&lt; <span class="stringliteral">&quot;block in this block row.\n&quot;</span></div>
<div class="line"><a name="l05529"></a><span class="lineno"> 5529</span>&#160;                &lt;&lt; <span class="stringliteral">&quot;All distributions on a block row must be the same&quot;</span></div>
<div class="line"><a name="l05530"></a><span class="lineno"> 5530</span>&#160;                &lt;&lt; <span class="stringliteral">&quot;for this function to concatenate matrices.\n&quot;</span>;</div>
<div class="line"><a name="l05531"></a><span class="lineno"> 5531</span>&#160;              <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l05532"></a><span class="lineno"> 5532</span>&#160;                                  <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l05533"></a><span class="lineno"> 5533</span>&#160;                                  <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l05534"></a><span class="lineno"> 5534</span>&#160;            }</div>
<div class="line"><a name="l05535"></a><span class="lineno"> 5535</span>&#160;          }</div>
<div class="line"><a name="l05536"></a><span class="lineno"> 5536</span>&#160;        }</div>
<div class="line"><a name="l05537"></a><span class="lineno"> 5537</span>&#160;      }</div>
<div class="line"><a name="l05538"></a><span class="lineno"> 5538</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l05539"></a><span class="lineno"> 5539</span>&#160; </div>
<div class="line"><a name="l05540"></a><span class="lineno"> 5540</span>&#160;      <span class="comment">// The communicator pointer from the first row_distribution_pt</span></div>
<div class="line"><a name="l05541"></a><span class="lineno"> 5541</span>&#160;      <span class="keyword">const</span> OomphCommunicator* <span class="keyword">const</span> comm_pt =</div>
<div class="line"><a name="l05542"></a><span class="lineno"> 5542</span>&#160;        row_distribution_pt[0]-&gt;communicator_pt();</div>
<div class="line"><a name="l05543"></a><span class="lineno"> 5543</span>&#160; </div>
<div class="line"><a name="l05544"></a><span class="lineno"> 5544</span>&#160;      <span class="comment">// Renamed for so it makes more sense.</span></div>
<div class="line"><a name="l05545"></a><span class="lineno"> 5545</span>&#160;      <span class="keywordtype">unsigned</span> nblock_row = matrix_nrow;</div>
<div class="line"><a name="l05546"></a><span class="lineno"> 5546</span>&#160; </div>
<div class="line"><a name="l05547"></a><span class="lineno"> 5547</span>&#160;      <span class="comment">// If the result matrix does not have a distribution, then we concatenate</span></div>
<div class="line"><a name="l05548"></a><span class="lineno"> 5548</span>&#160;      <span class="comment">// the sub matrix distributions.</span></div>
<div class="line"><a name="l05549"></a><span class="lineno"> 5549</span>&#160;      <span class="keywordflow">if</span> (!result_matrix.distribution_pt()-&gt;built())</div>
<div class="line"><a name="l05550"></a><span class="lineno"> 5550</span>&#160;      {</div>
<div class="line"><a name="l05551"></a><span class="lineno"> 5551</span>&#160;        <span class="comment">// The result distribution</span></div>
<div class="line"><a name="l05552"></a><span class="lineno"> 5552</span>&#160;        LinearAlgebraDistribution tmp_distribution;</div>
<div class="line"><a name="l05553"></a><span class="lineno"> 5553</span>&#160;        <a class="code" href="../../dd/d95/namespaceoomph_1_1CRDoubleMatrixHelpers.html#ab7e3ac344aa644292a143a3917a03e65">LinearAlgebraDistributionHelpers::concatenate</a>(row_distribution_pt,</div>
<div class="line"><a name="l05554"></a><span class="lineno"> 5554</span>&#160;                                                      tmp_distribution);</div>
<div class="line"><a name="l05555"></a><span class="lineno"> 5555</span>&#160; </div>
<div class="line"><a name="l05556"></a><span class="lineno"> 5556</span>&#160;        result_matrix.build(&amp;tmp_distribution);</div>
<div class="line"><a name="l05557"></a><span class="lineno"> 5557</span>&#160;      }</div>
<div class="line"><a name="l05558"></a><span class="lineno"> 5558</span>&#160;      <span class="keywordflow">else</span></div>
<div class="line"><a name="l05559"></a><span class="lineno"> 5559</span>&#160;      <span class="comment">// A distribution is supplied for the result matrix.</span></div>
<div class="line"><a name="l05560"></a><span class="lineno"> 5560</span>&#160;      {</div>
<div class="line"><a name="l05561"></a><span class="lineno"> 5561</span>&#160;<span class="preprocessor">#ifdef PARANOID</span></div>
<div class="line"><a name="l05562"></a><span class="lineno"> 5562</span>&#160;        <span class="comment">// Check that the result distribution is a concatenation of the</span></div>
<div class="line"><a name="l05563"></a><span class="lineno"> 5563</span>&#160;        <span class="comment">// distributions of the sub matrices.</span></div>
<div class="line"><a name="l05564"></a><span class="lineno"> 5564</span>&#160; </div>
<div class="line"><a name="l05565"></a><span class="lineno"> 5565</span>&#160;        LinearAlgebraDistribution wanted_distribution;</div>
<div class="line"><a name="l05566"></a><span class="lineno"> 5566</span>&#160; </div>
<div class="line"><a name="l05567"></a><span class="lineno"> 5567</span>&#160;        <a class="code" href="../../dd/d95/namespaceoomph_1_1CRDoubleMatrixHelpers.html#ab7e3ac344aa644292a143a3917a03e65">LinearAlgebraDistributionHelpers::concatenate</a>(row_distribution_pt,</div>
<div class="line"><a name="l05568"></a><span class="lineno"> 5568</span>&#160;                                                      wanted_distribution);</div>
<div class="line"><a name="l05569"></a><span class="lineno"> 5569</span>&#160; </div>
<div class="line"><a name="l05570"></a><span class="lineno"> 5570</span>&#160;        <span class="keywordflow">if</span> (*(result_matrix.distribution_pt()) != wanted_distribution)</div>
<div class="line"><a name="l05571"></a><span class="lineno"> 5571</span>&#160;        {</div>
<div class="line"><a name="l05572"></a><span class="lineno"> 5572</span>&#160;          std::ostringstream error_message;</div>
<div class="line"><a name="l05573"></a><span class="lineno"> 5573</span>&#160;          error_message</div>
<div class="line"><a name="l05574"></a><span class="lineno"> 5574</span>&#160;            &lt;&lt; <span class="stringliteral">&quot;The result distribution is not correct.\n&quot;</span></div>
<div class="line"><a name="l05575"></a><span class="lineno"> 5575</span>&#160;            &lt;&lt; <span class="stringliteral">&quot;Please call the function without a result\n&quot;</span></div>
<div class="line"><a name="l05576"></a><span class="lineno"> 5576</span>&#160;            &lt;&lt; <span class="stringliteral">&quot;distribution (clear the result matrix) or check the\n&quot;</span></div>
<div class="line"><a name="l05577"></a><span class="lineno"> 5577</span>&#160;            &lt;&lt; <span class="stringliteral">&quot;distribution of the result matrix.\n&quot;</span></div>
<div class="line"><a name="l05578"></a><span class="lineno"> 5578</span>&#160;            &lt;&lt; <span class="stringliteral">&quot;The result distribution must be the same as the one \n&quot;</span></div>
<div class="line"><a name="l05579"></a><span class="lineno"> 5579</span>&#160;            &lt;&lt; <span class="stringliteral">&quot;created by\n&quot;</span></div>
<div class="line"><a name="l05580"></a><span class="lineno"> 5580</span>&#160;            &lt;&lt; <span class="stringliteral">&quot;LinearAlgebraDistributionHelpers::concatenate(...)&quot;</span>;</div>
<div class="line"><a name="l05581"></a><span class="lineno"> 5581</span>&#160;          <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l05582"></a><span class="lineno"> 5582</span>&#160;                              <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l05583"></a><span class="lineno"> 5583</span>&#160;                              <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l05584"></a><span class="lineno"> 5584</span>&#160;        }</div>
<div class="line"><a name="l05585"></a><span class="lineno"> 5585</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l05586"></a><span class="lineno"> 5586</span>&#160;      }</div>
<div class="line"><a name="l05587"></a><span class="lineno"> 5587</span>&#160; </div>
<div class="line"><a name="l05588"></a><span class="lineno"> 5588</span>&#160;      <span class="comment">// The rest of the paranoid checks.</span></div>
<div class="line"><a name="l05589"></a><span class="lineno"> 5589</span>&#160;<span class="preprocessor">#ifdef PARANOID</span></div>
<div class="line"><a name="l05590"></a><span class="lineno"> 5590</span>&#160; </div>
<div class="line"><a name="l05591"></a><span class="lineno"> 5591</span>&#160;      <span class="comment">// Make sure that the communicator from the result matrix is the same as</span></div>
<div class="line"><a name="l05592"></a><span class="lineno"> 5592</span>&#160;      <span class="comment">// all the others. This test is redundant if this function created the</span></div>
<div class="line"><a name="l05593"></a><span class="lineno"> 5593</span>&#160;      <span class="comment">// result matrix distribution, since then it is guaranteed that the</span></div>
<div class="line"><a name="l05594"></a><span class="lineno"> 5594</span>&#160;      <span class="comment">// communicators are the same.</span></div>
<div class="line"><a name="l05595"></a><span class="lineno"> 5595</span>&#160;      {</div>
<div class="line"><a name="l05596"></a><span class="lineno"> 5596</span>&#160;        <span class="comment">// Communicator from the result matrix.</span></div>
<div class="line"><a name="l05597"></a><span class="lineno"> 5597</span>&#160;        <span class="keyword">const</span> OomphCommunicator res_comm =</div>
<div class="line"><a name="l05598"></a><span class="lineno"> 5598</span>&#160;          *(result_matrix.distribution_pt()-&gt;communicator_pt());</div>
<div class="line"><a name="l05599"></a><span class="lineno"> 5599</span>&#160; </div>
<div class="line"><a name="l05600"></a><span class="lineno"> 5600</span>&#160;        <span class="comment">// Is the result communicator pointer the same as the others?</span></div>
<div class="line"><a name="l05601"></a><span class="lineno"> 5601</span>&#160;        <span class="comment">// Since we have already tested the others, we only need to compare</span></div>
<div class="line"><a name="l05602"></a><span class="lineno"> 5602</span>&#160;        <span class="comment">// against one of them. Say the first communicator from</span></div>
<div class="line"><a name="l05603"></a><span class="lineno"> 5603</span>&#160;        <span class="comment">// row_distribution_pt.</span></div>
<div class="line"><a name="l05604"></a><span class="lineno"> 5604</span>&#160;        <span class="keyword">const</span> OomphCommunicator first_comm =</div>
<div class="line"><a name="l05605"></a><span class="lineno"> 5605</span>&#160;          *(row_distribution_pt[0]-&gt;communicator_pt());</div>
<div class="line"><a name="l05606"></a><span class="lineno"> 5606</span>&#160; </div>
<div class="line"><a name="l05607"></a><span class="lineno"> 5607</span>&#160;        <span class="keywordflow">if</span> (res_comm != first_comm)</div>
<div class="line"><a name="l05608"></a><span class="lineno"> 5608</span>&#160;        {</div>
<div class="line"><a name="l05609"></a><span class="lineno"> 5609</span>&#160;          std::ostringstream error_message;</div>
<div class="line"><a name="l05610"></a><span class="lineno"> 5610</span>&#160;          error_message &lt;&lt; <span class="stringliteral">&quot;The OomphCommunicator of the result matrix is not &quot;</span></div>
<div class="line"><a name="l05611"></a><span class="lineno"> 5611</span>&#160;                           <span class="stringliteral">&quot;the same as the &quot;</span></div>
<div class="line"><a name="l05612"></a><span class="lineno"> 5612</span>&#160;                        &lt;&lt; <span class="stringliteral">&quot;others!&quot;</span>;</div>
<div class="line"><a name="l05613"></a><span class="lineno"> 5613</span>&#160;          <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l05614"></a><span class="lineno"> 5614</span>&#160;                              <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l05615"></a><span class="lineno"> 5615</span>&#160;                              <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l05616"></a><span class="lineno"> 5616</span>&#160;        }</div>
<div class="line"><a name="l05617"></a><span class="lineno"> 5617</span>&#160;      }</div>
<div class="line"><a name="l05618"></a><span class="lineno"> 5618</span>&#160; </div>
<div class="line"><a name="l05619"></a><span class="lineno"> 5619</span>&#160;      <span class="comment">// Are all the distributed boolean the same? This only applies if we have</span></div>
<div class="line"><a name="l05620"></a><span class="lineno"> 5620</span>&#160;      <span class="comment">// more than one processor. If there is only one processor, then it does</span></div>
<div class="line"><a name="l05621"></a><span class="lineno"> 5621</span>&#160;      <span class="comment">// not matter if it is distributed or not - they are conceptually the</span></div>
<div class="line"><a name="l05622"></a><span class="lineno"> 5622</span>&#160;      <span class="comment">// same.</span></div>
<div class="line"><a name="l05623"></a><span class="lineno"> 5623</span>&#160;      <span class="keywordflow">if</span> (comm_pt-&gt;nproc() != 1)</div>
<div class="line"><a name="l05624"></a><span class="lineno"> 5624</span>&#160;      {</div>
<div class="line"><a name="l05625"></a><span class="lineno"> 5625</span>&#160;        <span class="comment">// Compare distributed for sub matrices (against the result matrix).</span></div>
<div class="line"><a name="l05626"></a><span class="lineno"> 5626</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">bool</span> res_distributed = result_matrix.distributed();</div>
<div class="line"><a name="l05627"></a><span class="lineno"> 5627</span>&#160; </div>
<div class="line"><a name="l05628"></a><span class="lineno"> 5628</span>&#160;        <span class="comment">// Loop over all sub blocks.</span></div>
<div class="line"><a name="l05629"></a><span class="lineno"> 5629</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 0; block_row_i &lt; matrix_nrow; block_row_i++)</div>
<div class="line"><a name="l05630"></a><span class="lineno"> 5630</span>&#160;        {</div>
<div class="line"><a name="l05631"></a><span class="lineno"> 5631</span>&#160;          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 0; block_col_i &lt; matrix_ncol;</div>
<div class="line"><a name="l05632"></a><span class="lineno"> 5632</span>&#160;               block_col_i++)</div>
<div class="line"><a name="l05633"></a><span class="lineno"> 5633</span>&#160;          {</div>
<div class="line"><a name="l05634"></a><span class="lineno"> 5634</span>&#160;            <span class="keywordflow">if</span> (matrix_pt(block_row_i, block_col_i) != 0)</div>
<div class="line"><a name="l05635"></a><span class="lineno"> 5635</span>&#160;            {</div>
<div class="line"><a name="l05636"></a><span class="lineno"> 5636</span>&#160;              <span class="keyword">const</span> <span class="keywordtype">bool</span> another_distributed =</div>
<div class="line"><a name="l05637"></a><span class="lineno"> 5637</span>&#160;                matrix_pt(block_row_i, block_col_i)-&gt;distributed();</div>
<div class="line"><a name="l05638"></a><span class="lineno"> 5638</span>&#160; </div>
<div class="line"><a name="l05639"></a><span class="lineno"> 5639</span>&#160;              <span class="keywordflow">if</span> (res_distributed != another_distributed)</div>
<div class="line"><a name="l05640"></a><span class="lineno"> 5640</span>&#160;              {</div>
<div class="line"><a name="l05641"></a><span class="lineno"> 5641</span>&#160;                std::ostringstream error_message;</div>
<div class="line"><a name="l05642"></a><span class="lineno"> 5642</span>&#160;                error_message &lt;&lt; <span class="stringliteral">&quot;The distributed boolean of the sub matrix (&quot;</span></div>
<div class="line"><a name="l05643"></a><span class="lineno"> 5643</span>&#160;                              &lt;&lt; block_row_i &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt; block_col_i &lt;&lt; <span class="stringliteral">&quot;)\n&quot;</span></div>
<div class="line"><a name="l05644"></a><span class="lineno"> 5644</span>&#160;                              &lt;&lt; <span class="stringliteral">&quot;is not the same as the result matrix. \n&quot;</span>;</div>
<div class="line"><a name="l05645"></a><span class="lineno"> 5645</span>&#160;                <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l05646"></a><span class="lineno"> 5646</span>&#160;                                    <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l05647"></a><span class="lineno"> 5647</span>&#160;                                    <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l05648"></a><span class="lineno"> 5648</span>&#160;              }</div>
<div class="line"><a name="l05649"></a><span class="lineno"> 5649</span>&#160;            }</div>
<div class="line"><a name="l05650"></a><span class="lineno"> 5650</span>&#160;          }</div>
<div class="line"><a name="l05651"></a><span class="lineno"> 5651</span>&#160;        }</div>
<div class="line"><a name="l05652"></a><span class="lineno"> 5652</span>&#160; </div>
<div class="line"><a name="l05653"></a><span class="lineno"> 5653</span>&#160;        <span class="comment">// Do this test for row_distribution_pt</span></div>
<div class="line"><a name="l05654"></a><span class="lineno"> 5654</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">bool</span> first_row_distribution_distributed =</div>
<div class="line"><a name="l05655"></a><span class="lineno"> 5655</span>&#160;          row_distribution_pt[0]-&gt;distributed();</div>
<div class="line"><a name="l05656"></a><span class="lineno"> 5656</span>&#160; </div>
<div class="line"><a name="l05657"></a><span class="lineno"> 5657</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 1; block_row_i &lt; matrix_nrow; block_row_i++)</div>
<div class="line"><a name="l05658"></a><span class="lineno"> 5658</span>&#160;        {</div>
<div class="line"><a name="l05659"></a><span class="lineno"> 5659</span>&#160;          <span class="keyword">const</span> <span class="keywordtype">bool</span> another_distributed =</div>
<div class="line"><a name="l05660"></a><span class="lineno"> 5660</span>&#160;            row_distribution_pt[block_row_i]-&gt;distributed();</div>
<div class="line"><a name="l05661"></a><span class="lineno"> 5661</span>&#160; </div>
<div class="line"><a name="l05662"></a><span class="lineno"> 5662</span>&#160;          <span class="keywordflow">if</span> (first_row_distribution_distributed != another_distributed)</div>
<div class="line"><a name="l05663"></a><span class="lineno"> 5663</span>&#160;          {</div>
<div class="line"><a name="l05664"></a><span class="lineno"> 5664</span>&#160;            std::ostringstream error_message;</div>
<div class="line"><a name="l05665"></a><span class="lineno"> 5665</span>&#160;            error_message</div>
<div class="line"><a name="l05666"></a><span class="lineno"> 5666</span>&#160;              &lt;&lt; <span class="stringliteral">&quot;The distributed boolean of row_distribution_pt[&quot;</span></div>
<div class="line"><a name="l05667"></a><span class="lineno"> 5667</span>&#160;              &lt;&lt; block_row_i &lt;&lt; <span class="stringliteral">&quot;]\n&quot;</span></div>
<div class="line"><a name="l05668"></a><span class="lineno"> 5668</span>&#160;              &lt;&lt; <span class="stringliteral">&quot;is not the same as the one from row_distribution_pt[0]. \n&quot;</span>;</div>
<div class="line"><a name="l05669"></a><span class="lineno"> 5669</span>&#160;            <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l05670"></a><span class="lineno"> 5670</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l05671"></a><span class="lineno"> 5671</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l05672"></a><span class="lineno"> 5672</span>&#160;          }</div>
<div class="line"><a name="l05673"></a><span class="lineno"> 5673</span>&#160;        }</div>
<div class="line"><a name="l05674"></a><span class="lineno"> 5674</span>&#160; </div>
<div class="line"><a name="l05675"></a><span class="lineno"> 5675</span>&#160;        <span class="comment">// Repeat for col_distribution_pt</span></div>
<div class="line"><a name="l05676"></a><span class="lineno"> 5676</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 0; block_col_i &lt; matrix_ncol; block_col_i++)</div>
<div class="line"><a name="l05677"></a><span class="lineno"> 5677</span>&#160;        {</div>
<div class="line"><a name="l05678"></a><span class="lineno"> 5678</span>&#160;          <span class="keyword">const</span> <span class="keywordtype">bool</span> another_distributed =</div>
<div class="line"><a name="l05679"></a><span class="lineno"> 5679</span>&#160;            col_distribution_pt[block_col_i]-&gt;distributed();</div>
<div class="line"><a name="l05680"></a><span class="lineno"> 5680</span>&#160; </div>
<div class="line"><a name="l05681"></a><span class="lineno"> 5681</span>&#160;          <span class="keywordflow">if</span> (first_row_distribution_distributed != another_distributed)</div>
<div class="line"><a name="l05682"></a><span class="lineno"> 5682</span>&#160;          {</div>
<div class="line"><a name="l05683"></a><span class="lineno"> 5683</span>&#160;            std::ostringstream error_message;</div>
<div class="line"><a name="l05684"></a><span class="lineno"> 5684</span>&#160;            error_message</div>
<div class="line"><a name="l05685"></a><span class="lineno"> 5685</span>&#160;              &lt;&lt; <span class="stringliteral">&quot;The distributed boolean of col_distribution_pt[&quot;</span></div>
<div class="line"><a name="l05686"></a><span class="lineno"> 5686</span>&#160;              &lt;&lt; block_col_i &lt;&lt; <span class="stringliteral">&quot;]\n&quot;</span></div>
<div class="line"><a name="l05687"></a><span class="lineno"> 5687</span>&#160;              &lt;&lt; <span class="stringliteral">&quot;is not the same as the one from row_distribution_pt[0]. \n&quot;</span>;</div>
<div class="line"><a name="l05688"></a><span class="lineno"> 5688</span>&#160;            <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l05689"></a><span class="lineno"> 5689</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l05690"></a><span class="lineno"> 5690</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l05691"></a><span class="lineno"> 5691</span>&#160;          }</div>
<div class="line"><a name="l05692"></a><span class="lineno"> 5692</span>&#160;        }</div>
<div class="line"><a name="l05693"></a><span class="lineno"> 5693</span>&#160;      }</div>
<div class="line"><a name="l05694"></a><span class="lineno"> 5694</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l05695"></a><span class="lineno"> 5695</span>&#160; </div>
<div class="line"><a name="l05698"></a><span class="lineno"> 5698</span>&#160; </div>
<div class="line"><a name="l05699"></a><span class="lineno"> 5699</span>&#160;      <span class="comment">// The number of processors.</span></div>
<div class="line"><a name="l05700"></a><span class="lineno"> 5700</span>&#160;      <span class="keywordtype">unsigned</span> nproc = comm_pt-&gt;nproc();</div>
<div class="line"><a name="l05701"></a><span class="lineno"> 5701</span>&#160; </div>
<div class="line"><a name="l05702"></a><span class="lineno"> 5702</span>&#160;      <span class="comment">// Cache the result distribution pointer for convenience.</span></div>
<div class="line"><a name="l05703"></a><span class="lineno"> 5703</span>&#160;      LinearAlgebraDistribution* res_distribution_pt =</div>
<div class="line"><a name="l05704"></a><span class="lineno"> 5704</span>&#160;        result_matrix.distribution_pt();</div>
<div class="line"><a name="l05705"></a><span class="lineno"> 5705</span>&#160; </div>
<div class="line"><a name="l05706"></a><span class="lineno"> 5706</span>&#160;      <span class="comment">// nrow_local for the result matrix</span></div>
<div class="line"><a name="l05707"></a><span class="lineno"> 5707</span>&#160;      <span class="keywordtype">unsigned</span> res_nrow_local = res_distribution_pt-&gt;nrow_local();</div>
<div class="line"><a name="l05708"></a><span class="lineno"> 5708</span>&#160; </div>
<div class="line"><a name="l05709"></a><span class="lineno"> 5709</span>&#160;      <span class="comment">// renamed for readability.</span></div>
<div class="line"><a name="l05710"></a><span class="lineno"> 5710</span>&#160;      <span class="keywordtype">unsigned</span> nblock_col = matrix_ncol;</div>
<div class="line"><a name="l05711"></a><span class="lineno"> 5711</span>&#160; </div>
<div class="line"><a name="l05712"></a><span class="lineno"> 5712</span>&#160;      <span class="comment">// construct the block offset</span></div>
<div class="line"><a name="l05713"></a><span class="lineno"> 5713</span>&#160;      <span class="comment">//  DenseMatrix&lt;unsigned&gt; col_offset(nproc,nblock_col,0);</span></div>
<div class="line"><a name="l05714"></a><span class="lineno"> 5714</span>&#160;      std::vector&lt;std::vector&lt;unsigned&gt;&gt; col_offset(</div>
<div class="line"><a name="l05715"></a><span class="lineno"> 5715</span>&#160;        nproc, std::vector&lt;unsigned&gt;(nblock_col));</div>
<div class="line"><a name="l05716"></a><span class="lineno"> 5716</span>&#160;      <span class="keywordtype">unsigned</span> off = 0;</div>
<div class="line"><a name="l05717"></a><span class="lineno"> 5717</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> proc_i = 0; proc_i &lt; nproc; proc_i++)</div>
<div class="line"><a name="l05718"></a><span class="lineno"> 5718</span>&#160;      {</div>
<div class="line"><a name="l05719"></a><span class="lineno"> 5719</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_i = 0; block_i &lt; nblock_col; block_i++)</div>
<div class="line"><a name="l05720"></a><span class="lineno"> 5720</span>&#160;        {</div>
<div class="line"><a name="l05721"></a><span class="lineno"> 5721</span>&#160;          col_offset[proc_i][block_i] = off;</div>
<div class="line"><a name="l05722"></a><span class="lineno"> 5722</span>&#160;          off += col_distribution_pt[block_i]-&gt;nrow_local(proc_i);</div>
<div class="line"><a name="l05723"></a><span class="lineno"> 5723</span>&#160;        }</div>
<div class="line"><a name="l05724"></a><span class="lineno"> 5724</span>&#160;      }</div>
<div class="line"><a name="l05725"></a><span class="lineno"> 5725</span>&#160; </div>
<div class="line"><a name="l05726"></a><span class="lineno"> 5726</span>&#160;      <span class="comment">// Do some pre-processing for the processor number a global row number is</span></div>
<div class="line"><a name="l05727"></a><span class="lineno"> 5727</span>&#160;      <span class="comment">// on. This is required when permuting the column entries.</span></div>
<div class="line"><a name="l05728"></a><span class="lineno"> 5728</span>&#160;      <span class="comment">// We need to do this for each distribution, so we have a vector of</span></div>
<div class="line"><a name="l05729"></a><span class="lineno"> 5729</span>&#160;      <span class="comment">// vectors. First index corresponds to the distribution, the second is</span></div>
<div class="line"><a name="l05730"></a><span class="lineno"> 5730</span>&#160;      <span class="comment">// the processor number.</span></div>
<div class="line"><a name="l05731"></a><span class="lineno"> 5731</span>&#160;      std::vector&lt;std::vector&lt;unsigned&gt;&gt; p_for_rows(nblock_col,</div>
<div class="line"><a name="l05732"></a><span class="lineno"> 5732</span>&#160;                                                    std::vector&lt;unsigned&gt;());</div>
<div class="line"><a name="l05733"></a><span class="lineno"> 5733</span>&#160;      <span class="comment">// initialise 2D vector</span></div>
<div class="line"><a name="l05734"></a><span class="lineno"> 5734</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> blocki = 0; blocki &lt; nblock_col; blocki++)</div>
<div class="line"><a name="l05735"></a><span class="lineno"> 5735</span>&#160;      {</div>
<div class="line"><a name="l05736"></a><span class="lineno"> 5736</span>&#160;        <span class="keywordtype">int</span> blockinrow = col_distribution_pt[blocki]-&gt;nrow();</div>
<div class="line"><a name="l05737"></a><span class="lineno"> 5737</span>&#160;        p_for_rows[blocki].resize(blockinrow);</div>
<div class="line"><a name="l05738"></a><span class="lineno"> 5738</span>&#160;        <span class="comment">// FOR each global index in the block, work out the corresponding proc.</span></div>
<div class="line"><a name="l05739"></a><span class="lineno"> 5739</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">int</span> rowi = 0; rowi &lt; blockinrow; rowi++)</div>
<div class="line"><a name="l05740"></a><span class="lineno"> 5740</span>&#160;        {</div>
<div class="line"><a name="l05741"></a><span class="lineno"> 5741</span>&#160;          <span class="keywordtype">unsigned</span> <a class="code" href="../../d0/db0/Tutorial__Map__using_8cpp.html#a7fe964f6b1afd4591f637999272ab9a2">p</a> = 0;</div>
<div class="line"><a name="l05742"></a><span class="lineno"> 5742</span>&#160;          <span class="keywordtype">int</span> b_first_row = col_distribution_pt[blocki]-&gt;first_row(<a class="code" href="../../d0/db0/Tutorial__Map__using_8cpp.html#a7fe964f6b1afd4591f637999272ab9a2">p</a>);</div>
<div class="line"><a name="l05743"></a><span class="lineno"> 5743</span>&#160;          <span class="keywordtype">int</span> b_nrow_local = col_distribution_pt[blocki]-&gt;nrow_local(<a class="code" href="../../d0/db0/Tutorial__Map__using_8cpp.html#a7fe964f6b1afd4591f637999272ab9a2">p</a>);</div>
<div class="line"><a name="l05744"></a><span class="lineno"> 5744</span>&#160; </div>
<div class="line"><a name="l05745"></a><span class="lineno"> 5745</span>&#160;          <span class="keywordflow">while</span> (rowi &lt; b_first_row || rowi &gt;= b_nrow_local + b_first_row)</div>
<div class="line"><a name="l05746"></a><span class="lineno"> 5746</span>&#160;          {</div>
<div class="line"><a name="l05747"></a><span class="lineno"> 5747</span>&#160;            <a class="code" href="../../d0/db0/Tutorial__Map__using_8cpp.html#a7fe964f6b1afd4591f637999272ab9a2">p</a>++;</div>
<div class="line"><a name="l05748"></a><span class="lineno"> 5748</span>&#160;            b_first_row = col_distribution_pt[blocki]-&gt;first_row(<a class="code" href="../../d0/db0/Tutorial__Map__using_8cpp.html#a7fe964f6b1afd4591f637999272ab9a2">p</a>);</div>
<div class="line"><a name="l05749"></a><span class="lineno"> 5749</span>&#160;            b_nrow_local = col_distribution_pt[blocki]-&gt;nrow_local(<a class="code" href="../../d0/db0/Tutorial__Map__using_8cpp.html#a7fe964f6b1afd4591f637999272ab9a2">p</a>);</div>
<div class="line"><a name="l05750"></a><span class="lineno"> 5750</span>&#160;          }</div>
<div class="line"><a name="l05751"></a><span class="lineno"> 5751</span>&#160;          p_for_rows[blocki][rowi] = <a class="code" href="../../d0/db0/Tutorial__Map__using_8cpp.html#a7fe964f6b1afd4591f637999272ab9a2">p</a>;</div>
<div class="line"><a name="l05752"></a><span class="lineno"> 5752</span>&#160;        }</div>
<div class="line"><a name="l05753"></a><span class="lineno"> 5753</span>&#160;      }</div>
<div class="line"><a name="l05754"></a><span class="lineno"> 5754</span>&#160; </div>
<div class="line"><a name="l05755"></a><span class="lineno"> 5755</span>&#160;      <span class="comment">// determine nnz of all blocks on this processor only.</span></div>
<div class="line"><a name="l05756"></a><span class="lineno"> 5756</span>&#160;      <span class="comment">// This is used to create storage space.</span></div>
<div class="line"><a name="l05757"></a><span class="lineno"> 5757</span>&#160;      <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> res_nnz = 0;</div>
<div class="line"><a name="l05758"></a><span class="lineno"> 5758</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> row_i = 0; row_i &lt; nblock_row; row_i++)</div>
<div class="line"><a name="l05759"></a><span class="lineno"> 5759</span>&#160;      {</div>
<div class="line"><a name="l05760"></a><span class="lineno"> 5760</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> col_i = 0; col_i &lt; nblock_col; col_i++)</div>
<div class="line"><a name="l05761"></a><span class="lineno"> 5761</span>&#160;        {</div>
<div class="line"><a name="l05762"></a><span class="lineno"> 5762</span>&#160;          <span class="keywordflow">if</span> (matrix_pt(row_i, col_i) != 0)</div>
<div class="line"><a name="l05763"></a><span class="lineno"> 5763</span>&#160;          {</div>
<div class="line"><a name="l05764"></a><span class="lineno"> 5764</span>&#160;            res_nnz += matrix_pt(row_i, col_i)-&gt;nnz();</div>
<div class="line"><a name="l05765"></a><span class="lineno"> 5765</span>&#160;          }</div>
<div class="line"><a name="l05766"></a><span class="lineno"> 5766</span>&#160;        }</div>
<div class="line"><a name="l05767"></a><span class="lineno"> 5767</span>&#160;      }</div>
<div class="line"><a name="l05768"></a><span class="lineno"> 5768</span>&#160; </div>
<div class="line"><a name="l05769"></a><span class="lineno"> 5769</span>&#160;      <span class="comment">// My rank</span></div>
<div class="line"><a name="l05770"></a><span class="lineno"> 5770</span>&#160;      <span class="comment">//    unsigned my_rank = comm_pt-&gt;my_rank();</span></div>
<div class="line"><a name="l05771"></a><span class="lineno"> 5771</span>&#160;      <span class="comment">//    my_rank = my_rank;</span></div>
<div class="line"><a name="l05772"></a><span class="lineno"> 5772</span>&#160; </div>
<div class="line"><a name="l05773"></a><span class="lineno"> 5773</span>&#160;      <span class="comment">// Turn the above into a string.</span></div>
<div class="line"><a name="l05774"></a><span class="lineno"> 5774</span>&#160;      <span class="comment">//      std::ostringstream myrankstream;</span></div>
<div class="line"><a name="l05775"></a><span class="lineno"> 5775</span>&#160;      <span class="comment">//      myrankstream &lt;&lt; &quot;THISDOESNOTHINGnp&quot; &lt;&lt; my_rank &lt;&lt; std::endl;</span></div>
<div class="line"><a name="l05776"></a><span class="lineno"> 5776</span>&#160;      <span class="comment">//      std::string myrankstring = myrankstream.str();</span></div>
<div class="line"><a name="l05777"></a><span class="lineno"> 5777</span>&#160; </div>
<div class="line"><a name="l05778"></a><span class="lineno"> 5778</span>&#160; </div>
<div class="line"><a name="l05779"></a><span class="lineno"> 5779</span>&#160;      <span class="comment">// CALLGRIND_ZERO_STATS;</span></div>
<div class="line"><a name="l05780"></a><span class="lineno"> 5780</span>&#160;      <span class="comment">// CALLGRIND_START_INSTRUMENTATION;</span></div>
<div class="line"><a name="l05781"></a><span class="lineno"> 5781</span>&#160; </div>
<div class="line"><a name="l05782"></a><span class="lineno"> 5782</span>&#160;      <span class="comment">// storage for the result matrix.</span></div>
<div class="line"><a name="l05783"></a><span class="lineno"> 5783</span>&#160;      <span class="keywordtype">int</span>* res_row_start = <span class="keyword">new</span> <span class="keywordtype">int</span>[res_nrow_local + 1];</div>
<div class="line"><a name="l05784"></a><span class="lineno"> 5784</span>&#160;      <span class="keywordtype">int</span>* res_column_index = <span class="keyword">new</span> <span class="keywordtype">int</span>[res_nnz];</div>
<div class="line"><a name="l05785"></a><span class="lineno"> 5785</span>&#160;      <span class="keywordtype">double</span>* res_value = <span class="keyword">new</span> <span class="keywordtype">double</span>[res_nnz];</div>
<div class="line"><a name="l05786"></a><span class="lineno"> 5786</span>&#160; </div>
<div class="line"><a name="l05787"></a><span class="lineno"> 5787</span>&#160;      <span class="comment">// initialise the zero-th entry</span></div>
<div class="line"><a name="l05788"></a><span class="lineno"> 5788</span>&#160;      res_row_start[0] = 0;</div>
<div class="line"><a name="l05789"></a><span class="lineno"> 5789</span>&#160; </div>
<div class="line"><a name="l05790"></a><span class="lineno"> 5790</span>&#160;      <span class="comment">// loop over the block rows</span></div>
<div class="line"><a name="l05791"></a><span class="lineno"> 5791</span>&#160;      <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> res_i = 0; <span class="comment">// index for the result matrix.</span></div>
<div class="line"><a name="l05792"></a><span class="lineno"> 5792</span>&#160;      <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> res_row_i = 0; <span class="comment">// index for the row</span></div>
<div class="line"><a name="l05793"></a><span class="lineno"> 5793</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <a class="code" href="../../d5/de3/BiCGSTAB__step__by__step_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a> = 0; <a class="code" href="../../d5/de3/BiCGSTAB__step__by__step_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a> &lt; nblock_row; <a class="code" href="../../d5/de3/BiCGSTAB__step__by__step_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a>++)</div>
<div class="line"><a name="l05794"></a><span class="lineno"> 5794</span>&#160;      {</div>
<div class="line"><a name="l05795"></a><span class="lineno"> 5795</span>&#160;        <span class="comment">// loop over the rows of the current block local rows.</span></div>
<div class="line"><a name="l05796"></a><span class="lineno"> 5796</span>&#160;        <span class="keywordtype">unsigned</span> block_nrow = row_distribution_pt[<a class="code" href="../../d5/de3/BiCGSTAB__step__by__step_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a>]-&gt;nrow_local();</div>
<div class="line"><a name="l05797"></a><span class="lineno"> 5797</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <a class="code" href="../../df/db8/level2__impl_8h.html#ad46ea6bf5745e72b985b11878e46a45d">k</a> = 0; <a class="code" href="../../df/db8/level2__impl_8h.html#ad46ea6bf5745e72b985b11878e46a45d">k</a> &lt; block_nrow; <a class="code" href="../../df/db8/level2__impl_8h.html#ad46ea6bf5745e72b985b11878e46a45d">k</a>++)</div>
<div class="line"><a name="l05798"></a><span class="lineno"> 5798</span>&#160;        {</div>
<div class="line"><a name="l05799"></a><span class="lineno"> 5799</span>&#160;          <span class="comment">// initialise res_row_start</span></div>
<div class="line"><a name="l05800"></a><span class="lineno"> 5800</span>&#160;          res_row_start[res_row_i + 1] = res_row_start[res_row_i];</div>
<div class="line"><a name="l05801"></a><span class="lineno"> 5801</span>&#160; </div>
<div class="line"><a name="l05802"></a><span class="lineno"> 5802</span>&#160;          <span class="comment">// Loop over the block columns</span></div>
<div class="line"><a name="l05803"></a><span class="lineno"> 5803</span>&#160;          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> <a class="code" href="../../da/dd4/tut__arithmetic__redux__minmax_8cpp.html#a39513f0f8d942bf9ef17b2e87ac6d34e">j</a> = 0; <a class="code" href="../../da/dd4/tut__arithmetic__redux__minmax_8cpp.html#a39513f0f8d942bf9ef17b2e87ac6d34e">j</a> &lt; nblock_col; <a class="code" href="../../da/dd4/tut__arithmetic__redux__minmax_8cpp.html#a39513f0f8d942bf9ef17b2e87ac6d34e">j</a>++)</div>
<div class="line"><a name="l05804"></a><span class="lineno"> 5804</span>&#160;          {</div>
<div class="line"><a name="l05805"></a><span class="lineno"> 5805</span>&#160;            <span class="comment">// if block(i,j) pointer is not null then</span></div>
<div class="line"><a name="l05806"></a><span class="lineno"> 5806</span>&#160;            <span class="keywordflow">if</span> (matrix_pt(<a class="code" href="../../d5/de3/BiCGSTAB__step__by__step_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a>, <a class="code" href="../../da/dd4/tut__arithmetic__redux__minmax_8cpp.html#a39513f0f8d942bf9ef17b2e87ac6d34e">j</a>) != 0)</div>
<div class="line"><a name="l05807"></a><span class="lineno"> 5807</span>&#160;            {</div>
<div class="line"><a name="l05808"></a><span class="lineno"> 5808</span>&#160;              <span class="comment">// get pointers for the elements in the current block</span></div>
<div class="line"><a name="l05809"></a><span class="lineno"> 5809</span>&#160;              <span class="keywordtype">int</span>* b_row_start = matrix_pt(<a class="code" href="../../d5/de3/BiCGSTAB__step__by__step_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a>, <a class="code" href="../../da/dd4/tut__arithmetic__redux__minmax_8cpp.html#a39513f0f8d942bf9ef17b2e87ac6d34e">j</a>)-&gt;row_start();</div>
<div class="line"><a name="l05810"></a><span class="lineno"> 5810</span>&#160;              <span class="keywordtype">int</span>* b_column_index = matrix_pt(<a class="code" href="../../d5/de3/BiCGSTAB__step__by__step_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a>, <a class="code" href="../../da/dd4/tut__arithmetic__redux__minmax_8cpp.html#a39513f0f8d942bf9ef17b2e87ac6d34e">j</a>)-&gt;column_index();</div>
<div class="line"><a name="l05811"></a><span class="lineno"> 5811</span>&#160;              <span class="keywordtype">double</span>* b_value = matrix_pt(<a class="code" href="../../d5/de3/BiCGSTAB__step__by__step_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a>, <a class="code" href="../../da/dd4/tut__arithmetic__redux__minmax_8cpp.html#a39513f0f8d942bf9ef17b2e87ac6d34e">j</a>)-&gt;value();</div>
<div class="line"><a name="l05812"></a><span class="lineno"> 5812</span>&#160; </div>
<div class="line"><a name="l05813"></a><span class="lineno"> 5813</span>&#160;              <span class="comment">// memcpy( &amp;dst[dstIdx], &amp;src[srcIdx], numElementsToCopy * sizeof(</span></div>
<div class="line"><a name="l05814"></a><span class="lineno"> 5814</span>&#160;              <span class="comment">// Element ) );</span></div>
<div class="line"><a name="l05815"></a><span class="lineno"> 5815</span>&#160;              <span class="comment">// no ele to copy</span></div>
<div class="line"><a name="l05816"></a><span class="lineno"> 5816</span>&#160;              <span class="keywordtype">int</span> numEleToCopy = b_row_start[<a class="code" href="../../df/db8/level2__impl_8h.html#ad46ea6bf5745e72b985b11878e46a45d">k</a> + 1] - b_row_start[<a class="code" href="../../df/db8/level2__impl_8h.html#ad46ea6bf5745e72b985b11878e46a45d">k</a>];</div>
<div class="line"><a name="l05817"></a><span class="lineno"> 5817</span>&#160;              memcpy(res_value + res_i,</div>
<div class="line"><a name="l05818"></a><span class="lineno"> 5818</span>&#160;                     b_value + b_row_start[<a class="code" href="../../df/db8/level2__impl_8h.html#ad46ea6bf5745e72b985b11878e46a45d">k</a>],</div>
<div class="line"><a name="l05819"></a><span class="lineno"> 5819</span>&#160;                     numEleToCopy * <span class="keyword">sizeof</span>(<span class="keywordtype">double</span>));</div>
<div class="line"><a name="l05820"></a><span class="lineno"> 5820</span>&#160;              <span class="comment">// Loop through the current local row.</span></div>
<div class="line"><a name="l05821"></a><span class="lineno"> 5821</span>&#160;              <span class="keywordflow">for</span> (<span class="keywordtype">int</span> l = b_row_start[<a class="code" href="../../df/db8/level2__impl_8h.html#ad46ea6bf5745e72b985b11878e46a45d">k</a>]; l &lt; b_row_start[<a class="code" href="../../df/db8/level2__impl_8h.html#ad46ea6bf5745e72b985b11878e46a45d">k</a> + 1]; l++)</div>
<div class="line"><a name="l05822"></a><span class="lineno"> 5822</span>&#160;              {</div>
<div class="line"><a name="l05823"></a><span class="lineno"> 5823</span>&#160;                <span class="comment">// if b_column_index[l] was a row index, what processor</span></div>
<div class="line"><a name="l05824"></a><span class="lineno"> 5824</span>&#160;                <span class="comment">// would it be on</span></div>
<div class="line"><a name="l05825"></a><span class="lineno"> 5825</span>&#160;                <span class="comment">//            unsigned p = col_distribution_pt[j]</span></div>
<div class="line"><a name="l05826"></a><span class="lineno"> 5826</span>&#160;                <span class="comment">//              -&gt;rank_of_global_row_map(b_column_index[l]);</span></div>
<div class="line"><a name="l05827"></a><span class="lineno"> 5827</span>&#160;                <span class="keywordtype">unsigned</span> <a class="code" href="../../d0/db0/Tutorial__Map__using_8cpp.html#a7fe964f6b1afd4591f637999272ab9a2">p</a> = p_for_rows[<a class="code" href="../../da/dd4/tut__arithmetic__redux__minmax_8cpp.html#a39513f0f8d942bf9ef17b2e87ac6d34e">j</a>][b_column_index[l]];</div>
<div class="line"><a name="l05828"></a><span class="lineno"> 5828</span>&#160; </div>
<div class="line"><a name="l05829"></a><span class="lineno"> 5829</span>&#160;                <span class="keywordtype">int</span> b_first_row = col_distribution_pt[<a class="code" href="../../da/dd4/tut__arithmetic__redux__minmax_8cpp.html#a39513f0f8d942bf9ef17b2e87ac6d34e">j</a>]-&gt;first_row(<a class="code" href="../../d0/db0/Tutorial__Map__using_8cpp.html#a7fe964f6b1afd4591f637999272ab9a2">p</a>);</div>
<div class="line"><a name="l05830"></a><span class="lineno"> 5830</span>&#160;                <span class="comment">//            int b_nrow_local =</span></div>
<div class="line"><a name="l05831"></a><span class="lineno"> 5831</span>&#160;                <span class="comment">//            col_distribution_pt[j]-&gt;nrow_local(p);</span></div>
<div class="line"><a name="l05832"></a><span class="lineno"> 5832</span>&#160; </div>
<div class="line"><a name="l05833"></a><span class="lineno"> 5833</span>&#160;                <span class="comment">//            while (b_column_index[l] &lt; b_first_row ||</span></div>
<div class="line"><a name="l05834"></a><span class="lineno"> 5834</span>&#160;                <span class="comment">//                   b_column_index[l] &gt;=</span></div>
<div class="line"><a name="l05835"></a><span class="lineno"> 5835</span>&#160;                <span class="comment">//                   b_nrow_local+b_first_row)</span></div>
<div class="line"><a name="l05836"></a><span class="lineno"> 5836</span>&#160;                <span class="comment">//             {</span></div>
<div class="line"><a name="l05837"></a><span class="lineno"> 5837</span>&#160;                <span class="comment">//              p++;</span></div>
<div class="line"><a name="l05838"></a><span class="lineno"> 5838</span>&#160;                <span class="comment">//              b_first_row =</span></div>
<div class="line"><a name="l05839"></a><span class="lineno"> 5839</span>&#160;                <span class="comment">//              col_distribution_pt[j]-&gt;first_row(p);</span></div>
<div class="line"><a name="l05840"></a><span class="lineno"> 5840</span>&#160;                <span class="comment">//              b_nrow_local =</span></div>
<div class="line"><a name="l05841"></a><span class="lineno"> 5841</span>&#160;                <span class="comment">//              col_distribution_pt[j]-&gt;nrow_local(p);</span></div>
<div class="line"><a name="l05842"></a><span class="lineno"> 5842</span>&#160;                <span class="comment">//             }</span></div>
<div class="line"><a name="l05843"></a><span class="lineno"> 5843</span>&#160; </div>
<div class="line"><a name="l05844"></a><span class="lineno"> 5844</span>&#160;                <span class="comment">// determine the local equation number in the block j/processor</span></div>
<div class="line"><a name="l05845"></a><span class="lineno"> 5845</span>&#160;                <span class="comment">// p &quot;column block&quot;</span></div>
<div class="line"><a name="l05846"></a><span class="lineno"> 5846</span>&#160;                <span class="keywordtype">int</span> eqn = b_column_index[l] - b_first_row;</div>
<div class="line"><a name="l05847"></a><span class="lineno"> 5847</span>&#160; </div>
<div class="line"><a name="l05848"></a><span class="lineno"> 5848</span>&#160;                <span class="comment">// add to the result matrix</span></div>
<div class="line"><a name="l05849"></a><span class="lineno"> 5849</span>&#160;                <span class="comment">//            res_value[res_i] = b_value[l];</span></div>
<div class="line"><a name="l05850"></a><span class="lineno"> 5850</span>&#160;                res_column_index[res_i] = col_offset[<a class="code" href="../../d0/db0/Tutorial__Map__using_8cpp.html#a7fe964f6b1afd4591f637999272ab9a2">p</a>][<a class="code" href="../../da/dd4/tut__arithmetic__redux__minmax_8cpp.html#a39513f0f8d942bf9ef17b2e87ac6d34e">j</a>] + eqn;</div>
<div class="line"><a name="l05851"></a><span class="lineno"> 5851</span>&#160;                res_row_start[res_row_i + 1]++;</div>
<div class="line"><a name="l05852"></a><span class="lineno"> 5852</span>&#160;                res_i++;</div>
<div class="line"><a name="l05853"></a><span class="lineno"> 5853</span>&#160;              }</div>
<div class="line"><a name="l05854"></a><span class="lineno"> 5854</span>&#160;            }</div>
<div class="line"><a name="l05855"></a><span class="lineno"> 5855</span>&#160;          }</div>
<div class="line"><a name="l05856"></a><span class="lineno"> 5856</span>&#160; </div>
<div class="line"><a name="l05857"></a><span class="lineno"> 5857</span>&#160;          <span class="comment">// increment the row pt</span></div>
<div class="line"><a name="l05858"></a><span class="lineno"> 5858</span>&#160;          res_row_i++;</div>
<div class="line"><a name="l05859"></a><span class="lineno"> 5859</span>&#160;        }</div>
<div class="line"><a name="l05860"></a><span class="lineno"> 5860</span>&#160;      }</div>
<div class="line"><a name="l05861"></a><span class="lineno"> 5861</span>&#160;      <span class="comment">// CALLGRIND_STOP_INSTRUMENTATION;</span></div>
<div class="line"><a name="l05862"></a><span class="lineno"> 5862</span>&#160;      <span class="comment">// CALLGRIND_DUMP_STATS_AT(myrankstring.c_str());</span></div>
<div class="line"><a name="l05863"></a><span class="lineno"> 5863</span>&#160; </div>
<div class="line"><a name="l05864"></a><span class="lineno"> 5864</span>&#160; </div>
<div class="line"><a name="l05865"></a><span class="lineno"> 5865</span>&#160;      <span class="comment">// Get the number of columns of the result matrix.</span></div>
<div class="line"><a name="l05866"></a><span class="lineno"> 5866</span>&#160;      <span class="keywordtype">unsigned</span> res_ncol = 0;</div>
<div class="line"><a name="l05867"></a><span class="lineno"> 5867</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 0; block_col_i &lt; matrix_ncol; block_col_i++)</div>
<div class="line"><a name="l05868"></a><span class="lineno"> 5868</span>&#160;      {</div>
<div class="line"><a name="l05869"></a><span class="lineno"> 5869</span>&#160;        res_ncol += col_distribution_pt[block_col_i]-&gt;nrow();</div>
<div class="line"><a name="l05870"></a><span class="lineno"> 5870</span>&#160;      }</div>
<div class="line"><a name="l05871"></a><span class="lineno"> 5871</span>&#160; </div>
<div class="line"><a name="l05872"></a><span class="lineno"> 5872</span>&#160;      <span class="comment">// Build the result matrix.</span></div>
<div class="line"><a name="l05873"></a><span class="lineno"> 5873</span>&#160;      result_matrix.build_without_copy(</div>
<div class="line"><a name="l05874"></a><span class="lineno"> 5874</span>&#160;        res_ncol, res_nnz, res_value, res_column_index, res_row_start);</div>
<div class="line"><a name="l05875"></a><span class="lineno"> 5875</span>&#160;    }</div>
<div class="ttc" id="aBiCGSTAB__step__by__step_8cpp_html_acb559820d9ca11295b4500f179ef6392"><div class="ttname"><a href="../../d5/de3/BiCGSTAB__step__by__step_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a></div><div class="ttdeci">int i</div><div class="ttdef"><b>Definition:</b> BiCGSTAB_step_by_step.cpp:9</div></div>
<div class="ttc" id="aTutorial__Map__using_8cpp_html_a7fe964f6b1afd4591f637999272ab9a2"><div class="ttname"><a href="../../d0/db0/Tutorial__Map__using_8cpp.html#a7fe964f6b1afd4591f637999272ab9a2">p</a></div><div class="ttdeci">float * p</div><div class="ttdef"><b>Definition:</b> Tutorial_Map_using.cpp:9</div></div>
<div class="ttc" id="alevel2__impl_8h_html_ad46ea6bf5745e72b985b11878e46a45d"><div class="ttname"><a href="../../df/db8/level2__impl_8h.html#ad46ea6bf5745e72b985b11878e46a45d">k</a></div><div class="ttdeci">char char char int int * k</div><div class="ttdef"><b>Definition:</b> level2_impl.h:374</div></div>
<div class="ttc" id="anamespaceoomph_1_1CRDoubleMatrixHelpers_html_ab7e3ac344aa644292a143a3917a03e65"><div class="ttname"><a href="../../dd/d95/namespaceoomph_1_1CRDoubleMatrixHelpers.html#ab7e3ac344aa644292a143a3917a03e65">oomph::CRDoubleMatrixHelpers::concatenate</a></div><div class="ttdeci">void concatenate(const DenseMatrix&lt; CRDoubleMatrix * &gt; &amp;matrix_pt, CRDoubleMatrix &amp;result_matrix)</div><div class="ttdef"><b>Definition:</b> matrices.cc:4349</div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html#af44bac2acd071317f96dae49cbb0d977">oomph::CRDoubleMatrix::build()</a>, <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html#aafb4d7de0a87b4bda560928e6a128060">oomph::CRDoubleMatrix::build_without_copy()</a>, <a class="el" href="../../de/dcb/classoomph_1_1LinearAlgebraDistribution.html#a92bfff97fd228b9c528922c39ab563b2">oomph::LinearAlgebraDistribution::built()</a>, <a class="el" href="../../de/dcb/classoomph_1_1LinearAlgebraDistribution.html#a2e4736826a65253f574d4f6f152ab514">oomph::LinearAlgebraDistribution::communicator_pt()</a>, <a class="el" href="../../d4/dd0/namespaceoomph_1_1LinearAlgebraDistributionHelpers.html#af11187289196182ce650da88cfe37fc2">oomph::LinearAlgebraDistributionHelpers::concatenate()</a>, <a class="el" href="../../df/d1e/classoomph_1_1DistributableLinearAlgebraObject.html#a5505731e7e73d7e4251c67c7adec6bf5">oomph::DistributableLinearAlgebraObject::distributed()</a>, <a class="el" href="../../df/d1e/classoomph_1_1DistributableLinearAlgebraObject.html#a603105384d60c9a3710378af39f538b9">oomph::DistributableLinearAlgebraObject::distribution_pt()</a>, <a class="el" href="../../d5/de3/BiCGSTAB__step__by__step_8cpp.html#acb559820d9ca11295b4500f179ef6392">i</a>, <a class="el" href="../../da/dd4/tut__arithmetic__redux__minmax_8cpp.html#a39513f0f8d942bf9ef17b2e87ac6d34e">j</a>, <a class="el" href="../../df/db8/level2__impl_8h.html#ad46ea6bf5745e72b985b11878e46a45d">k</a>, <a class="el" href="../../d6/d13/classoomph_1_1DenseMatrix.html#a9937181f1cb4cfaed7aaf3b483c42456">oomph::DenseMatrix&lt; T &gt;::ncol()</a>, <a class="el" href="../../de/d83/classoomph_1_1OomphCommunicator.html#a6c78c72666f4b102c2bccf200f0853b7">oomph::OomphCommunicator::nproc()</a>, <a class="el" href="../../d6/d13/classoomph_1_1DenseMatrix.html#a1b425094510d833ffe91920747a0a962">oomph::DenseMatrix&lt; T &gt;::nrow()</a>, <a class="el" href="../../de/dcb/classoomph_1_1LinearAlgebraDistribution.html#ac9310de740f9c3a61f8d5dab9bef88ca">oomph::LinearAlgebraDistribution::nrow_local()</a>, <a class="el" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>, <a class="el" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>, and <a class="el" href="../../d0/db0/Tutorial__Map__using_8cpp.html#a7fe964f6b1afd4591f637999272ab9a2">p</a>.</p>

<p class="reference">Referenced by <a class="el" href="../../dd/d95/namespaceoomph_1_1CRDoubleMatrixHelpers.html#ac04e094c973da752da4b76071ad09f44">concatenate_without_communication()</a>, <a class="el" href="../../dd/d57/classoomph_1_1BlockPreconditioner.html#a72b4dbe167da59d9ba12c7eff97d77e6">oomph::BlockPreconditioner&lt; MATRIX &gt;::get_block()</a>, <a class="el" href="../../dd/d57/classoomph_1_1BlockPreconditioner.html#a51636746e5921ee2845daf60b1c322dc">oomph::BlockPreconditioner&lt; MATRIX &gt;::get_concatenated_block()</a>, and <a class="el" href="../../da/d23/matrix__concatenation__without__communication_8cc.html#a0ddf1224851353fc92bfbff6f499fa97">main()</a>.</p>

</div>
</div>
<a id="ae3c10e59d5857457c7e34be8e9262035"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae3c10e59d5857457c7e34be8e9262035">&#9670;&nbsp;</a></span>create_uniformly_distributed_matrix()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void oomph::CRDoubleMatrixHelpers::create_uniformly_distributed_matrix </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="../../d0/d1d/classunsigned.html">unsigned</a> &amp;&#160;</td>
          <td class="paramname"><em>nrow</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="../../d0/d1d/classunsigned.html">unsigned</a> &amp;&#160;</td>
          <td class="paramname"><em>ncol</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="../../de/d83/classoomph_1_1OomphCommunicator.html">OomphCommunicator</a> *const&#160;</td>
          <td class="paramname"><em>comm_pt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="../../d4/df6/classoomph_1_1Vector.html">Vector</a>&lt; <a class="el" href="../../df/de6/classdouble.html">double</a> &gt; &amp;&#160;</td>
          <td class="paramname"><em>values</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="../../d4/df6/classoomph_1_1Vector.html">Vector</a>&lt; <a class="el" href="../../d9/d2a/level1__real__impl_8h.html#a4e8e1c1bb9d4e05fc671fc133ec9dc9b">int</a> &gt; &amp;&#160;</td>
          <td class="paramname"><em>column_indices</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const <a class="el" href="../../d4/df6/classoomph_1_1Vector.html">Vector</a>&lt; <a class="el" href="../../d9/d2a/level1__real__impl_8h.html#a4e8e1c1bb9d4e05fc671fc133ec9dc9b">int</a> &gt; &amp;&#160;</td>
          <td class="paramname"><em>row_start</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html">CRDoubleMatrix</a> &amp;&#160;</td>
          <td class="paramname"><em>matrix_out</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Builds a uniformly distributed matrix. A locally replicated matrix is constructed then redistributed using OOMPH-LIB's default uniform row distribution. This is memory intensive thus should be used for testing or small problems only.</p>
<p>Builds a uniformly distributed matrix. A locally replicated matrix is constructed then redistributed using OOMPH-LIB's default uniform row distribution. This is memory intensive thus should be used for testing or small problems only. The resulting matrix (mat_out) must not have been built. </p>
<div class="fragment"><div class="line"><a name="l03684"></a><span class="lineno"> 3684</span>&#160;    {</div>
<div class="line"><a name="l03685"></a><span class="lineno"> 3685</span>&#160;<span class="preprocessor">#ifdef PARANOID</span></div>
<div class="line"><a name="l03686"></a><span class="lineno"> 3686</span>&#160;      <span class="comment">// Check if the communicator exists.</span></div>
<div class="line"><a name="l03687"></a><span class="lineno"> 3687</span>&#160;      <span class="keywordflow">if</span> (comm_pt == 0)</div>
<div class="line"><a name="l03688"></a><span class="lineno"> 3688</span>&#160;      {</div>
<div class="line"><a name="l03689"></a><span class="lineno"> 3689</span>&#160;        std::ostringstream error_message;</div>
<div class="line"><a name="l03690"></a><span class="lineno"> 3690</span>&#160;        error_message &lt;&lt; <span class="stringliteral">&quot;Please supply the communicator.\n&quot;</span>;</div>
<div class="line"><a name="l03691"></a><span class="lineno"> 3691</span>&#160;        <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l03692"></a><span class="lineno"> 3692</span>&#160;                            <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l03693"></a><span class="lineno"> 3693</span>&#160;                            <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l03694"></a><span class="lineno"> 3694</span>&#160;      }</div>
<div class="line"><a name="l03695"></a><span class="lineno"> 3695</span>&#160;      <span class="comment">// Is the out matrix built? We need an empty matrix!</span></div>
<div class="line"><a name="l03696"></a><span class="lineno"> 3696</span>&#160;      <span class="keywordflow">if</span> (matrix_out.built())</div>
<div class="line"><a name="l03697"></a><span class="lineno"> 3697</span>&#160;      {</div>
<div class="line"><a name="l03698"></a><span class="lineno"> 3698</span>&#160;        std::ostringstream error_message;</div>
<div class="line"><a name="l03699"></a><span class="lineno"> 3699</span>&#160;        error_message &lt;&lt; <span class="stringliteral">&quot;The result matrix has been built.\n&quot;</span></div>
<div class="line"><a name="l03700"></a><span class="lineno"> 3700</span>&#160;                      &lt;&lt; <span class="stringliteral">&quot;Please clear the matrix.\n&quot;</span>;</div>
<div class="line"><a name="l03701"></a><span class="lineno"> 3701</span>&#160;        <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l03702"></a><span class="lineno"> 3702</span>&#160;                            <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l03703"></a><span class="lineno"> 3703</span>&#160;                            <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l03704"></a><span class="lineno"> 3704</span>&#160;      }</div>
<div class="line"><a name="l03705"></a><span class="lineno"> 3705</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03706"></a><span class="lineno"> 3706</span>&#160; </div>
<div class="line"><a name="l03707"></a><span class="lineno"> 3707</span>&#160;      <span class="comment">// Create the locally replicated distribution.</span></div>
<div class="line"><a name="l03708"></a><span class="lineno"> 3708</span>&#160;      <span class="keywordtype">bool</span> distributed = <span class="keyword">false</span>;</div>
<div class="line"><a name="l03709"></a><span class="lineno"> 3709</span>&#160;      LinearAlgebraDistribution locally_replicated_distribution(</div>
<div class="line"><a name="l03710"></a><span class="lineno"> 3710</span>&#160;        comm_pt, nrow, distributed);</div>
<div class="line"><a name="l03711"></a><span class="lineno"> 3711</span>&#160; </div>
<div class="line"><a name="l03712"></a><span class="lineno"> 3712</span>&#160;      <span class="comment">// Create the matrix.</span></div>
<div class="line"><a name="l03713"></a><span class="lineno"> 3713</span>&#160;      matrix_out.build(&amp;locally_replicated_distribution,</div>
<div class="line"><a name="l03714"></a><span class="lineno"> 3714</span>&#160;                       ncol,</div>
<div class="line"><a name="l03715"></a><span class="lineno"> 3715</span>&#160;                       values,</div>
<div class="line"><a name="l03716"></a><span class="lineno"> 3716</span>&#160;                       column_indices,</div>
<div class="line"><a name="l03717"></a><span class="lineno"> 3717</span>&#160;                       row_start);</div>
<div class="line"><a name="l03718"></a><span class="lineno"> 3718</span>&#160; </div>
<div class="line"><a name="l03719"></a><span class="lineno"> 3719</span>&#160;      <span class="comment">// Create the distributed distribution.</span></div>
<div class="line"><a name="l03720"></a><span class="lineno"> 3720</span>&#160;      distributed = <span class="keyword">true</span>;</div>
<div class="line"><a name="l03721"></a><span class="lineno"> 3721</span>&#160;      LinearAlgebraDistribution distributed_distribution(</div>
<div class="line"><a name="l03722"></a><span class="lineno"> 3722</span>&#160;        comm_pt, nrow, distributed);</div>
<div class="line"><a name="l03723"></a><span class="lineno"> 3723</span>&#160; </div>
<div class="line"><a name="l03724"></a><span class="lineno"> 3724</span>&#160;      <span class="comment">// Redistribute the matrix.</span></div>
<div class="line"><a name="l03725"></a><span class="lineno"> 3725</span>&#160;      matrix_out.redistribute(&amp;distributed_distribution);</div>
<div class="line"><a name="l03726"></a><span class="lineno"> 3726</span>&#160;    }</div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html#af44bac2acd071317f96dae49cbb0d977">oomph::CRDoubleMatrix::build()</a>, <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html#aa0503bc64ef0ccb60cb7d7e645425a62">oomph::CRDoubleMatrix::built()</a>, <a class="el" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>, <a class="el" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>, and <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html#a9ba295a04e08e3153ae06bc0556f507d">oomph::CRDoubleMatrix::redistribute()</a>.</p>

<p class="reference">Referenced by <a class="el" href="../../df/d96/crdoublematrix__copy__constructor_8cc.html#a0ddf1224851353fc92bfbff6f499fa97">main()</a>.</p>

</div>
</div>
<a id="a157511f700993ab8bc014f9d0d44f4c7"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a157511f700993ab8bc014f9d0d44f4c7">&#9670;&nbsp;</a></span>deep_copy()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">void oomph::CRDoubleMatrixHelpers::deep_copy </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html">CRDoubleMatrix</a> *const&#160;</td>
          <td class="paramname"><em>in_matrix_pt</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html">CRDoubleMatrix</a> &amp;&#160;</td>
          <td class="paramname"><em>out_matrix</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel">inline</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">

<p>Create a deep copy of the matrix pointed to by in_matrix_pt. </p>
<div class="fragment"><div class="line"><a name="l03492"></a><span class="lineno"> 3492</span>&#160;    {</div>
<div class="line"><a name="l03493"></a><span class="lineno"> 3493</span>&#160;<span class="preprocessor">#ifdef PARANOID</span></div>
<div class="line"><a name="l03494"></a><span class="lineno"> 3494</span>&#160;      <span class="comment">// Is the out matrix built? We need an empty out matrix!</span></div>
<div class="line"><a name="l03495"></a><span class="lineno"> 3495</span>&#160;      <span class="keywordflow">if</span> (out_matrix.built())</div>
<div class="line"><a name="l03496"></a><span class="lineno"> 3496</span>&#160;      {</div>
<div class="line"><a name="l03497"></a><span class="lineno"> 3497</span>&#160;        std::ostringstream err_msg;</div>
<div class="line"><a name="l03498"></a><span class="lineno"> 3498</span>&#160;        err_msg &lt;&lt; <span class="stringliteral">&quot;The result matrix has been built.\n&quot;</span></div>
<div class="line"><a name="l03499"></a><span class="lineno"> 3499</span>&#160;                &lt;&lt; <span class="stringliteral">&quot;Please clear the matrix.\n&quot;</span>;</div>
<div class="line"><a name="l03500"></a><span class="lineno"> 3500</span>&#160;        <span class="keywordflow">throw</span> OomphLibError(</div>
<div class="line"><a name="l03501"></a><span class="lineno"> 3501</span>&#160;          err_msg.str(), <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>, <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l03502"></a><span class="lineno"> 3502</span>&#160;      }</div>
<div class="line"><a name="l03503"></a><span class="lineno"> 3503</span>&#160; </div>
<div class="line"><a name="l03504"></a><span class="lineno"> 3504</span>&#160;      <span class="comment">// Check that the in matrix pointer is not null.</span></div>
<div class="line"><a name="l03505"></a><span class="lineno"> 3505</span>&#160;      <span class="keywordflow">if</span> (in_matrix_pt == 0)</div>
<div class="line"><a name="l03506"></a><span class="lineno"> 3506</span>&#160;      {</div>
<div class="line"><a name="l03507"></a><span class="lineno"> 3507</span>&#160;        std::ostringstream err_msg;</div>
<div class="line"><a name="l03508"></a><span class="lineno"> 3508</span>&#160;        err_msg &lt;&lt; <span class="stringliteral">&quot;The in_matrix_pt is null.\n&quot;</span>;</div>
<div class="line"><a name="l03509"></a><span class="lineno"> 3509</span>&#160;        <span class="keywordflow">throw</span> OomphLibError(</div>
<div class="line"><a name="l03510"></a><span class="lineno"> 3510</span>&#160;          err_msg.str(), <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>, <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l03511"></a><span class="lineno"> 3511</span>&#160;      }</div>
<div class="line"><a name="l03512"></a><span class="lineno"> 3512</span>&#160; </div>
<div class="line"><a name="l03513"></a><span class="lineno"> 3513</span>&#160;      <span class="comment">// Check that the in matrix is built.</span></div>
<div class="line"><a name="l03514"></a><span class="lineno"> 3514</span>&#160;      <span class="keywordflow">if</span> (!in_matrix_pt-&gt;built())</div>
<div class="line"><a name="l03515"></a><span class="lineno"> 3515</span>&#160;      {</div>
<div class="line"><a name="l03516"></a><span class="lineno"> 3516</span>&#160;        std::ostringstream err_msg;</div>
<div class="line"><a name="l03517"></a><span class="lineno"> 3517</span>&#160;        err_msg &lt;&lt; <span class="stringliteral">&quot;The in_matrix_pt is null.\n&quot;</span>;</div>
<div class="line"><a name="l03518"></a><span class="lineno"> 3518</span>&#160;        <span class="keywordflow">throw</span> OomphLibError(</div>
<div class="line"><a name="l03519"></a><span class="lineno"> 3519</span>&#160;          err_msg.str(), <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>, <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l03520"></a><span class="lineno"> 3520</span>&#160;      }</div>
<div class="line"><a name="l03521"></a><span class="lineno"> 3521</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03522"></a><span class="lineno"> 3522</span>&#160; </div>
<div class="line"><a name="l03523"></a><span class="lineno"> 3523</span>&#160;      <span class="comment">// First set the matrix matrix multiply methods (for both serial and</span></div>
<div class="line"><a name="l03524"></a><span class="lineno"> 3524</span>&#160;      <span class="comment">// distributed)</span></div>
<div class="line"><a name="l03525"></a><span class="lineno"> 3525</span>&#160;      out_matrix.serial_matrix_matrix_multiply_method() =</div>
<div class="line"><a name="l03526"></a><span class="lineno"> 3526</span>&#160;        in_matrix_pt-&gt;serial_matrix_matrix_multiply_method();</div>
<div class="line"><a name="l03527"></a><span class="lineno"> 3527</span>&#160; </div>
<div class="line"><a name="l03528"></a><span class="lineno"> 3528</span>&#160;      out_matrix.distributed_matrix_matrix_multiply_method() =</div>
<div class="line"><a name="l03529"></a><span class="lineno"> 3529</span>&#160;        in_matrix_pt-&gt;distributed_matrix_matrix_multiply_method();</div>
<div class="line"><a name="l03530"></a><span class="lineno"> 3530</span>&#160; </div>
<div class="line"><a name="l03531"></a><span class="lineno"> 3531</span>&#160; </div>
<div class="line"><a name="l03532"></a><span class="lineno"> 3532</span>&#160;      <span class="comment">// The local nrow and nnz of the in matrix</span></div>
<div class="line"><a name="l03533"></a><span class="lineno"> 3533</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> in_nrow_local = in_matrix_pt-&gt;nrow_local();</div>
<div class="line"><a name="l03534"></a><span class="lineno"> 3534</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> in_nnz = in_matrix_pt-&gt;nnz();</div>
<div class="line"><a name="l03535"></a><span class="lineno"> 3535</span>&#160; </div>
<div class="line"><a name="l03536"></a><span class="lineno"> 3536</span>&#160;      <span class="comment">// Storage for the values, column indices and row start</span></div>
<div class="line"><a name="l03537"></a><span class="lineno"> 3537</span>&#160;      <span class="keywordtype">double</span>* out_values = <span class="keyword">new</span> <span class="keywordtype">double</span>[in_nnz];</div>
<div class="line"><a name="l03538"></a><span class="lineno"> 3538</span>&#160;      <span class="keywordtype">int</span>* out_column_indices = <span class="keyword">new</span> <span class="keywordtype">int</span>[in_nnz];</div>
<div class="line"><a name="l03539"></a><span class="lineno"> 3539</span>&#160;      <span class="keywordtype">int</span>* out_row_start = <span class="keyword">new</span> <span class="keywordtype">int</span>[in_nrow_local + 1];</div>
<div class="line"><a name="l03540"></a><span class="lineno"> 3540</span>&#160; </div>
<div class="line"><a name="l03541"></a><span class="lineno"> 3541</span>&#160;      <span class="comment">// The data to copy over</span></div>
<div class="line"><a name="l03542"></a><span class="lineno"> 3542</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">double</span>* <span class="keyword">const</span> in_values = in_matrix_pt-&gt;value();</div>
<div class="line"><a name="l03543"></a><span class="lineno"> 3543</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">int</span>* <span class="keyword">const</span> in_column_indices = in_matrix_pt-&gt;column_index();</div>
<div class="line"><a name="l03544"></a><span class="lineno"> 3544</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">int</span>* <span class="keyword">const</span> in_row_start = in_matrix_pt-&gt;row_start();</div>
<div class="line"><a name="l03545"></a><span class="lineno"> 3545</span>&#160; </div>
<div class="line"><a name="l03546"></a><span class="lineno"> 3546</span>&#160;      <span class="comment">// Copy the data</span></div>
<div class="line"><a name="l03547"></a><span class="lineno"> 3547</span>&#160;      <a class="code" href="../../de/d6c/level1__impl_8h.html#af1eb30bd79553c9e566435de1f82a94f">std::copy</a>(in_values, in_values + in_nnz, out_values);</div>
<div class="line"><a name="l03548"></a><span class="lineno"> 3548</span>&#160; </div>
<div class="line"><a name="l03549"></a><span class="lineno"> 3549</span>&#160;      <a class="code" href="../../de/d6c/level1__impl_8h.html#af1eb30bd79553c9e566435de1f82a94f">std::copy</a>(</div>
<div class="line"><a name="l03550"></a><span class="lineno"> 3550</span>&#160;        in_column_indices, in_column_indices + in_nnz, out_column_indices);</div>
<div class="line"><a name="l03551"></a><span class="lineno"> 3551</span>&#160; </div>
<div class="line"><a name="l03552"></a><span class="lineno"> 3552</span>&#160;      <a class="code" href="../../de/d6c/level1__impl_8h.html#af1eb30bd79553c9e566435de1f82a94f">std::copy</a>(</div>
<div class="line"><a name="l03553"></a><span class="lineno"> 3553</span>&#160;        in_row_start, in_row_start + (in_nrow_local + 1), out_row_start);</div>
<div class="line"><a name="l03554"></a><span class="lineno"> 3554</span>&#160; </div>
<div class="line"><a name="l03555"></a><span class="lineno"> 3555</span>&#160;      <span class="comment">// Build the matrix</span></div>
<div class="line"><a name="l03556"></a><span class="lineno"> 3556</span>&#160;      out_matrix.build(in_matrix_pt-&gt;distribution_pt());</div>
<div class="line"><a name="l03557"></a><span class="lineno"> 3557</span>&#160; </div>
<div class="line"><a name="l03558"></a><span class="lineno"> 3558</span>&#160;      out_matrix.build_without_copy(in_matrix_pt-&gt;ncol(),</div>
<div class="line"><a name="l03559"></a><span class="lineno"> 3559</span>&#160;                                    in_nnz,</div>
<div class="line"><a name="l03560"></a><span class="lineno"> 3560</span>&#160;                                    out_values,</div>
<div class="line"><a name="l03561"></a><span class="lineno"> 3561</span>&#160;                                    out_column_indices,</div>
<div class="line"><a name="l03562"></a><span class="lineno"> 3562</span>&#160;                                    out_row_start);</div>
<div class="line"><a name="l03563"></a><span class="lineno"> 3563</span>&#160; </div>
<div class="line"><a name="l03564"></a><span class="lineno"> 3564</span>&#160;      <span class="comment">// The only thing we haven&#39;t copied over is the default linear solver</span></div>
<div class="line"><a name="l03565"></a><span class="lineno"> 3565</span>&#160;      <span class="comment">// pointer, but I cannot figure out how to copy over a solver since</span></div>
<div class="line"><a name="l03566"></a><span class="lineno"> 3566</span>&#160;      <span class="comment">// I do not know what it is.</span></div>
<div class="line"><a name="l03567"></a><span class="lineno"> 3567</span>&#160;    } <span class="comment">// EoFunc deep_copy</span></div>
<div class="ttc" id="alevel1__impl_8h_html_af1eb30bd79553c9e566435de1f82a94f"><div class="ttname"><a href="../../de/d6c/level1__impl_8h.html#af1eb30bd79553c9e566435de1f82a94f">copy</a></div><div class="ttdeci">EIGEN_BLAS_FUNC() copy(int *n, RealScalar *px, int *incx, RealScalar *py, int *incy)</div><div class="ttdef"><b>Definition:</b> level1_impl.h:32</div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html#af44bac2acd071317f96dae49cbb0d977">oomph::CRDoubleMatrix::build()</a>, <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html#aafb4d7de0a87b4bda560928e6a128060">oomph::CRDoubleMatrix::build_without_copy()</a>, <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html#aa0503bc64ef0ccb60cb7d7e645425a62">oomph::CRDoubleMatrix::built()</a>, <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html#a21b3dbb8ee74e1247f80ce4506c395f8">oomph::CRDoubleMatrix::column_index()</a>, <a class="el" href="../../de/d6c/level1__impl_8h.html#af1eb30bd79553c9e566435de1f82a94f">copy()</a>, <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html#a311cf35d030c6cc22b389c2542a4089c">oomph::CRDoubleMatrix::distributed_matrix_matrix_multiply_method()</a>, <a class="el" href="../../df/d1e/classoomph_1_1DistributableLinearAlgebraObject.html#a603105384d60c9a3710378af39f538b9">oomph::DistributableLinearAlgebraObject::distribution_pt()</a>, <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html#a4ed5597d8a34dd14f90b0e6cfb88ca2e">oomph::CRDoubleMatrix::ncol()</a>, <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html#a9482dafc0a17ebc5b7431369d8d07565">oomph::CRDoubleMatrix::nnz()</a>, <a class="el" href="../../df/d1e/classoomph_1_1DistributableLinearAlgebraObject.html#a9bd7e1d242c69a28da85a804a7717fce">oomph::DistributableLinearAlgebraObject::nrow_local()</a>, <a class="el" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>, <a class="el" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>, <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html#a25f1efd00318183abd8c65efede3f3f4">oomph::CRDoubleMatrix::row_start()</a>, <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html#aa09d92094d0ccf281dded547edfc981e">oomph::CRDoubleMatrix::serial_matrix_matrix_multiply_method()</a>, and <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html#ab8220b7c2bb763dab32a4d0fea7da6f4">oomph::CRDoubleMatrix::value()</a>.</p>

<p class="reference">Referenced by <a class="el" href="../../de/d05/classoomph_1_1DoubleMultiVector.html#a38d29d498100228299b29f1dc46b4251">oomph::DoubleMultiVector::DoubleMultiVector()</a>, <a class="el" href="../../dd/d57/classoomph_1_1BlockPreconditioner.html#a72b4dbe167da59d9ba12c7eff97d77e6">oomph::BlockPreconditioner&lt; MATRIX &gt;::get_block()</a>, and <a class="el" href="../../dd/d57/classoomph_1_1BlockPreconditioner.html#a1df550d281ec99914115edfa1a40b982">oomph::BlockPreconditioner&lt; MATRIX &gt;::get_dof_level_block()</a>.</p>

</div>
</div>
<a id="a02b5962dbe2bbfb93f54b668100afffc"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a02b5962dbe2bbfb93f54b668100afffc">&#9670;&nbsp;</a></span>gershgorin_eigenvalue_estimate()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="../../df/de6/classdouble.html">double</a> oomph::CRDoubleMatrixHelpers::gershgorin_eigenvalue_estimate </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="../../d6/d13/classoomph_1_1DenseMatrix.html">DenseMatrix</a>&lt; <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html">CRDoubleMatrix</a> * &gt; &amp;&#160;</td>
          <td class="paramname"><em>matrix_pt</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<p>Calculates the largest Gershgorin disc whilst preserving the sign. Let A be an n by n matrix, with entries aij. For \( i \in \{ 1,...,n \} \) let \( R_i = \sum_{i\neq j} |a_{ij}| \) be the sum of the absolute values of the non-diagonal entries in the i-th row. Let \( D(a_{ii},R_i) \) be the closed disc centered at \( a_{ii} \) with radius \( R_i \), such a disc is called a Gershgorin disc.</p>
<p><br  />
 We calculate \( |D(a_{ii},R_i)|_{max} \) and multiply by the sign of the diagonal entry.</p>
<p><br  />
 The DenseMatrix of CRDoubleMatrices are treated as if they are one large matrix. Therefore the dimensions of the sub matrices has to "make sense", there is a paranoid check for this.</p>
<p>Calculates the largest Gershgorin disc whilst preserving the sign. Let A be an n by n matrix, with entries aij. For \( i \in \{ 1,...,n \} \) let \( R_i = \sum_{i\neq j} |a_{ij}| \) be the sum of the absolute values of the non-diagonal entries in the i-th row. Let \( D(a_{ii},R_i) \) be the closed disc centered at \( a_{ii} \) with radius \( R_i \), such a disc is called a Gershgorin disc.</p>
<p><br  />
 We calculate \( |D(a_{ii},R_i)|_{max} \)and multiply by the sign of the diagonal entry.</p>
<p><br  />
 The DenseMatrix of CRDoubleMatrices are treated as if they are one large matrix. Therefore the dimensions of the sub matrices has to "make sense", there is a paranoid check for this. </p>
<div class="fragment"><div class="line"><a name="l04005"></a><span class="lineno"> 4005</span>&#160;    {</div>
<div class="line"><a name="l04006"></a><span class="lineno"> 4006</span>&#160;      <span class="comment">// The number of block rows and columns</span></div>
<div class="line"><a name="l04007"></a><span class="lineno"> 4007</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> nblockrow = matrix_pt.nrow();</div>
<div class="line"><a name="l04008"></a><span class="lineno"> 4008</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> nblockcol = matrix_pt.ncol();</div>
<div class="line"><a name="l04009"></a><span class="lineno"> 4009</span>&#160; </div>
<div class="line"><a name="l04010"></a><span class="lineno"> 4010</span>&#160;<span class="preprocessor">#ifdef PARANOID</span></div>
<div class="line"><a name="l04011"></a><span class="lineno"> 4011</span>&#160;      <span class="comment">// Check that tehre is at least one matrix.</span></div>
<div class="line"><a name="l04012"></a><span class="lineno"> 4012</span>&#160;      <span class="keywordflow">if</span> (matrix_pt.nrow() == 0)</div>
<div class="line"><a name="l04013"></a><span class="lineno"> 4013</span>&#160;      {</div>
<div class="line"><a name="l04014"></a><span class="lineno"> 4014</span>&#160;        std::ostringstream error_message;</div>
<div class="line"><a name="l04015"></a><span class="lineno"> 4015</span>&#160;        error_message &lt;&lt; <span class="stringliteral">&quot;There are no matrices... \n&quot;</span>;</div>
<div class="line"><a name="l04016"></a><span class="lineno"> 4016</span>&#160;        <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l04017"></a><span class="lineno"> 4017</span>&#160;                            <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l04018"></a><span class="lineno"> 4018</span>&#160;                            <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l04019"></a><span class="lineno"> 4019</span>&#160;      }</div>
<div class="line"><a name="l04020"></a><span class="lineno"> 4020</span>&#160; </div>
<div class="line"><a name="l04021"></a><span class="lineno"> 4021</span>&#160; </div>
<div class="line"><a name="l04022"></a><span class="lineno"> 4022</span>&#160;      <span class="comment">// Check that all matrix_pt pointers are not null</span></div>
<div class="line"><a name="l04023"></a><span class="lineno"> 4023</span>&#160;      <span class="comment">// and the matrices are built.</span></div>
<div class="line"><a name="l04024"></a><span class="lineno"> 4024</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 0; block_row_i &lt; nblockrow; block_row_i++)</div>
<div class="line"><a name="l04025"></a><span class="lineno"> 4025</span>&#160;      {</div>
<div class="line"><a name="l04026"></a><span class="lineno"> 4026</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 0; block_col_i &lt; nblockcol; block_col_i++)</div>
<div class="line"><a name="l04027"></a><span class="lineno"> 4027</span>&#160;        {</div>
<div class="line"><a name="l04028"></a><span class="lineno"> 4028</span>&#160;          <span class="keywordflow">if</span> (matrix_pt(block_row_i, block_col_i) == 0)</div>
<div class="line"><a name="l04029"></a><span class="lineno"> 4029</span>&#160;          {</div>
<div class="line"><a name="l04030"></a><span class="lineno"> 4030</span>&#160;            std::ostringstream error_message;</div>
<div class="line"><a name="l04031"></a><span class="lineno"> 4031</span>&#160;            error_message &lt;&lt; <span class="stringliteral">&quot;The pointer martrix_pt(&quot;</span> &lt;&lt; block_row_i &lt;&lt; <span class="stringliteral">&quot;,&quot;</span></div>
<div class="line"><a name="l04032"></a><span class="lineno"> 4032</span>&#160;                          &lt;&lt; block_col_i &lt;&lt; <span class="stringliteral">&quot;) is null.\n&quot;</span>;</div>
<div class="line"><a name="l04033"></a><span class="lineno"> 4033</span>&#160;            <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l04034"></a><span class="lineno"> 4034</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l04035"></a><span class="lineno"> 4035</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l04036"></a><span class="lineno"> 4036</span>&#160;          }</div>
<div class="line"><a name="l04037"></a><span class="lineno"> 4037</span>&#160; </div>
<div class="line"><a name="l04038"></a><span class="lineno"> 4038</span>&#160;          <span class="keywordflow">if</span> (!matrix_pt(block_row_i, block_col_i)-&gt;built())</div>
<div class="line"><a name="l04039"></a><span class="lineno"> 4039</span>&#160;          {</div>
<div class="line"><a name="l04040"></a><span class="lineno"> 4040</span>&#160;            std::ostringstream error_message;</div>
<div class="line"><a name="l04041"></a><span class="lineno"> 4041</span>&#160;            error_message &lt;&lt; <span class="stringliteral">&quot;The matrix at martrix_pt(&quot;</span> &lt;&lt; block_row_i &lt;&lt; <span class="stringliteral">&quot;,&quot;</span></div>
<div class="line"><a name="l04042"></a><span class="lineno"> 4042</span>&#160;                          &lt;&lt; block_col_i &lt;&lt; <span class="stringliteral">&quot;) is not built.\n&quot;</span>;</div>
<div class="line"><a name="l04043"></a><span class="lineno"> 4043</span>&#160;            <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l04044"></a><span class="lineno"> 4044</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l04045"></a><span class="lineno"> 4045</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l04046"></a><span class="lineno"> 4046</span>&#160;          }</div>
<div class="line"><a name="l04047"></a><span class="lineno"> 4047</span>&#160;        }</div>
<div class="line"><a name="l04048"></a><span class="lineno"> 4048</span>&#160;      }</div>
<div class="line"><a name="l04049"></a><span class="lineno"> 4049</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04050"></a><span class="lineno"> 4050</span>&#160; </div>
<div class="line"><a name="l04051"></a><span class="lineno"> 4051</span>&#160; </div>
<div class="line"><a name="l04052"></a><span class="lineno"> 4052</span>&#160;<span class="preprocessor">#ifdef OOMPH_HAS_MPI</span></div>
<div class="line"><a name="l04053"></a><span class="lineno"> 4053</span>&#160; </div>
<div class="line"><a name="l04054"></a><span class="lineno"> 4054</span>&#160;      <span class="comment">// The communicator pointer from block (0,0)</span></div>
<div class="line"><a name="l04055"></a><span class="lineno"> 4055</span>&#160;      <span class="comment">// All communicators should be the same, we check this next.</span></div>
<div class="line"><a name="l04056"></a><span class="lineno"> 4056</span>&#160;      <span class="keyword">const</span> OomphCommunicator* <span class="keyword">const</span> comm_pt =</div>
<div class="line"><a name="l04057"></a><span class="lineno"> 4057</span>&#160;        matrix_pt(0, 0)-&gt;distribution_pt()-&gt;communicator_pt();</div>
<div class="line"><a name="l04058"></a><span class="lineno"> 4058</span>&#160; </div>
<div class="line"><a name="l04059"></a><span class="lineno"> 4059</span>&#160;<span class="preprocessor">#ifdef PARANOID</span></div>
<div class="line"><a name="l04060"></a><span class="lineno"> 4060</span>&#160; </div>
<div class="line"><a name="l04061"></a><span class="lineno"> 4061</span>&#160;      <span class="comment">// Check that all communicators are the same</span></div>
<div class="line"><a name="l04062"></a><span class="lineno"> 4062</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 0; block_row_i &lt; nblockrow; block_row_i++)</div>
<div class="line"><a name="l04063"></a><span class="lineno"> 4063</span>&#160;      {</div>
<div class="line"><a name="l04064"></a><span class="lineno"> 4064</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 0; block_col_i &lt; nblockcol; block_col_i++)</div>
<div class="line"><a name="l04065"></a><span class="lineno"> 4065</span>&#160;        {</div>
<div class="line"><a name="l04066"></a><span class="lineno"> 4066</span>&#160;          <span class="comment">// Communicator for this block matrix.</span></div>
<div class="line"><a name="l04067"></a><span class="lineno"> 4067</span>&#160;          <span class="keyword">const</span> OomphCommunicator current_block_comm =</div>
<div class="line"><a name="l04068"></a><span class="lineno"> 4068</span>&#160;            *(matrix_pt(block_row_i, block_col_i)</div>
<div class="line"><a name="l04069"></a><span class="lineno"> 4069</span>&#160;                -&gt;distribution_pt()</div>
<div class="line"><a name="l04070"></a><span class="lineno"> 4070</span>&#160;                -&gt;communicator_pt());</div>
<div class="line"><a name="l04071"></a><span class="lineno"> 4071</span>&#160;          <span class="keywordflow">if</span> (*comm_pt != current_block_comm)</div>
<div class="line"><a name="l04072"></a><span class="lineno"> 4072</span>&#160;          {</div>
<div class="line"><a name="l04073"></a><span class="lineno"> 4073</span>&#160;            std::ostringstream error_message;</div>
<div class="line"><a name="l04074"></a><span class="lineno"> 4074</span>&#160;            error_message &lt;&lt; <span class="stringliteral">&quot;The communicator of block martrix_pt(&quot;</span></div>
<div class="line"><a name="l04075"></a><span class="lineno"> 4075</span>&#160;                          &lt;&lt; block_row_i &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt; block_col_i</div>
<div class="line"><a name="l04076"></a><span class="lineno"> 4076</span>&#160;                          &lt;&lt; <span class="stringliteral">&quot;) is not the same as block &quot;</span></div>
<div class="line"><a name="l04077"></a><span class="lineno"> 4077</span>&#160;                          &lt;&lt; <span class="stringliteral">&quot;matrix_pt(0,0).\n&quot;</span>;</div>
<div class="line"><a name="l04078"></a><span class="lineno"> 4078</span>&#160;            <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l04079"></a><span class="lineno"> 4079</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l04080"></a><span class="lineno"> 4080</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l04081"></a><span class="lineno"> 4081</span>&#160;          }</div>
<div class="line"><a name="l04082"></a><span class="lineno"> 4082</span>&#160;        }</div>
<div class="line"><a name="l04083"></a><span class="lineno"> 4083</span>&#160;      }</div>
<div class="line"><a name="l04084"></a><span class="lineno"> 4084</span>&#160; </div>
<div class="line"><a name="l04085"></a><span class="lineno"> 4085</span>&#160;      <span class="comment">// Check that all distributed boolean are the same (if on more than 1</span></div>
<div class="line"><a name="l04086"></a><span class="lineno"> 4086</span>&#160;      <span class="comment">// core)</span></div>
<div class="line"><a name="l04087"></a><span class="lineno"> 4087</span>&#160;      <span class="keywordflow">if</span> (comm_pt-&gt;nproc() &gt; 1)</div>
<div class="line"><a name="l04088"></a><span class="lineno"> 4088</span>&#160;      {</div>
<div class="line"><a name="l04089"></a><span class="lineno"> 4089</span>&#160;        <span class="comment">// Get the distributed boolean from matrix_pt(0,0)</span></div>
<div class="line"><a name="l04090"></a><span class="lineno"> 4090</span>&#160;        <span class="keywordtype">bool</span> first_distributed = matrix_pt(0, 0)-&gt;distributed();</div>
<div class="line"><a name="l04091"></a><span class="lineno"> 4091</span>&#160; </div>
<div class="line"><a name="l04092"></a><span class="lineno"> 4092</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 0; block_row_i &lt; nblockrow; block_row_i++)</div>
<div class="line"><a name="l04093"></a><span class="lineno"> 4093</span>&#160;        {</div>
<div class="line"><a name="l04094"></a><span class="lineno"> 4094</span>&#160;          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 0; block_col_i &lt; nblockcol; block_col_i++)</div>
<div class="line"><a name="l04095"></a><span class="lineno"> 4095</span>&#160;          {</div>
<div class="line"><a name="l04096"></a><span class="lineno"> 4096</span>&#160;            <span class="comment">// Is the current block distributed?</span></div>
<div class="line"><a name="l04097"></a><span class="lineno"> 4097</span>&#160;            <span class="keywordtype">bool</span> current_distributed =</div>
<div class="line"><a name="l04098"></a><span class="lineno"> 4098</span>&#160;              matrix_pt(block_row_i, block_col_i)-&gt;distributed();</div>
<div class="line"><a name="l04099"></a><span class="lineno"> 4099</span>&#160; </div>
<div class="line"><a name="l04100"></a><span class="lineno"> 4100</span>&#160;            <span class="keywordflow">if</span> (first_distributed != current_distributed)</div>
<div class="line"><a name="l04101"></a><span class="lineno"> 4101</span>&#160;            {</div>
<div class="line"><a name="l04102"></a><span class="lineno"> 4102</span>&#160;              std::ostringstream error_message;</div>
<div class="line"><a name="l04103"></a><span class="lineno"> 4103</span>&#160;              error_message &lt;&lt; <span class="stringliteral">&quot;Block matrix_pt(&quot;</span> &lt;&lt; block_row_i &lt;&lt; <span class="stringliteral">&quot;,&quot;</span></div>
<div class="line"><a name="l04104"></a><span class="lineno"> 4104</span>&#160;                            &lt;&lt; block_col_i &lt;&lt; <span class="stringliteral">&quot;) and block matrix_pt(0,0) &quot;</span></div>
<div class="line"><a name="l04105"></a><span class="lineno"> 4105</span>&#160;                            &lt;&lt; <span class="stringliteral">&quot;have a different distributed boolean.\n&quot;</span>;</div>
<div class="line"><a name="l04106"></a><span class="lineno"> 4106</span>&#160;              <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l04107"></a><span class="lineno"> 4107</span>&#160;                                  <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l04108"></a><span class="lineno"> 4108</span>&#160;                                  <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l04109"></a><span class="lineno"> 4109</span>&#160;            }</div>
<div class="line"><a name="l04110"></a><span class="lineno"> 4110</span>&#160;          }</div>
<div class="line"><a name="l04111"></a><span class="lineno"> 4111</span>&#160;        }</div>
<div class="line"><a name="l04112"></a><span class="lineno"> 4112</span>&#160;      }</div>
<div class="line"><a name="l04113"></a><span class="lineno"> 4113</span>&#160; </div>
<div class="line"><a name="l04114"></a><span class="lineno"> 4114</span>&#160;      <span class="comment">// Check that all sub matrix dimensions &quot;make sense&quot;</span></div>
<div class="line"><a name="l04115"></a><span class="lineno"> 4115</span>&#160;      <span class="comment">// We need to check that all the matrices in the same row has the same</span></div>
<div class="line"><a name="l04116"></a><span class="lineno"> 4116</span>&#160;      <span class="comment">// nrow. Then repeat for the columns.</span></div>
<div class="line"><a name="l04117"></a><span class="lineno"> 4117</span>&#160; </div>
<div class="line"><a name="l04118"></a><span class="lineno"> 4118</span>&#160;      <span class="comment">// Check the nrow of each block row.</span></div>
<div class="line"><a name="l04119"></a><span class="lineno"> 4119</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 0; block_row_i &lt; nblockrow; block_row_i++)</div>
<div class="line"><a name="l04120"></a><span class="lineno"> 4120</span>&#160;      {</div>
<div class="line"><a name="l04121"></a><span class="lineno"> 4121</span>&#160;        <span class="comment">// Get the nrow to compare against from the first column.</span></div>
<div class="line"><a name="l04122"></a><span class="lineno"> 4122</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> first_block_nrow = matrix_pt(block_row_i, 0)-&gt;nrow();</div>
<div class="line"><a name="l04123"></a><span class="lineno"> 4123</span>&#160; </div>
<div class="line"><a name="l04124"></a><span class="lineno"> 4124</span>&#160;        <span class="comment">// Loop through the block columns.</span></div>
<div class="line"><a name="l04125"></a><span class="lineno"> 4125</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 1; block_col_i &lt; nblockcol; block_col_i++)</div>
<div class="line"><a name="l04126"></a><span class="lineno"> 4126</span>&#160;        {</div>
<div class="line"><a name="l04127"></a><span class="lineno"> 4127</span>&#160;          <span class="comment">// If the nrow of this block is not the same as the nrow from the</span></div>
<div class="line"><a name="l04128"></a><span class="lineno"> 4128</span>&#160;          <span class="comment">// first block in this block row, throw an error.</span></div>
<div class="line"><a name="l04129"></a><span class="lineno"> 4129</span>&#160;          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> current_block_nrow =</div>
<div class="line"><a name="l04130"></a><span class="lineno"> 4130</span>&#160;            matrix_pt(block_row_i, block_col_i)-&gt;nrow();</div>
<div class="line"><a name="l04131"></a><span class="lineno"> 4131</span>&#160; </div>
<div class="line"><a name="l04132"></a><span class="lineno"> 4132</span>&#160;          <span class="keywordflow">if</span> (first_block_nrow != current_block_nrow)</div>
<div class="line"><a name="l04133"></a><span class="lineno"> 4133</span>&#160;          {</div>
<div class="line"><a name="l04134"></a><span class="lineno"> 4134</span>&#160;            std::ostringstream error_message;</div>
<div class="line"><a name="l04135"></a><span class="lineno"> 4135</span>&#160;            error_message &lt;&lt; <span class="stringliteral">&quot;First block has nrow = &quot;</span> &lt;&lt; current_block_nrow</div>
<div class="line"><a name="l04136"></a><span class="lineno"> 4136</span>&#160;                          &lt;&lt; <span class="stringliteral">&quot;. But martrix_pt(&quot;</span> &lt;&lt; block_row_i &lt;&lt; <span class="stringliteral">&quot;,&quot;</span></div>
<div class="line"><a name="l04137"></a><span class="lineno"> 4137</span>&#160;                          &lt;&lt; block_col_i</div>
<div class="line"><a name="l04138"></a><span class="lineno"> 4138</span>&#160;                          &lt;&lt; <span class="stringliteral">&quot;) has nrow = &quot;</span> &lt;&lt; current_block_nrow &lt;&lt; <span class="stringliteral">&quot;.\n&quot;</span>;</div>
<div class="line"><a name="l04139"></a><span class="lineno"> 4139</span>&#160;            <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l04140"></a><span class="lineno"> 4140</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l04141"></a><span class="lineno"> 4141</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l04142"></a><span class="lineno"> 4142</span>&#160;          }</div>
<div class="line"><a name="l04143"></a><span class="lineno"> 4143</span>&#160;        }</div>
<div class="line"><a name="l04144"></a><span class="lineno"> 4144</span>&#160;      }</div>
<div class="line"><a name="l04145"></a><span class="lineno"> 4145</span>&#160; </div>
<div class="line"><a name="l04146"></a><span class="lineno"> 4146</span>&#160;      <span class="comment">// Check the ncol of each block column.</span></div>
<div class="line"><a name="l04147"></a><span class="lineno"> 4147</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 0; block_col_i &lt; nblockcol; block_col_i++)</div>
<div class="line"><a name="l04148"></a><span class="lineno"> 4148</span>&#160;      {</div>
<div class="line"><a name="l04149"></a><span class="lineno"> 4149</span>&#160;        <span class="comment">// Get the ncol from the first block row to compare against.</span></div>
<div class="line"><a name="l04150"></a><span class="lineno"> 4150</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> first_block_ncol = matrix_pt(0, block_col_i)-&gt;ncol();</div>
<div class="line"><a name="l04151"></a><span class="lineno"> 4151</span>&#160; </div>
<div class="line"><a name="l04152"></a><span class="lineno"> 4152</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 1; block_row_i &lt; nblockrow; block_row_i++)</div>
<div class="line"><a name="l04153"></a><span class="lineno"> 4153</span>&#160;        {</div>
<div class="line"><a name="l04154"></a><span class="lineno"> 4154</span>&#160;          <span class="comment">// Get the ncol for the current block.</span></div>
<div class="line"><a name="l04155"></a><span class="lineno"> 4155</span>&#160;          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> current_block_ncol =</div>
<div class="line"><a name="l04156"></a><span class="lineno"> 4156</span>&#160;            matrix_pt(block_row_i, block_col_i)-&gt;ncol();</div>
<div class="line"><a name="l04157"></a><span class="lineno"> 4157</span>&#160; </div>
<div class="line"><a name="l04158"></a><span class="lineno"> 4158</span>&#160;          <span class="keywordflow">if</span> (first_block_ncol != current_block_ncol)</div>
<div class="line"><a name="l04159"></a><span class="lineno"> 4159</span>&#160;          {</div>
<div class="line"><a name="l04160"></a><span class="lineno"> 4160</span>&#160;            std::ostringstream error_message;</div>
<div class="line"><a name="l04161"></a><span class="lineno"> 4161</span>&#160;            error_message &lt;&lt; <span class="stringliteral">&quot;First block has ncol = &quot;</span> &lt;&lt; current_block_ncol</div>
<div class="line"><a name="l04162"></a><span class="lineno"> 4162</span>&#160;                          &lt;&lt; <span class="stringliteral">&quot;. But martrix_pt(&quot;</span> &lt;&lt; block_row_i &lt;&lt; <span class="stringliteral">&quot;,&quot;</span></div>
<div class="line"><a name="l04163"></a><span class="lineno"> 4163</span>&#160;                          &lt;&lt; block_col_i</div>
<div class="line"><a name="l04164"></a><span class="lineno"> 4164</span>&#160;                          &lt;&lt; <span class="stringliteral">&quot;) has ncol = &quot;</span> &lt;&lt; current_block_ncol &lt;&lt; <span class="stringliteral">&quot;.\n&quot;</span>;</div>
<div class="line"><a name="l04165"></a><span class="lineno"> 4165</span>&#160;            <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l04166"></a><span class="lineno"> 4166</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l04167"></a><span class="lineno"> 4167</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l04168"></a><span class="lineno"> 4168</span>&#160;          }</div>
<div class="line"><a name="l04169"></a><span class="lineno"> 4169</span>&#160;        }</div>
<div class="line"><a name="l04170"></a><span class="lineno"> 4170</span>&#160;      }</div>
<div class="line"><a name="l04171"></a><span class="lineno"> 4171</span>&#160; </div>
<div class="line"><a name="l04172"></a><span class="lineno"> 4172</span>&#160;      <span class="comment">// Check that the distribution for each block row is the same.</span></div>
<div class="line"><a name="l04173"></a><span class="lineno"> 4173</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 0; block_row_i &lt; nblockrow; block_row_i++)</div>
<div class="line"><a name="l04174"></a><span class="lineno"> 4174</span>&#160;      {</div>
<div class="line"><a name="l04175"></a><span class="lineno"> 4175</span>&#160;        <span class="comment">// The first distribution of this block row.</span></div>
<div class="line"><a name="l04176"></a><span class="lineno"> 4176</span>&#160;        <span class="keyword">const</span> LinearAlgebraDistribution first_dist =</div>
<div class="line"><a name="l04177"></a><span class="lineno"> 4177</span>&#160;          *(matrix_pt(block_row_i, 0)-&gt;distribution_pt());</div>
<div class="line"><a name="l04178"></a><span class="lineno"> 4178</span>&#160; </div>
<div class="line"><a name="l04179"></a><span class="lineno"> 4179</span>&#160;        <span class="comment">// Loop through the rest of the block columns.</span></div>
<div class="line"><a name="l04180"></a><span class="lineno"> 4180</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 1; block_col_i &lt; nblockcol; block_col_i++)</div>
<div class="line"><a name="l04181"></a><span class="lineno"> 4181</span>&#160;        {</div>
<div class="line"><a name="l04182"></a><span class="lineno"> 4182</span>&#160;          <span class="comment">// Get the distribution from the current block.</span></div>
<div class="line"><a name="l04183"></a><span class="lineno"> 4183</span>&#160;          <span class="keyword">const</span> LinearAlgebraDistribution current_dist =</div>
<div class="line"><a name="l04184"></a><span class="lineno"> 4184</span>&#160;            matrix_pt(block_row_i, block_col_i)-&gt;distribution_pt();</div>
<div class="line"><a name="l04185"></a><span class="lineno"> 4185</span>&#160; </div>
<div class="line"><a name="l04186"></a><span class="lineno"> 4186</span>&#160;          <span class="comment">// Compare the first distribution against the current.</span></div>
<div class="line"><a name="l04187"></a><span class="lineno"> 4187</span>&#160;          <span class="keywordflow">if</span> (first_dist != current_dist)</div>
<div class="line"><a name="l04188"></a><span class="lineno"> 4188</span>&#160;          {</div>
<div class="line"><a name="l04189"></a><span class="lineno"> 4189</span>&#160;            std::ostringstream error_message;</div>
<div class="line"><a name="l04190"></a><span class="lineno"> 4190</span>&#160;            error_message &lt;&lt; <span class="stringliteral">&quot;First distribution of block row &quot;</span> &lt;&lt; block_row_i</div>
<div class="line"><a name="l04191"></a><span class="lineno"> 4191</span>&#160;                          &lt;&lt; <span class="stringliteral">&quot; is different from the distribution from &quot;</span></div>
<div class="line"><a name="l04192"></a><span class="lineno"> 4192</span>&#160;                          &lt;&lt; <span class="stringliteral">&quot;martrix_pt(&quot;</span> &lt;&lt; block_row_i &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt; block_col_i</div>
<div class="line"><a name="l04193"></a><span class="lineno"> 4193</span>&#160;                          &lt;&lt; <span class="stringliteral">&quot;).\n&quot;</span>;</div>
<div class="line"><a name="l04194"></a><span class="lineno"> 4194</span>&#160;            <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l04195"></a><span class="lineno"> 4195</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l04196"></a><span class="lineno"> 4196</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l04197"></a><span class="lineno"> 4197</span>&#160;          }</div>
<div class="line"><a name="l04198"></a><span class="lineno"> 4198</span>&#160;        }</div>
<div class="line"><a name="l04199"></a><span class="lineno"> 4199</span>&#160;      }</div>
<div class="line"><a name="l04200"></a><span class="lineno"> 4200</span>&#160; </div>
<div class="line"><a name="l04201"></a><span class="lineno"> 4201</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04202"></a><span class="lineno"> 4202</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04203"></a><span class="lineno"> 4203</span>&#160; </div>
<div class="line"><a name="l04204"></a><span class="lineno"> 4204</span>&#160;      <span class="comment">// Loop thrpugh the block rows, then block columns to</span></div>
<div class="line"><a name="l04205"></a><span class="lineno"> 4205</span>&#160;      <span class="comment">// compute the local inf norm</span></div>
<div class="line"><a name="l04206"></a><span class="lineno"> 4206</span>&#160;      <span class="keywordtype">double</span> extreme_disc = 0;</div>
<div class="line"><a name="l04207"></a><span class="lineno"> 4207</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 0; block_row_i &lt; nblockrow; block_row_i++)</div>
<div class="line"><a name="l04208"></a><span class="lineno"> 4208</span>&#160;      {</div>
<div class="line"><a name="l04209"></a><span class="lineno"> 4209</span>&#160;        <span class="comment">// Get the number of local rows from the first block.</span></div>
<div class="line"><a name="l04210"></a><span class="lineno"> 4210</span>&#160;        <span class="keywordtype">unsigned</span> block_nrow_local = matrix_pt(block_row_i, 0)-&gt;nrow_local();</div>
<div class="line"><a name="l04211"></a><span class="lineno"> 4211</span>&#160; </div>
<div class="line"><a name="l04212"></a><span class="lineno"> 4212</span>&#160;        <span class="comment">// Loop through the block_nrow_local in this block row</span></div>
<div class="line"><a name="l04213"></a><span class="lineno"> 4213</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> local_row_i = 0; local_row_i &lt; block_nrow_local;</div>
<div class="line"><a name="l04214"></a><span class="lineno"> 4214</span>&#160;             local_row_i++)</div>
<div class="line"><a name="l04215"></a><span class="lineno"> 4215</span>&#160;        {</div>
<div class="line"><a name="l04216"></a><span class="lineno"> 4216</span>&#160;          <span class="keywordtype">double</span> abs_sum_of_row = 0;</div>
<div class="line"><a name="l04217"></a><span class="lineno"> 4217</span>&#160;          <span class="comment">// Loop through the block columns</span></div>
<div class="line"><a name="l04218"></a><span class="lineno"> 4218</span>&#160;          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 0; block_col_i &lt; nblockcol; block_col_i++)</div>
<div class="line"><a name="l04219"></a><span class="lineno"> 4219</span>&#160;          {</div>
<div class="line"><a name="l04220"></a><span class="lineno"> 4220</span>&#160;            <span class="comment">// Locally cache the pointer to the current block.</span></div>
<div class="line"><a name="l04221"></a><span class="lineno"> 4221</span>&#160;            CRDoubleMatrix* block_pt = matrix_pt(block_row_i, block_col_i);</div>
<div class="line"><a name="l04222"></a><span class="lineno"> 4222</span>&#160; </div>
<div class="line"><a name="l04223"></a><span class="lineno"> 4223</span>&#160;            <span class="keyword">const</span> <span class="keywordtype">int</span>* row_start = block_pt-&gt;row_start();</div>
<div class="line"><a name="l04224"></a><span class="lineno"> 4224</span>&#160;            <span class="keyword">const</span> <span class="keywordtype">double</span>* <a class="code" href="../../d1/d62/namespaceEigen.html#a242ccf5e6e80154bbf36d63acf6e458a">value</a> = block_pt-&gt;value();</div>
<div class="line"><a name="l04225"></a><span class="lineno"> 4225</span>&#160; </div>
<div class="line"><a name="l04226"></a><span class="lineno"> 4226</span>&#160;            <span class="comment">// Loop through the values</span></div>
<div class="line"><a name="l04227"></a><span class="lineno"> 4227</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> val_i = row_start[local_row_i];</div>
<div class="line"><a name="l04228"></a><span class="lineno"> 4228</span>&#160;                 val_i &lt; row_start[local_row_i + 1];</div>
<div class="line"><a name="l04229"></a><span class="lineno"> 4229</span>&#160;                 val_i++)</div>
<div class="line"><a name="l04230"></a><span class="lineno"> 4230</span>&#160;            {</div>
<div class="line"><a name="l04231"></a><span class="lineno"> 4231</span>&#160;              abs_sum_of_row += <a class="code" href="../../d2/d0c/namespaceboost_1_1multiprecision.html#ab6f80ccf8e1d88df8a8e3acd039d63eb">fabs</a>(<a class="code" href="../../d1/d62/namespaceEigen.html#a242ccf5e6e80154bbf36d63acf6e458a">value</a>[val_i]);</div>
<div class="line"><a name="l04232"></a><span class="lineno"> 4232</span>&#160;            }</div>
<div class="line"><a name="l04233"></a><span class="lineno"> 4233</span>&#160;          }</div>
<div class="line"><a name="l04234"></a><span class="lineno"> 4234</span>&#160; </div>
<div class="line"><a name="l04235"></a><span class="lineno"> 4235</span>&#160;          <span class="comment">// Now minus the diagonal entry...</span></div>
<div class="line"><a name="l04236"></a><span class="lineno"> 4236</span>&#160;          <span class="comment">// Locate the diagonal block matrix.</span></div>
<div class="line"><a name="l04237"></a><span class="lineno"> 4237</span>&#160;          <span class="keywordtype">double</span>* s_values = matrix_pt(block_row_i, block_row_i)-&gt;value();</div>
<div class="line"><a name="l04238"></a><span class="lineno"> 4238</span>&#160;          <span class="keywordtype">int</span>* s_column_index =</div>
<div class="line"><a name="l04239"></a><span class="lineno"> 4239</span>&#160;            matrix_pt(block_row_i, block_row_i)-&gt;column_index();</div>
<div class="line"><a name="l04240"></a><span class="lineno"> 4240</span>&#160;          <span class="keywordtype">int</span>* s_row_start = matrix_pt(block_row_i, block_row_i)-&gt;row_start();</div>
<div class="line"><a name="l04241"></a><span class="lineno"> 4241</span>&#160;          <span class="comment">// int s_nrow_local =</span></div>
<div class="line"><a name="l04242"></a><span class="lineno"> 4242</span>&#160;          <span class="comment">// matrix_pt(block_row_i,block_row_i)-&gt;nrow_local();</span></div>
<div class="line"><a name="l04243"></a><span class="lineno"> 4243</span>&#160;          <span class="keywordtype">int</span> s_first_row = matrix_pt(block_row_i, block_row_i)-&gt;first_row();</div>
<div class="line"><a name="l04244"></a><span class="lineno"> 4244</span>&#160; </div>
<div class="line"><a name="l04245"></a><span class="lineno"> 4245</span>&#160;          <span class="comment">// Get the diagonal value...</span></div>
<div class="line"><a name="l04246"></a><span class="lineno"> 4246</span>&#160;          <span class="keywordtype">double</span> diagonal_value = 0;</div>
<div class="line"><a name="l04247"></a><span class="lineno"> 4247</span>&#160;          <span class="keywordtype">bool</span> <a class="code" href="../../d5/db2/namespaceMergeRestartFiles.html#a442800b26526021e5f3312d460c09839">found</a> = <span class="keyword">false</span>;</div>
<div class="line"><a name="l04248"></a><span class="lineno"> 4248</span>&#160;          <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code" href="../../da/dd4/tut__arithmetic__redux__minmax_8cpp.html#a39513f0f8d942bf9ef17b2e87ac6d34e">j</a> = s_row_start[local_row_i];</div>
<div class="line"><a name="l04249"></a><span class="lineno"> 4249</span>&#160;               <a class="code" href="../../da/dd4/tut__arithmetic__redux__minmax_8cpp.html#a39513f0f8d942bf9ef17b2e87ac6d34e">j</a> &lt; s_row_start[local_row_i + 1] &amp;&amp; !<a class="code" href="../../d5/db2/namespaceMergeRestartFiles.html#a442800b26526021e5f3312d460c09839">found</a>;</div>
<div class="line"><a name="l04250"></a><span class="lineno"> 4250</span>&#160;               <a class="code" href="../../da/dd4/tut__arithmetic__redux__minmax_8cpp.html#a39513f0f8d942bf9ef17b2e87ac6d34e">j</a>++)</div>
<div class="line"><a name="l04251"></a><span class="lineno"> 4251</span>&#160;          {</div>
<div class="line"><a name="l04252"></a><span class="lineno"> 4252</span>&#160;            <span class="keywordflow">if</span> (s_column_index[<a class="code" href="../../da/dd4/tut__arithmetic__redux__minmax_8cpp.html#a39513f0f8d942bf9ef17b2e87ac6d34e">j</a>] == <span class="keywordtype">int</span>(local_row_i + s_first_row))</div>
<div class="line"><a name="l04253"></a><span class="lineno"> 4253</span>&#160;            {</div>
<div class="line"><a name="l04254"></a><span class="lineno"> 4254</span>&#160;              diagonal_value = s_values[<a class="code" href="../../da/dd4/tut__arithmetic__redux__minmax_8cpp.html#a39513f0f8d942bf9ef17b2e87ac6d34e">j</a>];</div>
<div class="line"><a name="l04255"></a><span class="lineno"> 4255</span>&#160;              <a class="code" href="../../d5/db2/namespaceMergeRestartFiles.html#a442800b26526021e5f3312d460c09839">found</a> = <span class="keyword">true</span>;</div>
<div class="line"><a name="l04256"></a><span class="lineno"> 4256</span>&#160;            }</div>
<div class="line"><a name="l04257"></a><span class="lineno"> 4257</span>&#160;          }</div>
<div class="line"><a name="l04258"></a><span class="lineno"> 4258</span>&#160; </div>
<div class="line"><a name="l04259"></a><span class="lineno"> 4259</span>&#160;          <span class="comment">// Check if the diagonal entry is found.</span></div>
<div class="line"><a name="l04260"></a><span class="lineno"> 4260</span>&#160;          <span class="keywordflow">if</span> (!<a class="code" href="../../d5/db2/namespaceMergeRestartFiles.html#a442800b26526021e5f3312d460c09839">found</a>)</div>
<div class="line"><a name="l04261"></a><span class="lineno"> 4261</span>&#160;          {</div>
<div class="line"><a name="l04262"></a><span class="lineno"> 4262</span>&#160;            std::ostringstream error_message;</div>
<div class="line"><a name="l04263"></a><span class="lineno"> 4263</span>&#160;            error_message &lt;&lt; <span class="stringliteral">&quot;The diagonal entry for the block(&quot;</span> &lt;&lt; block_row_i</div>
<div class="line"><a name="l04264"></a><span class="lineno"> 4264</span>&#160;                          &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt; block_row_i &lt;&lt; <span class="stringliteral">&quot;)\n&quot;</span></div>
<div class="line"><a name="l04265"></a><span class="lineno"> 4265</span>&#160;                          &lt;&lt; <span class="stringliteral">&quot;on local row &quot;</span> &lt;&lt; local_row_i</div>
<div class="line"><a name="l04266"></a><span class="lineno"> 4266</span>&#160;                          &lt;&lt; <span class="stringliteral">&quot; does not exist.&quot;</span> &lt;&lt; std::endl;</div>
<div class="line"><a name="l04267"></a><span class="lineno"> 4267</span>&#160;            <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l04268"></a><span class="lineno"> 4268</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l04269"></a><span class="lineno"> 4269</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l04270"></a><span class="lineno"> 4270</span>&#160;          }</div>
<div class="line"><a name="l04271"></a><span class="lineno"> 4271</span>&#160; </div>
<div class="line"><a name="l04272"></a><span class="lineno"> 4272</span>&#160;          <span class="comment">// This is the disc.</span></div>
<div class="line"><a name="l04273"></a><span class="lineno"> 4273</span>&#160;          abs_sum_of_row -= <a class="code" href="../../d2/d0c/namespaceboost_1_1multiprecision.html#ab6f80ccf8e1d88df8a8e3acd039d63eb">fabs</a>(diagonal_value);</div>
<div class="line"><a name="l04274"></a><span class="lineno"> 4274</span>&#160; </div>
<div class="line"><a name="l04275"></a><span class="lineno"> 4275</span>&#160;          <span class="comment">// Now we have to check if the diagonal entry is</span></div>
<div class="line"><a name="l04276"></a><span class="lineno"> 4276</span>&#160;          <span class="comment">// on the left or right side of zero.</span></div>
<div class="line"><a name="l04277"></a><span class="lineno"> 4277</span>&#160;          <span class="keywordflow">if</span> (diagonal_value &gt; 0)</div>
<div class="line"><a name="l04278"></a><span class="lineno"> 4278</span>&#160;          {</div>
<div class="line"><a name="l04279"></a><span class="lineno"> 4279</span>&#160;            <span class="keywordtype">double</span> extreme_disc_local = diagonal_value + abs_sum_of_row;</div>
<div class="line"><a name="l04280"></a><span class="lineno"> 4280</span>&#160;            extreme_disc = <a class="code" href="../../dc/d51/datatypes_8h.html#affe776513b24d84b39af8ab0930fef7f">std::max</a>(extreme_disc_local, extreme_disc);</div>
<div class="line"><a name="l04281"></a><span class="lineno"> 4281</span>&#160;          }</div>
<div class="line"><a name="l04282"></a><span class="lineno"> 4282</span>&#160;          <span class="keywordflow">else</span></div>
<div class="line"><a name="l04283"></a><span class="lineno"> 4283</span>&#160;          {</div>
<div class="line"><a name="l04284"></a><span class="lineno"> 4284</span>&#160;            <span class="keywordtype">double</span> extreme_disc_local = diagonal_value - abs_sum_of_row;</div>
<div class="line"><a name="l04285"></a><span class="lineno"> 4285</span>&#160;            extreme_disc = <a class="code" href="../../dc/d51/datatypes_8h.html#ac6afabdc09a49a433ee19d8a9486056d">std::min</a>(extreme_disc_local, extreme_disc);</div>
<div class="line"><a name="l04286"></a><span class="lineno"> 4286</span>&#160;          }</div>
<div class="line"><a name="l04287"></a><span class="lineno"> 4287</span>&#160;        } <span class="comment">// Loop through local row (of all block column)</span></div>
<div class="line"><a name="l04288"></a><span class="lineno"> 4288</span>&#160;      } <span class="comment">// Loop through block row</span></div>
<div class="line"><a name="l04289"></a><span class="lineno"> 4289</span>&#160; </div>
<div class="line"><a name="l04290"></a><span class="lineno"> 4290</span>&#160;      <span class="comment">// if this vector is distributed and on multiple processors then gather</span></div>
<div class="line"><a name="l04291"></a><span class="lineno"> 4291</span>&#160;<span class="preprocessor">#ifdef OOMPH_HAS_MPI</span></div>
<div class="line"><a name="l04292"></a><span class="lineno"> 4292</span>&#160;      <span class="keywordtype">double</span> extreme_disc_local = extreme_disc;</div>
<div class="line"><a name="l04293"></a><span class="lineno"> 4293</span>&#160;      <span class="keywordflow">if</span> (matrix_pt(0, 0)-&gt;distributed() &amp;&amp; comm_pt-&gt;nproc() &gt; 1)</div>
<div class="line"><a name="l04294"></a><span class="lineno"> 4294</span>&#160;      {</div>
<div class="line"><a name="l04295"></a><span class="lineno"> 4295</span>&#160;        <span class="keywordflow">if</span> (extreme_disc &gt; 0)</div>
<div class="line"><a name="l04296"></a><span class="lineno"> 4296</span>&#160;        {</div>
<div class="line"><a name="l04297"></a><span class="lineno"> 4297</span>&#160;          MPI_Allreduce(&amp;extreme_disc,</div>
<div class="line"><a name="l04298"></a><span class="lineno"> 4298</span>&#160;                        &amp;extreme_disc_local,</div>
<div class="line"><a name="l04299"></a><span class="lineno"> 4299</span>&#160;                        1,</div>
<div class="line"><a name="l04300"></a><span class="lineno"> 4300</span>&#160;                        MPI_DOUBLE,</div>
<div class="line"><a name="l04301"></a><span class="lineno"> 4301</span>&#160;                        MPI_MAX,</div>
<div class="line"><a name="l04302"></a><span class="lineno"> 4302</span>&#160;                        comm_pt-&gt;mpi_comm());</div>
<div class="line"><a name="l04303"></a><span class="lineno"> 4303</span>&#160;        }</div>
<div class="line"><a name="l04304"></a><span class="lineno"> 4304</span>&#160;        <span class="keywordflow">else</span></div>
<div class="line"><a name="l04305"></a><span class="lineno"> 4305</span>&#160;        {</div>
<div class="line"><a name="l04306"></a><span class="lineno"> 4306</span>&#160;          MPI_Allreduce(&amp;extreme_disc,</div>
<div class="line"><a name="l04307"></a><span class="lineno"> 4307</span>&#160;                        &amp;extreme_disc_local,</div>
<div class="line"><a name="l04308"></a><span class="lineno"> 4308</span>&#160;                        1,</div>
<div class="line"><a name="l04309"></a><span class="lineno"> 4309</span>&#160;                        MPI_DOUBLE,</div>
<div class="line"><a name="l04310"></a><span class="lineno"> 4310</span>&#160;                        MPI_MIN,</div>
<div class="line"><a name="l04311"></a><span class="lineno"> 4311</span>&#160;                        comm_pt-&gt;mpi_comm());</div>
<div class="line"><a name="l04312"></a><span class="lineno"> 4312</span>&#160;        }</div>
<div class="line"><a name="l04313"></a><span class="lineno"> 4313</span>&#160;      }</div>
<div class="line"><a name="l04314"></a><span class="lineno"> 4314</span>&#160;      extreme_disc = extreme_disc_local;</div>
<div class="line"><a name="l04315"></a><span class="lineno"> 4315</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l04316"></a><span class="lineno"> 4316</span>&#160; </div>
<div class="line"><a name="l04317"></a><span class="lineno"> 4317</span>&#160;      <span class="comment">// and return</span></div>
<div class="line"><a name="l04318"></a><span class="lineno"> 4318</span>&#160;      <span class="keywordflow">return</span> extreme_disc;</div>
<div class="line"><a name="l04319"></a><span class="lineno"> 4319</span>&#160;    }</div>
<div class="ttc" id="adatatypes_8h_html_ac6afabdc09a49a433ee19d8a9486056d"><div class="ttname"><a href="../../dc/d51/datatypes_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a></div><div class="ttdeci">#define min(a, b)</div><div class="ttdef"><b>Definition:</b> datatypes.h:22</div></div>
<div class="ttc" id="adatatypes_8h_html_affe776513b24d84b39af8ab0930fef7f"><div class="ttname"><a href="../../dc/d51/datatypes_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a></div><div class="ttdeci">#define max(a, b)</div><div class="ttdef"><b>Definition:</b> datatypes.h:23</div></div>
<div class="ttc" id="anamespaceEigen_html_a242ccf5e6e80154bbf36d63acf6e458a"><div class="ttname"><a href="../../d1/d62/namespaceEigen.html#a242ccf5e6e80154bbf36d63acf6e458a">Eigen::value</a></div><div class="ttdeci">squared absolute value</div><div class="ttdef"><b>Definition:</b> GlobalFunctions.h:87</div></div>
<div class="ttc" id="anamespaceMergeRestartFiles_html_a442800b26526021e5f3312d460c09839"><div class="ttname"><a href="../../d5/db2/namespaceMergeRestartFiles.html#a442800b26526021e5f3312d460c09839">MergeRestartFiles.found</a></div><div class="ttdeci">bool found</div><div class="ttdef"><b>Definition:</b> MergeRestartFiles.py:24</div></div>
<div class="ttc" id="anamespaceboost_1_1multiprecision_html_ab6f80ccf8e1d88df8a8e3acd039d63eb"><div class="ttname"><a href="../../d2/d0c/namespaceboost_1_1multiprecision.html#ab6f80ccf8e1d88df8a8e3acd039d63eb">boost::multiprecision::fabs</a></div><div class="ttdeci">Real fabs(const Real &amp;a)</div><div class="ttdef"><b>Definition:</b> boostmultiprec.cpp:117</div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="../../d2/d0c/namespaceboost_1_1multiprecision.html#ab6f80ccf8e1d88df8a8e3acd039d63eb">boost::multiprecision::fabs()</a>, <a class="el" href="../../d5/db2/namespaceMergeRestartFiles.html#a442800b26526021e5f3312d460c09839">MergeRestartFiles::found</a>, <a class="el" href="../../da/dd4/tut__arithmetic__redux__minmax_8cpp.html#a39513f0f8d942bf9ef17b2e87ac6d34e">j</a>, <a class="el" href="../../dc/d51/datatypes_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>, <a class="el" href="../../dc/d51/datatypes_8h.html#ac6afabdc09a49a433ee19d8a9486056d">min</a>, <a class="el" href="../../d6/d13/classoomph_1_1DenseMatrix.html#a9937181f1cb4cfaed7aaf3b483c42456">oomph::DenseMatrix&lt; T &gt;::ncol()</a>, <a class="el" href="../../de/d83/classoomph_1_1OomphCommunicator.html#a6c78c72666f4b102c2bccf200f0853b7">oomph::OomphCommunicator::nproc()</a>, <a class="el" href="../../d6/d13/classoomph_1_1DenseMatrix.html#a1b425094510d833ffe91920747a0a962">oomph::DenseMatrix&lt; T &gt;::nrow()</a>, <a class="el" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>, <a class="el" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>, <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html#a25f1efd00318183abd8c65efede3f3f4">oomph::CRDoubleMatrix::row_start()</a>, <a class="el" href="../../d1/d62/namespaceEigen.html#a242ccf5e6e80154bbf36d63acf6e458a">Eigen::value</a>, and <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html#ab8220b7c2bb763dab32a4d0fea7da6f4">oomph::CRDoubleMatrix::value()</a>.</p>

</div>
</div>
<a id="ab17222c9461096e3d5b8cf6250524644"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ab17222c9461096e3d5b8cf6250524644">&#9670;&nbsp;</a></span>inf_norm()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="../../df/de6/classdouble.html">double</a> oomph::CRDoubleMatrixHelpers::inf_norm </td>
          <td>(</td>
          <td class="paramtype">const <a class="el" href="../../d6/d13/classoomph_1_1DenseMatrix.html">DenseMatrix</a>&lt; <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html">CRDoubleMatrix</a> * &gt; &amp;&#160;</td>
          <td class="paramname"><em>matrix_pt</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Compute infinity (maximum) norm of sub blocks as if it was one matrix. </p>
<p>Calculates the infinity (maximum) norm of a DenseMartrix of CRDoubleMatrices as if it was one large matrix. This avoids creating a concatenation of the sub-blocks just to calculate the infinity norm. </p>
<div class="fragment"><div class="line"><a name="l03732"></a><span class="lineno"> 3732</span>&#160;    {</div>
<div class="line"><a name="l03733"></a><span class="lineno"> 3733</span>&#160;      <span class="comment">// The number of block rows and columns</span></div>
<div class="line"><a name="l03734"></a><span class="lineno"> 3734</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> nblockrow = matrix_pt.nrow();</div>
<div class="line"><a name="l03735"></a><span class="lineno"> 3735</span>&#160;      <span class="keyword">const</span> <span class="keywordtype">unsigned</span> nblockcol = matrix_pt.ncol();</div>
<div class="line"><a name="l03736"></a><span class="lineno"> 3736</span>&#160; </div>
<div class="line"><a name="l03737"></a><span class="lineno"> 3737</span>&#160;<span class="preprocessor">#ifdef PARANOID</span></div>
<div class="line"><a name="l03738"></a><span class="lineno"> 3738</span>&#160;      <span class="comment">// Check that tehre is at least one matrix.</span></div>
<div class="line"><a name="l03739"></a><span class="lineno"> 3739</span>&#160;      <span class="keywordflow">if</span> (matrix_pt.nrow() == 0)</div>
<div class="line"><a name="l03740"></a><span class="lineno"> 3740</span>&#160;      {</div>
<div class="line"><a name="l03741"></a><span class="lineno"> 3741</span>&#160;        std::ostringstream error_message;</div>
<div class="line"><a name="l03742"></a><span class="lineno"> 3742</span>&#160;        error_message &lt;&lt; <span class="stringliteral">&quot;There are no matrices... \n&quot;</span>;</div>
<div class="line"><a name="l03743"></a><span class="lineno"> 3743</span>&#160;        <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l03744"></a><span class="lineno"> 3744</span>&#160;                            <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l03745"></a><span class="lineno"> 3745</span>&#160;                            <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l03746"></a><span class="lineno"> 3746</span>&#160;      }</div>
<div class="line"><a name="l03747"></a><span class="lineno"> 3747</span>&#160; </div>
<div class="line"><a name="l03748"></a><span class="lineno"> 3748</span>&#160; </div>
<div class="line"><a name="l03749"></a><span class="lineno"> 3749</span>&#160;      <span class="comment">// Check that all matrix_pt pointers are not null</span></div>
<div class="line"><a name="l03750"></a><span class="lineno"> 3750</span>&#160;      <span class="comment">// and the matrices are built.</span></div>
<div class="line"><a name="l03751"></a><span class="lineno"> 3751</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 0; block_row_i &lt; nblockrow; block_row_i++)</div>
<div class="line"><a name="l03752"></a><span class="lineno"> 3752</span>&#160;      {</div>
<div class="line"><a name="l03753"></a><span class="lineno"> 3753</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 0; block_col_i &lt; nblockcol; block_col_i++)</div>
<div class="line"><a name="l03754"></a><span class="lineno"> 3754</span>&#160;        {</div>
<div class="line"><a name="l03755"></a><span class="lineno"> 3755</span>&#160;          <span class="keywordflow">if</span> (matrix_pt(block_row_i, block_col_i) == 0)</div>
<div class="line"><a name="l03756"></a><span class="lineno"> 3756</span>&#160;          {</div>
<div class="line"><a name="l03757"></a><span class="lineno"> 3757</span>&#160;            std::ostringstream error_message;</div>
<div class="line"><a name="l03758"></a><span class="lineno"> 3758</span>&#160;            error_message &lt;&lt; <span class="stringliteral">&quot;The pointer martrix_pt(&quot;</span> &lt;&lt; block_row_i &lt;&lt; <span class="stringliteral">&quot;,&quot;</span></div>
<div class="line"><a name="l03759"></a><span class="lineno"> 3759</span>&#160;                          &lt;&lt; block_col_i &lt;&lt; <span class="stringliteral">&quot;) is null.\n&quot;</span>;</div>
<div class="line"><a name="l03760"></a><span class="lineno"> 3760</span>&#160;            <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l03761"></a><span class="lineno"> 3761</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l03762"></a><span class="lineno"> 3762</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l03763"></a><span class="lineno"> 3763</span>&#160;          }</div>
<div class="line"><a name="l03764"></a><span class="lineno"> 3764</span>&#160; </div>
<div class="line"><a name="l03765"></a><span class="lineno"> 3765</span>&#160;          <span class="keywordflow">if</span> (!matrix_pt(block_row_i, block_col_i)-&gt;built())</div>
<div class="line"><a name="l03766"></a><span class="lineno"> 3766</span>&#160;          {</div>
<div class="line"><a name="l03767"></a><span class="lineno"> 3767</span>&#160;            std::ostringstream error_message;</div>
<div class="line"><a name="l03768"></a><span class="lineno"> 3768</span>&#160;            error_message &lt;&lt; <span class="stringliteral">&quot;The matrix at martrix_pt(&quot;</span> &lt;&lt; block_row_i &lt;&lt; <span class="stringliteral">&quot;,&quot;</span></div>
<div class="line"><a name="l03769"></a><span class="lineno"> 3769</span>&#160;                          &lt;&lt; block_col_i &lt;&lt; <span class="stringliteral">&quot;) is not built.\n&quot;</span>;</div>
<div class="line"><a name="l03770"></a><span class="lineno"> 3770</span>&#160;            <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l03771"></a><span class="lineno"> 3771</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l03772"></a><span class="lineno"> 3772</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l03773"></a><span class="lineno"> 3773</span>&#160;          }</div>
<div class="line"><a name="l03774"></a><span class="lineno"> 3774</span>&#160;        }</div>
<div class="line"><a name="l03775"></a><span class="lineno"> 3775</span>&#160;      }</div>
<div class="line"><a name="l03776"></a><span class="lineno"> 3776</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03777"></a><span class="lineno"> 3777</span>&#160; </div>
<div class="line"><a name="l03778"></a><span class="lineno"> 3778</span>&#160;<span class="preprocessor">#ifdef OOMPH_HAS_MPI</span></div>
<div class="line"><a name="l03779"></a><span class="lineno"> 3779</span>&#160; </div>
<div class="line"><a name="l03780"></a><span class="lineno"> 3780</span>&#160;      <span class="comment">// The communicator pointer from block (0,0)</span></div>
<div class="line"><a name="l03781"></a><span class="lineno"> 3781</span>&#160;      <span class="keyword">const</span> OomphCommunicator* <span class="keyword">const</span> comm_pt =</div>
<div class="line"><a name="l03782"></a><span class="lineno"> 3782</span>&#160;        matrix_pt(0, 0)-&gt;distribution_pt()-&gt;communicator_pt();</div>
<div class="line"><a name="l03783"></a><span class="lineno"> 3783</span>&#160; </div>
<div class="line"><a name="l03784"></a><span class="lineno"> 3784</span>&#160;<span class="preprocessor">#ifdef PARANOID</span></div>
<div class="line"><a name="l03785"></a><span class="lineno"> 3785</span>&#160; </div>
<div class="line"><a name="l03786"></a><span class="lineno"> 3786</span>&#160; </div>
<div class="line"><a name="l03787"></a><span class="lineno"> 3787</span>&#160;      <span class="comment">// Check that all communicators are the same</span></div>
<div class="line"><a name="l03788"></a><span class="lineno"> 3788</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 0; block_row_i &lt; nblockrow; block_row_i++)</div>
<div class="line"><a name="l03789"></a><span class="lineno"> 3789</span>&#160;      {</div>
<div class="line"><a name="l03790"></a><span class="lineno"> 3790</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 0; block_col_i &lt; nblockcol; block_col_i++)</div>
<div class="line"><a name="l03791"></a><span class="lineno"> 3791</span>&#160;        {</div>
<div class="line"><a name="l03792"></a><span class="lineno"> 3792</span>&#160;          <span class="comment">// Communicator for this block matrix.</span></div>
<div class="line"><a name="l03793"></a><span class="lineno"> 3793</span>&#160;          <span class="keyword">const</span> OomphCommunicator current_block_comm =</div>
<div class="line"><a name="l03794"></a><span class="lineno"> 3794</span>&#160;            *(matrix_pt(block_row_i, block_col_i)</div>
<div class="line"><a name="l03795"></a><span class="lineno"> 3795</span>&#160;                -&gt;distribution_pt()</div>
<div class="line"><a name="l03796"></a><span class="lineno"> 3796</span>&#160;                -&gt;communicator_pt());</div>
<div class="line"><a name="l03797"></a><span class="lineno"> 3797</span>&#160;          <span class="keywordflow">if</span> (*comm_pt != current_block_comm)</div>
<div class="line"><a name="l03798"></a><span class="lineno"> 3798</span>&#160;          {</div>
<div class="line"><a name="l03799"></a><span class="lineno"> 3799</span>&#160;            std::ostringstream error_message;</div>
<div class="line"><a name="l03800"></a><span class="lineno"> 3800</span>&#160;            error_message &lt;&lt; <span class="stringliteral">&quot;The communicator of block martrix_pt(&quot;</span></div>
<div class="line"><a name="l03801"></a><span class="lineno"> 3801</span>&#160;                          &lt;&lt; block_row_i &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt; block_col_i</div>
<div class="line"><a name="l03802"></a><span class="lineno"> 3802</span>&#160;                          &lt;&lt; <span class="stringliteral">&quot;) is not the same as block &quot;</span></div>
<div class="line"><a name="l03803"></a><span class="lineno"> 3803</span>&#160;                          &lt;&lt; <span class="stringliteral">&quot;matrix_pt(0,0).\n&quot;</span>;</div>
<div class="line"><a name="l03804"></a><span class="lineno"> 3804</span>&#160;            <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l03805"></a><span class="lineno"> 3805</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l03806"></a><span class="lineno"> 3806</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l03807"></a><span class="lineno"> 3807</span>&#160;          }</div>
<div class="line"><a name="l03808"></a><span class="lineno"> 3808</span>&#160;        }</div>
<div class="line"><a name="l03809"></a><span class="lineno"> 3809</span>&#160;      }</div>
<div class="line"><a name="l03810"></a><span class="lineno"> 3810</span>&#160; </div>
<div class="line"><a name="l03811"></a><span class="lineno"> 3811</span>&#160;      <span class="comment">// Check that all distributed boolean are the same (if on more than 1</span></div>
<div class="line"><a name="l03812"></a><span class="lineno"> 3812</span>&#160;      <span class="comment">// core)</span></div>
<div class="line"><a name="l03813"></a><span class="lineno"> 3813</span>&#160;      <span class="keywordflow">if</span> (comm_pt-&gt;nproc() &gt; 1)</div>
<div class="line"><a name="l03814"></a><span class="lineno"> 3814</span>&#160;      {</div>
<div class="line"><a name="l03815"></a><span class="lineno"> 3815</span>&#160;        <span class="comment">// Get the distributed boolean from matrix_pt(0,0)</span></div>
<div class="line"><a name="l03816"></a><span class="lineno"> 3816</span>&#160;        <span class="keywordtype">bool</span> first_distributed = matrix_pt(0, 0)-&gt;distributed();</div>
<div class="line"><a name="l03817"></a><span class="lineno"> 3817</span>&#160; </div>
<div class="line"><a name="l03818"></a><span class="lineno"> 3818</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 0; block_row_i &lt; nblockrow; block_row_i++)</div>
<div class="line"><a name="l03819"></a><span class="lineno"> 3819</span>&#160;        {</div>
<div class="line"><a name="l03820"></a><span class="lineno"> 3820</span>&#160;          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 0; block_col_i &lt; nblockcol; block_col_i++)</div>
<div class="line"><a name="l03821"></a><span class="lineno"> 3821</span>&#160;          {</div>
<div class="line"><a name="l03822"></a><span class="lineno"> 3822</span>&#160;            <span class="comment">// Is the current block distributed?</span></div>
<div class="line"><a name="l03823"></a><span class="lineno"> 3823</span>&#160;            <span class="keywordtype">bool</span> current_distributed =</div>
<div class="line"><a name="l03824"></a><span class="lineno"> 3824</span>&#160;              matrix_pt(block_row_i, block_col_i)-&gt;distributed();</div>
<div class="line"><a name="l03825"></a><span class="lineno"> 3825</span>&#160; </div>
<div class="line"><a name="l03826"></a><span class="lineno"> 3826</span>&#160;            <span class="keywordflow">if</span> (first_distributed != current_distributed)</div>
<div class="line"><a name="l03827"></a><span class="lineno"> 3827</span>&#160;            {</div>
<div class="line"><a name="l03828"></a><span class="lineno"> 3828</span>&#160;              std::ostringstream error_message;</div>
<div class="line"><a name="l03829"></a><span class="lineno"> 3829</span>&#160;              error_message &lt;&lt; <span class="stringliteral">&quot;Block matrix_pt(&quot;</span> &lt;&lt; block_row_i &lt;&lt; <span class="stringliteral">&quot;,&quot;</span></div>
<div class="line"><a name="l03830"></a><span class="lineno"> 3830</span>&#160;                            &lt;&lt; block_col_i &lt;&lt; <span class="stringliteral">&quot;) and block matrix_pt(0,0) &quot;</span></div>
<div class="line"><a name="l03831"></a><span class="lineno"> 3831</span>&#160;                            &lt;&lt; <span class="stringliteral">&quot;have a different distributed boolean.\n&quot;</span>;</div>
<div class="line"><a name="l03832"></a><span class="lineno"> 3832</span>&#160;              <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l03833"></a><span class="lineno"> 3833</span>&#160;                                  <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l03834"></a><span class="lineno"> 3834</span>&#160;                                  <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l03835"></a><span class="lineno"> 3835</span>&#160;            }</div>
<div class="line"><a name="l03836"></a><span class="lineno"> 3836</span>&#160;          }</div>
<div class="line"><a name="l03837"></a><span class="lineno"> 3837</span>&#160;        }</div>
<div class="line"><a name="l03838"></a><span class="lineno"> 3838</span>&#160;      }</div>
<div class="line"><a name="l03839"></a><span class="lineno"> 3839</span>&#160; </div>
<div class="line"><a name="l03840"></a><span class="lineno"> 3840</span>&#160;      <span class="comment">// Check that all sub matrix dimensions &quot;make sense&quot;</span></div>
<div class="line"><a name="l03841"></a><span class="lineno"> 3841</span>&#160;      <span class="comment">// We need to check that all the matrices in the same row has the same</span></div>
<div class="line"><a name="l03842"></a><span class="lineno"> 3842</span>&#160;      <span class="comment">// nrow. Then repeat for the columns.</span></div>
<div class="line"><a name="l03843"></a><span class="lineno"> 3843</span>&#160; </div>
<div class="line"><a name="l03844"></a><span class="lineno"> 3844</span>&#160;      <span class="comment">// Check the nrow of each block row.</span></div>
<div class="line"><a name="l03845"></a><span class="lineno"> 3845</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 0; block_row_i &lt; nblockrow; block_row_i++)</div>
<div class="line"><a name="l03846"></a><span class="lineno"> 3846</span>&#160;      {</div>
<div class="line"><a name="l03847"></a><span class="lineno"> 3847</span>&#160;        <span class="comment">// Get the nrow to compare against from the first column.</span></div>
<div class="line"><a name="l03848"></a><span class="lineno"> 3848</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> first_block_nrow = matrix_pt(block_row_i, 0)-&gt;nrow();</div>
<div class="line"><a name="l03849"></a><span class="lineno"> 3849</span>&#160; </div>
<div class="line"><a name="l03850"></a><span class="lineno"> 3850</span>&#160;        <span class="comment">// Loop through the block columns.</span></div>
<div class="line"><a name="l03851"></a><span class="lineno"> 3851</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 1; block_col_i &lt; nblockcol; block_col_i++)</div>
<div class="line"><a name="l03852"></a><span class="lineno"> 3852</span>&#160;        {</div>
<div class="line"><a name="l03853"></a><span class="lineno"> 3853</span>&#160;          <span class="comment">// If the nrow of this block is not the same as the nrow from the</span></div>
<div class="line"><a name="l03854"></a><span class="lineno"> 3854</span>&#160;          <span class="comment">// first block in this block row, throw an error.</span></div>
<div class="line"><a name="l03855"></a><span class="lineno"> 3855</span>&#160;          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> current_block_nrow =</div>
<div class="line"><a name="l03856"></a><span class="lineno"> 3856</span>&#160;            matrix_pt(block_row_i, block_col_i)-&gt;nrow();</div>
<div class="line"><a name="l03857"></a><span class="lineno"> 3857</span>&#160; </div>
<div class="line"><a name="l03858"></a><span class="lineno"> 3858</span>&#160;          <span class="keywordflow">if</span> (first_block_nrow != current_block_nrow)</div>
<div class="line"><a name="l03859"></a><span class="lineno"> 3859</span>&#160;          {</div>
<div class="line"><a name="l03860"></a><span class="lineno"> 3860</span>&#160;            std::ostringstream error_message;</div>
<div class="line"><a name="l03861"></a><span class="lineno"> 3861</span>&#160;            error_message &lt;&lt; <span class="stringliteral">&quot;First block has nrow = &quot;</span> &lt;&lt; current_block_nrow</div>
<div class="line"><a name="l03862"></a><span class="lineno"> 3862</span>&#160;                          &lt;&lt; <span class="stringliteral">&quot;. But martrix_pt(&quot;</span> &lt;&lt; block_row_i &lt;&lt; <span class="stringliteral">&quot;,&quot;</span></div>
<div class="line"><a name="l03863"></a><span class="lineno"> 3863</span>&#160;                          &lt;&lt; block_col_i</div>
<div class="line"><a name="l03864"></a><span class="lineno"> 3864</span>&#160;                          &lt;&lt; <span class="stringliteral">&quot;) has nrow = &quot;</span> &lt;&lt; current_block_nrow &lt;&lt; <span class="stringliteral">&quot;.\n&quot;</span>;</div>
<div class="line"><a name="l03865"></a><span class="lineno"> 3865</span>&#160;            <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l03866"></a><span class="lineno"> 3866</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l03867"></a><span class="lineno"> 3867</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l03868"></a><span class="lineno"> 3868</span>&#160;          }</div>
<div class="line"><a name="l03869"></a><span class="lineno"> 3869</span>&#160;        }</div>
<div class="line"><a name="l03870"></a><span class="lineno"> 3870</span>&#160;      }</div>
<div class="line"><a name="l03871"></a><span class="lineno"> 3871</span>&#160; </div>
<div class="line"><a name="l03872"></a><span class="lineno"> 3872</span>&#160;      <span class="comment">// Check the ncol of each block column.</span></div>
<div class="line"><a name="l03873"></a><span class="lineno"> 3873</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 0; block_col_i &lt; nblockcol; block_col_i++)</div>
<div class="line"><a name="l03874"></a><span class="lineno"> 3874</span>&#160;      {</div>
<div class="line"><a name="l03875"></a><span class="lineno"> 3875</span>&#160;        <span class="comment">// Get the ncol from the first block row to compare against.</span></div>
<div class="line"><a name="l03876"></a><span class="lineno"> 3876</span>&#160;        <span class="keyword">const</span> <span class="keywordtype">unsigned</span> first_block_ncol = matrix_pt(0, block_col_i)-&gt;ncol();</div>
<div class="line"><a name="l03877"></a><span class="lineno"> 3877</span>&#160; </div>
<div class="line"><a name="l03878"></a><span class="lineno"> 3878</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 1; block_row_i &lt; nblockrow; block_row_i++)</div>
<div class="line"><a name="l03879"></a><span class="lineno"> 3879</span>&#160;        {</div>
<div class="line"><a name="l03880"></a><span class="lineno"> 3880</span>&#160;          <span class="comment">// Get the ncol for the current block.</span></div>
<div class="line"><a name="l03881"></a><span class="lineno"> 3881</span>&#160;          <span class="keyword">const</span> <span class="keywordtype">unsigned</span> current_block_ncol =</div>
<div class="line"><a name="l03882"></a><span class="lineno"> 3882</span>&#160;            matrix_pt(block_row_i, block_col_i)-&gt;ncol();</div>
<div class="line"><a name="l03883"></a><span class="lineno"> 3883</span>&#160; </div>
<div class="line"><a name="l03884"></a><span class="lineno"> 3884</span>&#160;          <span class="keywordflow">if</span> (first_block_ncol != current_block_ncol)</div>
<div class="line"><a name="l03885"></a><span class="lineno"> 3885</span>&#160;          {</div>
<div class="line"><a name="l03886"></a><span class="lineno"> 3886</span>&#160;            std::ostringstream error_message;</div>
<div class="line"><a name="l03887"></a><span class="lineno"> 3887</span>&#160;            error_message &lt;&lt; <span class="stringliteral">&quot;First block has ncol = &quot;</span> &lt;&lt; current_block_ncol</div>
<div class="line"><a name="l03888"></a><span class="lineno"> 3888</span>&#160;                          &lt;&lt; <span class="stringliteral">&quot;. But martrix_pt(&quot;</span> &lt;&lt; block_row_i &lt;&lt; <span class="stringliteral">&quot;,&quot;</span></div>
<div class="line"><a name="l03889"></a><span class="lineno"> 3889</span>&#160;                          &lt;&lt; block_col_i</div>
<div class="line"><a name="l03890"></a><span class="lineno"> 3890</span>&#160;                          &lt;&lt; <span class="stringliteral">&quot;) has ncol = &quot;</span> &lt;&lt; current_block_ncol &lt;&lt; <span class="stringliteral">&quot;.\n&quot;</span>;</div>
<div class="line"><a name="l03891"></a><span class="lineno"> 3891</span>&#160;            <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l03892"></a><span class="lineno"> 3892</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l03893"></a><span class="lineno"> 3893</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l03894"></a><span class="lineno"> 3894</span>&#160;          }</div>
<div class="line"><a name="l03895"></a><span class="lineno"> 3895</span>&#160;        }</div>
<div class="line"><a name="l03896"></a><span class="lineno"> 3896</span>&#160;      }</div>
<div class="line"><a name="l03897"></a><span class="lineno"> 3897</span>&#160; </div>
<div class="line"><a name="l03898"></a><span class="lineno"> 3898</span>&#160;      <span class="comment">// Check that the distribution for each block row is the same.</span></div>
<div class="line"><a name="l03899"></a><span class="lineno"> 3899</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 0; block_row_i &lt; nblockrow; block_row_i++)</div>
<div class="line"><a name="l03900"></a><span class="lineno"> 3900</span>&#160;      {</div>
<div class="line"><a name="l03901"></a><span class="lineno"> 3901</span>&#160;        <span class="comment">// The first distribution of this block row.</span></div>
<div class="line"><a name="l03902"></a><span class="lineno"> 3902</span>&#160;        <span class="keyword">const</span> LinearAlgebraDistribution first_dist =</div>
<div class="line"><a name="l03903"></a><span class="lineno"> 3903</span>&#160;          *(matrix_pt(block_row_i, 0)-&gt;distribution_pt());</div>
<div class="line"><a name="l03904"></a><span class="lineno"> 3904</span>&#160; </div>
<div class="line"><a name="l03905"></a><span class="lineno"> 3905</span>&#160;        <span class="comment">// Loop through the rest of the block columns.</span></div>
<div class="line"><a name="l03906"></a><span class="lineno"> 3906</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 1; block_col_i &lt; nblockcol; block_col_i++)</div>
<div class="line"><a name="l03907"></a><span class="lineno"> 3907</span>&#160;        {</div>
<div class="line"><a name="l03908"></a><span class="lineno"> 3908</span>&#160;          <span class="comment">// Get the distribution from the current block.</span></div>
<div class="line"><a name="l03909"></a><span class="lineno"> 3909</span>&#160;          <span class="keyword">const</span> LinearAlgebraDistribution current_dist =</div>
<div class="line"><a name="l03910"></a><span class="lineno"> 3910</span>&#160;            matrix_pt(block_row_i, block_col_i)-&gt;distribution_pt();</div>
<div class="line"><a name="l03911"></a><span class="lineno"> 3911</span>&#160; </div>
<div class="line"><a name="l03912"></a><span class="lineno"> 3912</span>&#160;          <span class="comment">// Compare the first distribution against the current.</span></div>
<div class="line"><a name="l03913"></a><span class="lineno"> 3913</span>&#160;          <span class="keywordflow">if</span> (first_dist != current_dist)</div>
<div class="line"><a name="l03914"></a><span class="lineno"> 3914</span>&#160;          {</div>
<div class="line"><a name="l03915"></a><span class="lineno"> 3915</span>&#160;            std::ostringstream error_message;</div>
<div class="line"><a name="l03916"></a><span class="lineno"> 3916</span>&#160;            error_message &lt;&lt; <span class="stringliteral">&quot;First distribution of block row &quot;</span> &lt;&lt; block_row_i</div>
<div class="line"><a name="l03917"></a><span class="lineno"> 3917</span>&#160;                          &lt;&lt; <span class="stringliteral">&quot; is different from the distribution from &quot;</span></div>
<div class="line"><a name="l03918"></a><span class="lineno"> 3918</span>&#160;                          &lt;&lt; <span class="stringliteral">&quot;martrix_pt(&quot;</span> &lt;&lt; block_row_i &lt;&lt; <span class="stringliteral">&quot;,&quot;</span> &lt;&lt; block_col_i</div>
<div class="line"><a name="l03919"></a><span class="lineno"> 3919</span>&#160;                          &lt;&lt; <span class="stringliteral">&quot;).\n&quot;</span>;</div>
<div class="line"><a name="l03920"></a><span class="lineno"> 3920</span>&#160;            <span class="keywordflow">throw</span> OomphLibError(error_message.str(),</div>
<div class="line"><a name="l03921"></a><span class="lineno"> 3921</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>,</div>
<div class="line"><a name="l03922"></a><span class="lineno"> 3922</span>&#160;                                <a class="code" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>);</div>
<div class="line"><a name="l03923"></a><span class="lineno"> 3923</span>&#160;          }</div>
<div class="line"><a name="l03924"></a><span class="lineno"> 3924</span>&#160;        }</div>
<div class="line"><a name="l03925"></a><span class="lineno"> 3925</span>&#160;      }</div>
<div class="line"><a name="l03926"></a><span class="lineno"> 3926</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03927"></a><span class="lineno"> 3927</span>&#160; </div>
<div class="line"><a name="l03928"></a><span class="lineno"> 3928</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03929"></a><span class="lineno"> 3929</span>&#160; </div>
<div class="line"><a name="l03930"></a><span class="lineno"> 3930</span>&#160;      <span class="comment">// Loop thrpugh the block rows, then block columns to</span></div>
<div class="line"><a name="l03931"></a><span class="lineno"> 3931</span>&#160;      <span class="comment">// compute the local inf norm</span></div>
<div class="line"><a name="l03932"></a><span class="lineno"> 3932</span>&#160;      <span class="keywordtype">double</span> <a class="code" href="../../dd/d95/namespaceoomph_1_1CRDoubleMatrixHelpers.html#ab17222c9461096e3d5b8cf6250524644">inf_norm</a> = 0;</div>
<div class="line"><a name="l03933"></a><span class="lineno"> 3933</span>&#160;      <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_row_i = 0; block_row_i &lt; nblockrow; block_row_i++)</div>
<div class="line"><a name="l03934"></a><span class="lineno"> 3934</span>&#160;      {</div>
<div class="line"><a name="l03935"></a><span class="lineno"> 3935</span>&#160;        <span class="comment">// Get the number of local rows from the first block.</span></div>
<div class="line"><a name="l03936"></a><span class="lineno"> 3936</span>&#160;        <span class="keywordtype">unsigned</span> block_nrow_local = matrix_pt(block_row_i, 0)-&gt;nrow_local();</div>
<div class="line"><a name="l03937"></a><span class="lineno"> 3937</span>&#160; </div>
<div class="line"><a name="l03938"></a><span class="lineno"> 3938</span>&#160;        <span class="comment">// Loop through the block_nrow_local in this block row</span></div>
<div class="line"><a name="l03939"></a><span class="lineno"> 3939</span>&#160;        <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> local_row_i = 0; local_row_i &lt; block_nrow_local;</div>
<div class="line"><a name="l03940"></a><span class="lineno"> 3940</span>&#160;             local_row_i++)</div>
<div class="line"><a name="l03941"></a><span class="lineno"> 3941</span>&#160;        {</div>
<div class="line"><a name="l03942"></a><span class="lineno"> 3942</span>&#160;          <span class="keywordtype">double</span> abs_sum_of_row = 0;</div>
<div class="line"><a name="l03943"></a><span class="lineno"> 3943</span>&#160;          <span class="comment">// Loop through the block columns</span></div>
<div class="line"><a name="l03944"></a><span class="lineno"> 3944</span>&#160;          <span class="keywordflow">for</span> (<span class="keywordtype">unsigned</span> block_col_i = 0; block_col_i &lt; nblockcol; block_col_i++)</div>
<div class="line"><a name="l03945"></a><span class="lineno"> 3945</span>&#160;          {</div>
<div class="line"><a name="l03946"></a><span class="lineno"> 3946</span>&#160;            <span class="comment">// Locally cache the pointer to the current block.</span></div>
<div class="line"><a name="l03947"></a><span class="lineno"> 3947</span>&#160;            CRDoubleMatrix* block_pt = matrix_pt(block_row_i, block_col_i);</div>
<div class="line"><a name="l03948"></a><span class="lineno"> 3948</span>&#160; </div>
<div class="line"><a name="l03949"></a><span class="lineno"> 3949</span>&#160;            <span class="keyword">const</span> <span class="keywordtype">int</span>* row_start = block_pt-&gt;row_start();</div>
<div class="line"><a name="l03950"></a><span class="lineno"> 3950</span>&#160;            <span class="keyword">const</span> <span class="keywordtype">double</span>* <a class="code" href="../../d1/d62/namespaceEigen.html#a242ccf5e6e80154bbf36d63acf6e458a">value</a> = block_pt-&gt;value();</div>
<div class="line"><a name="l03951"></a><span class="lineno"> 3951</span>&#160; </div>
<div class="line"><a name="l03952"></a><span class="lineno"> 3952</span>&#160;            <span class="comment">// Loop through the values</span></div>
<div class="line"><a name="l03953"></a><span class="lineno"> 3953</span>&#160;            <span class="keywordflow">for</span> (<span class="keywordtype">int</span> val_i = row_start[local_row_i];</div>
<div class="line"><a name="l03954"></a><span class="lineno"> 3954</span>&#160;                 val_i &lt; row_start[local_row_i + 1];</div>
<div class="line"><a name="l03955"></a><span class="lineno"> 3955</span>&#160;                 val_i++)</div>
<div class="line"><a name="l03956"></a><span class="lineno"> 3956</span>&#160;            {</div>
<div class="line"><a name="l03957"></a><span class="lineno"> 3957</span>&#160;              abs_sum_of_row += <a class="code" href="../../d2/d0c/namespaceboost_1_1multiprecision.html#ab6f80ccf8e1d88df8a8e3acd039d63eb">fabs</a>(<a class="code" href="../../d1/d62/namespaceEigen.html#a242ccf5e6e80154bbf36d63acf6e458a">value</a>[val_i]);</div>
<div class="line"><a name="l03958"></a><span class="lineno"> 3958</span>&#160;            }</div>
<div class="line"><a name="l03959"></a><span class="lineno"> 3959</span>&#160;          }</div>
<div class="line"><a name="l03960"></a><span class="lineno"> 3960</span>&#160;          <span class="comment">// Store the max row</span></div>
<div class="line"><a name="l03961"></a><span class="lineno"> 3961</span>&#160;          <a class="code" href="../../dd/d95/namespaceoomph_1_1CRDoubleMatrixHelpers.html#ab17222c9461096e3d5b8cf6250524644">inf_norm</a> = <a class="code" href="../../dc/d51/datatypes_8h.html#affe776513b24d84b39af8ab0930fef7f">std::max</a>(<a class="code" href="../../dd/d95/namespaceoomph_1_1CRDoubleMatrixHelpers.html#ab17222c9461096e3d5b8cf6250524644">inf_norm</a>, abs_sum_of_row);</div>
<div class="line"><a name="l03962"></a><span class="lineno"> 3962</span>&#160;        }</div>
<div class="line"><a name="l03963"></a><span class="lineno"> 3963</span>&#160;      }</div>
<div class="line"><a name="l03964"></a><span class="lineno"> 3964</span>&#160; </div>
<div class="line"><a name="l03965"></a><span class="lineno"> 3965</span>&#160;      <span class="comment">// if this vector is distributed and on multiple processors then gather</span></div>
<div class="line"><a name="l03966"></a><span class="lineno"> 3966</span>&#160;<span class="preprocessor">#ifdef OOMPH_HAS_MPI</span></div>
<div class="line"><a name="l03967"></a><span class="lineno"> 3967</span>&#160;      <span class="keywordtype">double</span> inf_norm_local = <a class="code" href="../../dd/d95/namespaceoomph_1_1CRDoubleMatrixHelpers.html#ab17222c9461096e3d5b8cf6250524644">inf_norm</a>;</div>
<div class="line"><a name="l03968"></a><span class="lineno"> 3968</span>&#160;      <span class="keywordflow">if</span> (matrix_pt(0, 0)-&gt;distributed() &amp;&amp; comm_pt-&gt;nproc() &gt; 1)</div>
<div class="line"><a name="l03969"></a><span class="lineno"> 3969</span>&#160;      {</div>
<div class="line"><a name="l03970"></a><span class="lineno"> 3970</span>&#160;        MPI_Allreduce(&amp;<a class="code" href="../../dd/d95/namespaceoomph_1_1CRDoubleMatrixHelpers.html#ab17222c9461096e3d5b8cf6250524644">inf_norm</a>,</div>
<div class="line"><a name="l03971"></a><span class="lineno"> 3971</span>&#160;                      &amp;inf_norm_local,</div>
<div class="line"><a name="l03972"></a><span class="lineno"> 3972</span>&#160;                      1,</div>
<div class="line"><a name="l03973"></a><span class="lineno"> 3973</span>&#160;                      MPI_DOUBLE,</div>
<div class="line"><a name="l03974"></a><span class="lineno"> 3974</span>&#160;                      MPI_MAX,</div>
<div class="line"><a name="l03975"></a><span class="lineno"> 3975</span>&#160;                      comm_pt-&gt;mpi_comm());</div>
<div class="line"><a name="l03976"></a><span class="lineno"> 3976</span>&#160;      }</div>
<div class="line"><a name="l03977"></a><span class="lineno"> 3977</span>&#160;      <a class="code" href="../../dd/d95/namespaceoomph_1_1CRDoubleMatrixHelpers.html#ab17222c9461096e3d5b8cf6250524644">inf_norm</a> = inf_norm_local;</div>
<div class="line"><a name="l03978"></a><span class="lineno"> 3978</span>&#160;<span class="preprocessor">#endif</span></div>
<div class="line"><a name="l03979"></a><span class="lineno"> 3979</span>&#160; </div>
<div class="line"><a name="l03980"></a><span class="lineno"> 3980</span>&#160;      <span class="comment">// and return</span></div>
<div class="line"><a name="l03981"></a><span class="lineno"> 3981</span>&#160;      <span class="keywordflow">return</span> <a class="code" href="../../dd/d95/namespaceoomph_1_1CRDoubleMatrixHelpers.html#ab17222c9461096e3d5b8cf6250524644">inf_norm</a>;</div>
<div class="line"><a name="l03982"></a><span class="lineno"> 3982</span>&#160;    }</div>
<div class="ttc" id="anamespaceoomph_1_1CRDoubleMatrixHelpers_html_ab17222c9461096e3d5b8cf6250524644"><div class="ttname"><a href="../../dd/d95/namespaceoomph_1_1CRDoubleMatrixHelpers.html#ab17222c9461096e3d5b8cf6250524644">oomph::CRDoubleMatrixHelpers::inf_norm</a></div><div class="ttdeci">double inf_norm(const DenseMatrix&lt; CRDoubleMatrix * &gt; &amp;matrix_pt)</div><div class="ttdoc">Compute infinity (maximum) norm of sub blocks as if it was one matrix.</div><div class="ttdef"><b>Definition:</b> matrices.cc:3731</div></div>
</div><!-- fragment -->
<p class="reference">References <a class="el" href="../../d2/d0c/namespaceboost_1_1multiprecision.html#ab6f80ccf8e1d88df8a8e3acd039d63eb">boost::multiprecision::fabs()</a>, <a class="el" href="../../dc/d51/datatypes_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a>, <a class="el" href="../../d6/d13/classoomph_1_1DenseMatrix.html#a9937181f1cb4cfaed7aaf3b483c42456">oomph::DenseMatrix&lt; T &gt;::ncol()</a>, <a class="el" href="../../de/d83/classoomph_1_1OomphCommunicator.html#a6c78c72666f4b102c2bccf200f0853b7">oomph::OomphCommunicator::nproc()</a>, <a class="el" href="../../d6/d13/classoomph_1_1DenseMatrix.html#a1b425094510d833ffe91920747a0a962">oomph::DenseMatrix&lt; T &gt;::nrow()</a>, <a class="el" href="../../dd/d6f/oomph__definitions_8h.html#aa260cc4af589e30cea7fde997ae16667">OOMPH_CURRENT_FUNCTION</a>, <a class="el" href="../../dd/d6f/oomph__definitions_8h.html#a25c6813cc7341d125e2502f8923fb6c4">OOMPH_EXCEPTION_LOCATION</a>, <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html#a25f1efd00318183abd8c65efede3f3f4">oomph::CRDoubleMatrix::row_start()</a>, <a class="el" href="../../d1/d62/namespaceEigen.html#a242ccf5e6e80154bbf36d63acf6e458a">Eigen::value</a>, and <a class="el" href="../../d6/dd4/classoomph_1_1CRDoubleMatrix.html#ab8220b7c2bb763dab32a4d0fea7da6f4">oomph::CRDoubleMatrix::value()</a>.</p>

<p class="reference">Referenced by <a class="el" href="../../dc/d64/classoomph_1_1PseudoElasticPreconditioner.html#a69909eef3e1530ca7faf48c653ec7327">oomph::PseudoElasticPreconditioner::setup()</a>, and <a class="el" href="../../d8/d77/classoomph_1_1LagrangeEnforcedFlowPreconditioner.html#aadcbdb5af92d7889c956098cb86dee87">oomph::LagrangeEnforcedFlowPreconditioner::setup()</a>.</p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../da/ddf/namespaceoomph.html">oomph</a></li><li class="navelem"><a class="el" href="../../dd/d95/namespaceoomph_1_1CRDoubleMatrixHelpers.html">CRDoubleMatrixHelpers</a></li>
    <li class="footer">Generated on Wed Aug 27 2025 17:09:39 for MercuryDPM by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
