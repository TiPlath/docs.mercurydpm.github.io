<!-- HTML header for doxygen 1.8.18-->
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.9.1"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>MercuryDPM: Parallel processing using OpenMP</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    extensions: ["tex2jax.js"],
    jax: ["input/TeX","output/HTML-CSS"],
});
</script>
<script type="text/javascript" async="async" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
<link href="../../MDPM.css" rel="stylesheet" type="text/css"/>
<link href="../../codeLabels.css" rel="stylesheet" type="text/css"/>
<link href="../../MDPM-fork-corner.css" rel="stylesheet" type="text/css"/>
<link href="../../MDPM-dropdown-version.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../MDPM-fragment-copy-button.js"></script>
<script type="text/javascript">
DoxygenAwesomeFragmentCopyButton.init()
</script>
<script type="text/javascript" src="../../MDPM-paragraph-link.js"></script>
<script type="text/javascript">
DoxygenAwesomeParagraphLink.init()
</script>
<script type="text/javascript" src="../../MDPM-interactive-toc.js"></script>
<script type="text/javascript">
DoxygenAwesomeInteractiveToc.init()
</script>
<script type="text/javascript" src="../../MDPM-darkmode-toggle.js"></script>
<script type="text/javascript">
DoxygenAwesomeDarkModeToggle.init()
</script>
</head>
<body>
  <div id="bitbucket-corner">
   <a href="https://bitbucket.org/mercurydpm/mercurydpm/src/master/" target="_blank" id="fork-corner" class="fork-corner fc-pos-tr fc-animate fc-theme-bitbucket"></a>
  </div>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../mercury-logo-chosen-light-slogan.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname"> <!--MercuryDPM--!>
   <!-- BEGIN version select -->
   <div class="dropdown" id="projectnumber">
    <button class="dropbtn">v1.0</button>
    <div class="dropdown-content">
    </div>
   </div>
   <script type="text/javascript" src="../../MDPM-dropdown-version.js"></script>
<!-- END version select -->
   <!--&#160;<span id="projectnumber">revision: v1.0</span>-->
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<script type="text/javascript" src="../../MDPM-fork-corner.js"></script>
<!-- Generated by Doxygen 1.9.1 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
var searchBox = new SearchBox("searchBox", "../../search",false,'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:cf05388f2679ee054f2beb29a391d25f4e673ac3&amp;dn=gpl-2.0.txt GPL-v2 */
$(document).ready(function(){initNavTree('de/d40/openmpDemo.html','../../'); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="PageDoc"><div class="header">
  <div class="headertitle">
<div class="title">Parallel processing using OpenMP </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h3><a class="anchor" id="autotoc_md189"></a>
Speeding up simulations by parallel execution on Symmetric Multiprocessors (SMPs)</h3>
<p>On both symmetric multiprocessors (SMPs) and massively parallel processors (MPPs), MercuryDPM can run simulations in parallel. The distinction between the computer architectures is that SMPs (single-processor machines) use shared memory, while MPPs (clusters) use distributed memory. We parallelise on shared memory with an OpenMP implementation and parallelize on distributed memory with an MPI implementation. The following tutorials will demonstrate how to use OpenMP parallelisation in your code.</p>
<p>To use the MercuryDPM-OpenMP framework, you need to include some code fragments in the main function, and some extra options during compiling and linking.</p>
<p>To illustrate this, let us consider a "Demo" application that we want to run in parallel using an activated OpenMP environment. The driver code is structured as follows:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="../../d8/d02/Mercury3D_8h.html">Mercury3D.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keyword">class </span>Demo : <span class="keyword">public</span> <a class="code" href="../../d3/db1/classMercury3D.html">Mercury3D</a> {</div>
<div class="line">  <span class="keywordtype">void</span> <a class="code" href="../../d5/d89/classDPMBase.html#a1e4a1079bebb932de0ea70b487eedc5e">setupInitialConditions</a>()<span class="keyword"> override </span>{</div>
<div class="line">    <span class="comment">//define walls, boundary conditions, particle positions here</span></div>
<div class="line">  }</div>
<div class="line">};</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> <a class="code" href="../../d9/d18/T__protectiveWall_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv) {</div>
<div class="line">  Demo <a class="code" href="../../d0/d5b/steady__axisym__advection__diffusion_8cc.html#a569d6908c13cebe207584b3d146c851e">problem</a>;</div>
<div class="line">  <span class="comment">//define contact law, time step, final time, domain size here</span></div>
<div class="line">  <a class="code" href="../../d0/d5b/steady__axisym__advection__diffusion_8cc.html#a569d6908c13cebe207584b3d146c851e">problem</a>.solve(argc, argv);</div>
<div class="line">}</div>
<div class="ttc" id="aMercury3D_8h_html"><div class="ttname"><a href="../../d8/d02/Mercury3D_8h.html">Mercury3D.h</a></div></div>
<div class="ttc" id="aT__protectiveWall_8cpp_html_a0ddf1224851353fc92bfbff6f499fa97"><div class="ttname"><a href="../../d9/d18/T__protectiveWall_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a></div><div class="ttdeci">int main(int argc, char *argv[])</div><div class="ttdef"><b>Definition:</b> T_protectiveWall.cpp:194</div></div>
<div class="ttc" id="aclassDPMBase_html_a1e4a1079bebb932de0ea70b487eedc5e"><div class="ttname"><a href="../../d5/d89/classDPMBase.html#a1e4a1079bebb932de0ea70b487eedc5e">DPMBase::setupInitialConditions</a></div><div class="ttdeci">virtual void setupInitialConditions()</div><div class="ttdoc">This function allows to set the initial conditions for our problem to be solved, by default particle ...</div><div class="ttdef"><b>Definition:</b> DPMBase.cc:1987</div></div>
<div class="ttc" id="aclassMercury3D_html"><div class="ttname"><a href="../../d3/db1/classMercury3D.html">Mercury3D</a></div><div class="ttdoc">This adds on the hierarchical grid code for 3D problems.</div><div class="ttdef"><b>Definition:</b> Mercury3D.h:16</div></div>
<div class="ttc" id="asteady__axisym__advection__diffusion_8cc_html_a569d6908c13cebe207584b3d146c851e"><div class="ttname"><a href="../../d0/d5b/steady__axisym__advection__diffusion_8cc.html#a569d6908c13cebe207584b3d146c851e">problem</a></div><div class="ttdeci">Constructor for SteadyAxisymAdvectionDiffusion problem</div><div class="ttdef"><b>Definition:</b> steady_axisym_advection_diffusion.cc:213</div></div>
</div><!-- fragment --><p>Firstly, the OpenMP parallel environment has to be activated using <code>cmake</code>, i.e., by turning the flag <code>MercuryDPM_USE_OpenMP</code> to <code>ON</code> as follows: </p><div class="fragment"><div class="line"><span class="preprocessor"># enter your build directory</span></div>
<div class="line">cd MercuryBuild</div>
<div class="line"><span class="preprocessor"># use cmake to change the CMake configuration</span></div>
<div class="line">cmake . -DMERCURYDPM_USE_OpenMP=ON</div>
<div class="line"><span class="preprocessor"># Run fullTest with OpenMP activated</span></div>
<div class="line"><span class="preprocessor">make fullTest</span></div>
</div><!-- fragment --><p> Alternatively, you can use ccmake or cmake-gui to change the CMake configuration. Instructions for ccmake: </p><div class="fragment"><div class="line"><span class="preprocessor"># use ccmake or cmake-gui to change the CMake configuration</span></div>
<div class="line">ccmake ../MercurySource</div>
<div class="line"><span class="preprocessor"># Press [c] to configure</span></div>
<div class="line"><span class="preprocessor"># Set MercuryDPM_USE_OpenMP --&gt; ON</span></div>
<div class="line"><span class="preprocessor"># Press [c] twice to configure 2 times, then press [g] to generate</span></div>
</div><!-- fragment --><p>Next, we set the number of threads to run in parallel for the program by calling the <code>setNumberOfOMPThreads(n)</code> function in the main function of the application, where <code>n</code> denotes the number of threads.</p>
<div class="fragment"><div class="line">...</div>
<div class="line"> </div>
<div class="line">int <a class="code" href="../../d9/d18/T__protectiveWall_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv) {</div>
<div class="line">  Demo <a class="code" href="../../d0/d5b/steady__axisym__advection__diffusion_8cc.html#a569d6908c13cebe207584b3d146c851e">problem</a>;</div>
<div class="line">  ...</div>
<div class="line">  <span class="comment">//Set the number of threads (cores) for the identity-based OpenMP framework   </span></div>
<div class="line">  <a class="code" href="../../d0/d5b/steady__axisym__advection__diffusion_8cc.html#a569d6908c13cebe207584b3d146c851e">problem</a>.setNumberOfOMPThreads(4);</div>
<div class="line">  <a class="code" href="../../d0/d5b/steady__axisym__advection__diffusion_8cc.html#a569d6908c13cebe207584b3d146c851e">problem</a>.solve(argc, argv);</div>
<div class="line">}</div>
</div><!-- fragment --><p>After adding the above modifications, the simulation will be executed in parallel, with only one additional line included to the main() function.</p>
<p>Alternatively, you can set the number of OMP threads using a command-line argument that is passed through helpers::readFromCommandLine(...) function: </p><div class="fragment"><div class="line">...</div>
<div class="line"> </div>
<div class="line">int <a class="code" href="../../d9/d18/T__protectiveWall_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv) {</div>
<div class="line">  Demo <a class="code" href="../../d0/d5b/steady__axisym__advection__diffusion_8cc.html#a569d6908c13cebe207584b3d146c851e">problem</a>;</div>
<div class="line">  ...</div>
<div class="line">  <span class="comment">// command line arguments:</span></div>
<div class="line">  <a class="code" href="../../d0/d5b/steady__axisym__advection__diffusion_8cc.html#a569d6908c13cebe207584b3d146c851e">problem</a>.setNumberOfOMPThreads(<a class="code" href="../../d9/d41/namespacehelpers.html#a8dd779701eaedeb9ce8d3a41afdda534">helpers::readFromCommandLine</a>(argc, argv, <span class="stringliteral">&quot;-omp&quot;</span>,1));</div>
<div class="line">  <a class="code" href="../../d9/d41/namespacehelpers.html#a116ee5be603a485415f08bffa38c4152">helpers::removeFromCommandline</a>(argc, argv, <span class="stringliteral">&quot;-omp&quot;</span>, 1);</div>
<div class="line">  <a class="code" href="../../d0/d5b/steady__axisym__advection__diffusion_8cc.html#a569d6908c13cebe207584b3d146c851e">problem</a>.solve(argc, argv);</div>
<div class="line">}</div>
<div class="ttc" id="anamespacehelpers_html_a116ee5be603a485415f08bffa38c4152"><div class="ttname"><a href="../../d9/d41/namespacehelpers.html#a116ee5be603a485415f08bffa38c4152">helpers::removeFromCommandline</a></div><div class="ttdeci">bool removeFromCommandline(int &amp;argc, char *argv[], const std::string &amp;varName, int nArgs)</div><div class="ttdoc">May be used to hide arguments from argc and argv.</div><div class="ttdef"><b>Definition:</b> CommandLineHelpers.cc:41</div></div>
<div class="ttc" id="anamespacehelpers_html_a8dd779701eaedeb9ce8d3a41afdda534"><div class="ttname"><a href="../../d9/d41/namespacehelpers.html#a8dd779701eaedeb9ce8d3a41afdda534">helpers::readFromCommandLine</a></div><div class="ttdeci">bool readFromCommandLine(int argc, char *argv[], const std::string &amp;varName)</div><div class="ttdoc">Returns true if command line arguments contain varName, false else.</div><div class="ttdef"><b>Definition:</b> CommandLineHelpers.cc:99</div></div>
</div><!-- fragment --><p>In that case, the number of threads is set at execution-time via the command line, as follows:</p>
<div class="fragment"><div class="line">time ./Demo -<a class="code" href="../../df/d04/namespacetest.html">test</a> -omp 4  </div>
<div class="ttc" id="anamespacetest_html"><div class="ttname"><a href="../../df/d04/namespacetest.html">test</a></div><div class="ttdef"><b>Definition:</b> indexed_view.cpp:20</div></div>
</div><!-- fragment --><p>Or you can use helpers::getMaximumNumberOfOMPThreads() the get the number of available OpenMP threads: </p><div class="fragment"><div class="line">...</div>
<div class="line"> </div>
<div class="line">int <a class="code" href="../../d9/d18/T__protectiveWall_8cpp.html#a0ddf1224851353fc92bfbff6f499fa97">main</a>(<span class="keywordtype">int</span> argc, <span class="keywordtype">char</span>** argv) {</div>
<div class="line">  Demo <a class="code" href="../../d0/d5b/steady__axisym__advection__diffusion_8cc.html#a569d6908c13cebe207584b3d146c851e">problem</a>;</div>
<div class="line">  ...</div>
<div class="line">  <a class="code" href="../../d0/d5b/steady__axisym__advection__diffusion_8cc.html#a569d6908c13cebe207584b3d146c851e">problem</a>.setNumberOfOMPThreads(<a class="code" href="../../d9/d41/namespacehelpers.html#a805a270481cd51d8d6d7ed22ec3956be">helpers::getMaximumNumberOfOMPThreads</a>());</div>
<div class="line">  <a class="code" href="../../d0/d5b/steady__axisym__advection__diffusion_8cc.html#a569d6908c13cebe207584b3d146c851e">problem</a>.solve(argc, argv);</div>
<div class="line">}</div>
<div class="ttc" id="anamespacehelpers_html_a805a270481cd51d8d6d7ed22ec3956be"><div class="ttname"><a href="../../d9/d41/namespacehelpers.html#a805a270481cd51d8d6d7ed22ec3956be">helpers::getMaximumNumberOfOMPThreads</a></div><div class="ttdeci">int getMaximumNumberOfOMPThreads()</div><div class="ttdoc">Gets the maximum number of OpenMP threads.</div><div class="ttdef"><b>Definition:</b> OpenMPHelpers.cc:16</div></div>
</div><!-- fragment --><p>In this case, the number of threads is set at execution-time automatically:</p>
<div class="fragment"><div class="line">time ./Demo -<a class="code" href="../../df/d04/namespacetest.html">test</a>  </div>
</div><!-- fragment --><p>For an example of an OpenMP-ready code, see /Drivers/MercurySimpleDemos/FreeCooling2DinWallsDemo.cpp. </p><div class="image">
<img src="../../Tutorial10FCM2DWalls.png" alt="" width="1600px"/>
</div>
<h4><a class="anchor" id="autotoc_md190"></a>
Performance</h4>
<p>The table below shows performance results of the MercuryDPM-OpenMP framework: </p><div class="image">
<img src="../../Tutorial10FCM2DWallsOMPRuntime.png" alt="" width="600px"/>
<div class="caption">
Runtime and scalability of the MercuryDPM-OpenMP framework on a quad-core processor with up to 8 CPUs when hyperthreading</div></div>
<p>The performance was tested using 200,000-particle simulation of a cooling granular gas on a quad core processor, with a time step 5 x 10-5 and a save count = 100, simulated up to a maximum time = 0.1. The fully functional parallel program produced exactly the same (identical) output as the serial application. We see that the execution time decreases with the number of threads. The theoretical maximum speedup is based on Ahmdahl's law for 4 cores, assuming that 68% of the code can be parallelised.</p>
<p>On the following pages, you'll find more parallelisation demonstrations:<br  />
<a class="el" href="../../d0/db4/mpiDemo.html">Parallel processing using MPI</a> <br  />
<a class="el" href="../../db/d3c/parallelInputOutputDemo.html">Parallel processing for Input-Output, I/O files</a> <br  />
 Alternatively, go back to <a class="el" href="../../d7/db9/AdvancedTutorials.html#AdvancedOverview">Overview of advanced tutorials</a> </p>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../index.html">MercuryDPM Reference Manual</a></li><li class="navelem"><a class="el" href="../../d5/dac/Tutorials.html">Fun with MercuryDPM (Tutorials)</a></li><li class="navelem"><a class="el" href="../../d0/db0/BeginnerTutorials.html">Beginner tutorials</a></li><li class="navelem"><a class="el" href="../../d7/db9/AdvancedTutorials.html">Advanced tutorials</a></li>
    <li class="footer">Generated on Wed Aug 27 2025 17:05:13 for MercuryDPM by <a href="https://www.doxygen.org/index.html"><img class="footer" src="../../doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.1 </li>
  </ul>
</div>
</body>
</html>
